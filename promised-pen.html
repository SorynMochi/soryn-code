
<head>
<title>The Promised Pen</title>
<meta name="title" content="The Promised Pen">
<meta name="description" content="The Promised Pen is a free novel-writing app for authors, including a wide array of world-building options, AI assistance, and a timeline creator.">
<meta name="keywords" content="promised pen, novel app, novel writing, story generator, AI story writer, authoring suite, book writing app, world-building, timeline app, novel creator">
<meta name="robots" content="index, follow">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="language" content="English">
<meta name="author" content="SorynMochi">
  <link href="https://fonts.googleapis.com/css2?family=Roboto&family=Open+Sans&family=Lato&family=Montserrat&family=Oswald&family=Source+Sans+Pro&family=Raleway&family=PT+Sans&family=Nunito&family=Merriweather&family=Poppins&family=Playfair+Display&family=Roboto+Condensed&family=Ubuntu&family=Roboto+Slab&family=Noto+Sans&family=Quicksand&family=Crimson+Text&family=Work+Sans&family=Inter&family=Caveat&family=Dancing+Script&family=Pacifico&family=Shadows+Into+Light&family=Indie+Flower&family=Satisfy&family=Lobster&family=Architects+Daughter&family=Comic+Neue&family=Permanent+Marker&family=Abril+Fatface&family=Russo+One&family=Exo+2&family=Poiret+One&family=Kaushan+Script&family=Righteous&family=Yanone+Kaffeesatz&family=Amatic+SC&family=Josefin+Sans&family=Bebas+Neue&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Abel&family=Archivo&family=Barlow&family=Comfortaa&family=Didact+Gothic&family=Encode+Sans&family=Fira+Sans&family=Heebo&family=IBM+Plex+Sans&family=Karla&family=Lexend&family=Manrope&family=Mulish&family=Nunito+Sans&family=Overpass&family=Public+Sans&family=Rubik&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Arvo&family=Bitter&family=Cormorant&family=DM+Serif+Display&family=EB+Garamond&family=Faustina&family=Gelasio&family=IBM+Plex+Serif&family=Josefin+Slab&family=Libre+Baskerville&family=Lora&family=Noto+Serif&family=Playfair+Display+SC&family=PT+Serif&family=Quattrocento&family=Spectral&family=Source+Serif+Pro&family=Vollkorn&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Bungee&family=Cinzel&family=Fredoka+One&family=Graduate&family=Koulen&family=Lobster+Two&family=Monoton&family=Orbitron&family=Passion+One&family=Rowdies&family=Sacramento&family=Special+Elite&family=Ultra&family=Viga&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Calligraffitti&family=Covered+By+Your+Grace&family=Gloria+Hallelujah&family=Just+Me+Again+Down+Here&family=Kalam&family=Loved+by+the+King&family=Mali&family=Nothing+You+Could+Do&family=Petit+Formal+Script&family=Reenie+Beanie&family=Rock+Salt&family=Schoolbell&family=Sue+Ellen+Francisco&family=The+Girl+Next+Door&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Anonymous+Pro&family=Cousine&family=Cutive+Mono&family=Fira+Mono&family=IBM+Plex+Mono&family=Inconsolata&family=Major+Mono+Display&family=Oxygen+Mono&family=PT+Mono&family=Roboto+Mono&family=Space+Mono&family=Ubuntu+Mono&family=VT323&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Assistant&family=Cabin&family=Outfit&family=Hind&family=Figtree&family=DM+Sans&family=Titillium+Web&family=Gudea&family=Kanit&family=Sora&family=Catamaran&family=Signika+Negative&family=Athiti&family=Jost&family=Noto+Sans+Display&family=Asap&family=Atkinson+Hyperlegible&family=Thasadith&family=Urbanist&family=Exo&family=League+Spartan&family=Epilogue&family=Plus+Jakarta+Sans&family=Albert+Sans&family=Red+Hat+Display&family=Red+Hat+Text&family=Be+Vietnam+Pro&family=Fira+Sans+Condensed&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro&family=Sorts+Mill+Goudy&family=Alegreya&family=Cormorant+Garamond&family=Libre+Caslon+Text&family=Libre+Caslon+Display&family=Baskervville&family=Cardo&family=Newsreader&family=Fraunces&family=Eczar&family=Gentium+Book+Basic&family=Poly&family=Tinos&family=Alice&family=Literata&family=Gilda+Display&family=Alike&family=Lustria&family=Inria+Serif&family=Bodoni+Moda&family=Rosarivo&family=Cormorant+Infant&family=Adamina&family=Antic+Didone&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Alfa+Slab+One&family=Staatliches&family=Changa+One&family=Shrikhand&family=Diplomata&family=Black+Ops+One&family=Baloo+2&family=Rubik+Mono+One&family=Bungee+Shade&family=Creepster&family=Faster+One&family=Bungee+Inline&family=Rye&family=Girassol&family=Piedra&family=Fugaz+One&family=Holtwood+One+SC&family=Oleo+Script+Swash+Caps&family=Vast+Shadow&family=Sancreek&family=Codystar&family=Sarina&family=Megrim&family=Ruslan+Display&family=Emilys+Candy&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Cedarville+Cursive&family=Sedgwick+Ave&family=Ms+Madi&family=Patrick+Hand&family=Gochi+Hand&family=Marck+Script&family=Rancho&family=Arizonia&family=Just+Another+Hand&family=Walter+Turncoat&family=Annie+Use+Your+Telescope&family=Dawning+of+a+New+Day&family=La+Belle+Aurore&family=Over+the+Rainbow&family=Swanky+and+Moo+Moo&family=Bilbo&family=Mr+De+Haviland&family=Kristi&family=East+Sea+Dokdo&family=Qwigley&family=Herr+Von+Muellerhoff&family=Homemade+Apple&family=Seaweed+Script&family=Mr+Dafoe&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Nova+Mono&family=Azeret+Mono&family=B612+Mono&family=JetBrains+Mono&family=Syne+Mono&family=Overpass+Mono&family=Red+Hat+Mono&family=DM+Mono&family=Spline+Sans+Mono&family=Recursive&family=Nanum+Gothic+Coding&family=Courier+Prime&family=Noto+Sans+Mono&family=Xanh+Mono&family=Chivo+Mono&family=Sometype+Mono&family=Fira+Code&family=Space+Grotesk&family=Fragment+Mono&family=Victor+Mono&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Rajdhani:wght@300;400;500;600;700&family=Audiowide&family=Syncopate:wght@400;700&family=Teko:wght@300;400;500;600;700&family=Creepster&family=Nosifer&family=Eater&family=Butcherman&family=Opacity+Zero&family=Rubik+Glitch&family=Rubik+Microbe&family=Rubik+Wet+Paint&family=Tourney:wght@100..900&family=Silkscreen&family=Oxanium:wght@200..800&family=Michroma&family=Chakra+Petch:wght@300;400;500;600;700&family=Sarpanch:wght@400;500;600;700;800;900&family=Wallpoet&family=Faster+One&family=Press+Start+2P&family=Bai+Jamjuree:wght@200;300;400;500;600;700&family=Synth+Midnight+Pro&family=Megrim&family=Monofett&family=Londrina+Outline&family=Londrina+Shadow&family=Londrina+Sketch&family=Londrina+Solid&family=ZCOOL+QingKe+HuangYou&family=Warnes&family=Neonderthaw&family=Monoton&family=Vampiro+One&family=Frijole&family=Jolly+Lodger&family=Metal+Mania&family=Ewert&family=Nosifer&family=Eater&family=Creepster&family=Lacquer&family=Sancreek&family=Train+One&family=Bungee+Hairline&family=Bungee+Inline&family=Bungee+Outline&family=Bungee+Shade&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700;800;900&family=Cinzel+Decorative:wght@400;700;900&family=MedievalSharp&family=Almendra:wght@400;700&family=Metamorphous&family=Uncial+Antiqua&family=Fondamento&family=Astloch:wght@400;700&family=Grenze+Gotisch:wght@100;200;300;400;500;600;700;800;900&family=Quintessential&family=Pirata+One&family=Caesar+Dressing&family=Berkshire+Swash&family=Jim+Nightshade&family=Eagle+Lake&family=Almendra+Display&family=Aguafina+Script&family=Nova+Script&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Abril+Fatface&family=Bodoni+Moda:opsz,wght@6..96,400..900&family=Cormorant+Garamond:wght@300;400;500;600;700&family=IM+Fell+English&family=IM+Fell+English+SC&family=IM+Fell+Double+Pica&family=IM+Fell+Double+Pica+SC&family=IM+Fell+DW+Pica&family=IM+Fell+DW+Pica+SC&family=IM+Fell+French+Canon&family=IM+Fell+French+Canon+SC&family=IM+Fell+Great+Primer&family=IM+Fell+Great+Primer+SC&family=Libre+Bodoni:wght@400..700&family=Libre+Caslon+Text&family=Old+Standard+TT&family=Vidaloka&family=Poiret+One&family=Philosophers&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Bahiana&family=Berkshire+Swash&family=Cagliostro&family=Carrois+Gothic+SC&family=Charmonman&family=Diplomata+SC&family=Dr+Sugiyama&family=Federant&family=Jacques+Francois+Shadow&family=Londrina+Shadow&family=Miss+Fajardose&family=Modern+Antiqua&family=Rye&family=Ruthie&family=Stalemate&family=Underdog&family=UnifrakturCook&family=UnifrakturMaguntia&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Bubblegum+Sans&family=Baloo+Bhai+2&family=Finger+Paint&family=Bangers:wght@900&family=Marhey&family=Rock+3D&family=Henny+Penny&family=Coiny&family=Flavors&family=Ribeye+Marrow&family=Ranga&family=Handlee&family=Sonsie+One&family=Rancho&display=swap" rel="stylesheet">
</head>
  <div id="novelApp">
  <style>
    body {
      background-color: var(--background);
      color: var(--text);
      transition: background-color 0.3s, color 0.3s;
    }
    
    /* Apply theme to form elements */
    input, select, textarea, button {
      background-color: var(--input-bg);
      color: var(--text);
      border: 1px solid var(--input-border);
      transition: background-color 0.3s, color 0.3s, border-color 0.3s;
      font-size: 12px;
    }
    
    input:focus, select:focus, textarea:focus {
      outline-color: var(--primary);
      border-color: var(--primary);
    }
    
    button {
      cursor: pointer;
    }
    
    /* Style buttons by type */
    .btn-primary {
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 4px;
    }
    
    .btn-primary:hover {
      background-color: var(--primary-hover);
    }
    
    .btn-secondary {
      background-color: var(--secondary);
      color: white;
      border: none;
      border-radius: 4px;
    }
    
    .btn-secondary:hover {
      background-color: var(--secondary-hover);
    }
    
    .btn-danger {
      background-color: var(--danger);
      color: white;
      border: none;
      border-radius: 4px;
    }
    
    .btn-danger:hover {
      background-color: var(--danger-hover);
    }
    
    /* Chapter and character items */
    .chapter-item, .character-item, .lore-item {
      background: var(--chapter-item-bg);
      border: 1px solid var(--border);
      color: var(--text);
      transition: background-color 0.3s;
      position: relative;
      overflow: hidden;
    }
    
    .chapter-item.active, .character-item.active, .lore-item.active {
      background: var(--active-item);
      font-weight: bold;
    }
    
    .chapter-item:hover, .character-item:hover, .lore-item:hover {
      background: var(--hover-bg);
    }

    /* Editor specific styles */
    #editor {
      background: var(--editor-bg);
      color: var(--text);
      border-color: var(--border);
      position: relative;
      overflow: hidden;
    }
    
    #editor blockquote {
      border-left: 3px solid var(--border);
      color: var(--text-light);
    }
    
    #editor pre {
      background-color: var(--code-bg);
      border-color: var(--border);
    }
    
    #editor table td, #editor table th {
      border-color: var(--border);
    }
    
    /* Special character button styles */
    .special-char-btn {
      background: var(--special-char-btn);
      border-color: var(--border);
      color: var(--text);
      font-size: 12px;
    }
    
    .special-char-btn:hover {
      background: var(--hover-bg);
    }
    
    /* Theme toggle button */
    .theme-toggle {
      background: none;
      border: none;
      color: var(--text);
      cursor: pointer;
      padding: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      border-radius: 4px;
      width: 36px;
      height: 36px;
    }
    
    .theme-toggle:hover {
      background: var(--hover-bg);
    }
    
    /* Links */
    a {
      color: var(--link-color);
      transition: color 0.3s;
    }
    
    /* Menu dropdown links */
    #menuDropdown a {
      color: var(--text);
      border-color: var(--border);
      transition: background-color 0.3s;
    }
    
    #menuDropdown a:hover {
      background-color: var(--hover-bg);
    }
    
    /* Cyberpunk Theme Effects */
    [data-theme="cyberpunk"] h1, 
    [data-theme="cyberpunk"] h2,
    [data-theme="cyberpunk"] h3,
    [data-theme="cyberpunk"] h4,
    [data-theme="cyberpunk"] .book-title,
    [data-theme="cyberpunk"] button {
      text-shadow: 0 0 5px var(--text), 0 0 10px var(--text);
    }
    
    [data-theme="cyberpunk"] #editor,
    [data-theme="cyberpunk"] .chapter-item,
    [data-theme="cyberpunk"] .character-item,
    [data-theme="cyberpunk"] .lore-item,
    [data-theme="cyberpunk"] .book {
      position: relative;
      overflow: hidden;
    }
    
    [data-theme="cyberpunk"] #editor::before,
    [data-theme="cyberpunk"] .chapter-item::before,
    [data-theme="cyberpunk"] .character-item::before,
    [data-theme="cyberpunk"] .lore-item::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--text), transparent);
      animation: cyberpunk-scanline 3s linear infinite;
      opacity: 0.5;
      pointer-events: none;
      z-index: 1;
    }
    
    @keyframes cyberpunk-scanline {
      0% { transform: translateY(-100%); }
      100% { transform: translateY(1000%); }
    }
    
    [data-theme="cyberpunk"] button:hover {
      animation: cyberpunk-glitch 0.3s linear;
    }
    
    @keyframes cyberpunk-glitch {
      0% { transform: translate(2px, 0); }
      25% { transform: translate(-2px, 0); }
      50% { transform: translate(2px, 0); }
      75% { transform: translate(-2px, 0); }
      100% { transform: translate(0, 0); }
    }
    
    [data-theme="cyberpunk"] input:focus, 
    [data-theme="cyberpunk"] select:focus, 
    [data-theme="cyberpunk"] textarea:focus,
    [data-theme="cyberpunk"] #editor:focus {
      box-shadow: 0 0 10px var(--primary), 0 0 20px var(--primary);
    }
    
    [data-theme="cyberpunk"] .book-cover {
      background: linear-gradient(135deg, var(--card-bg) 0%, var(--sidebar-bg) 100%);
      border: 1px solid var(--primary);
      box-shadow: 0 0 15px var(--primary);
    }
    
    [data-theme="cyberpunk"] .book-spine {
      background: linear-gradient(to right, var(--primary), var(--secondary));
    }
    
    /* Sci-fi Theme Effects */
    [data-theme="scifi"] button,
    [data-theme="scifi"] .chapter-item,
    [data-theme="scifi"] .character-item,
    [data-theme="scifi"] .lore-item {
      position: relative;
      overflow: hidden;
    }
    
    [data-theme="scifi"] button::after,
    [data-theme="scifi"] .chapter-item::after,
    [data-theme="scifi"] .character-item::after,
    [data-theme="scifi"] .lore-item::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: linear-gradient(45deg, transparent 45%, rgba(139,233,253,0.1) 50%, transparent 55%);
      background-size: 200% 200%;
      animation: scifi-holographic 3s ease infinite;
      pointer-events: none;
    }
    
    @keyframes scifi-holographic {
      0% { background-position: 0% 0%; }
      50% { background-position: 100% 100%; }
      100% { background-position: 0% 0%; }
    }
    
    [data-theme="scifi"] input:focus, 
    [data-theme="scifi"] select:focus, 
    [data-theme="scifi"] textarea:focus,
    [data-theme="scifi"] #editor {
      box-shadow: 0 0 5px var(--primary), 0 0 10px var(--primary);
    }
    
    [data-theme="scifi"] .book {
      transform-style: preserve-3d;
    }
    
    [data-theme="scifi"] .book-cover {
      background: linear-gradient(135deg, var(--card-bg) 0%, var(--sidebar-bg) 100%);
      border: 1px solid var(--primary);
      box-shadow: 0 0 15px rgba(80, 250, 123, 0.3);
    }
    
    /* Horror Theme Effects */
    [data-theme="horror"] .chapter-item,
    [data-theme="horror"] .character-item,
    [data-theme="horror"] .lore-item,
    [data-theme="horror"] h1,
    [data-theme="horror"] h2,
    [data-theme="horror"] h3,
    [data-theme="horror"] button {
      position: relative;
    }
    
    [data-theme="horror"] .chapter-item::before,
    [data-theme="horror"] .character-item::before,
    [data-theme="horror"] .lore-item::before,
    [data-theme="horror"] h1::before,
    [data-theme="horror"] h2::before,
    [data-theme="horror"] h3::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 5px;
      background: var(--text);
      clip-path: polygon(
        0% 0%, 5% 100%, 10% 0%, 15% 70%, 20% 0%, 25% 100%, 30% 0%, 
        35% 90%, 40% 0%, 45% 50%, 50% 0%, 55% 80%, 60% 0%, 65% 40%, 
        70% 0%, 75% 60%, 80% 0%, 85% 100%, 90% 0%, 95% 70%, 100% 0%
      );
      z-index: 1;
    }
    
    [data-theme="horror"] button,
    [data-theme="horror"] .book-title,
    [data-theme="horror"] h1, 
    [data-theme="horror"] h2, 
    [data-theme="horror"] h3 {
      animation: horror-flicker 5s linear infinite;
    }
    
    @keyframes horror-flicker {
      0%, 19.999%, 22%, 62.999%, 64%, 64.999%, 70%, 100% {
        opacity: 1;
      }
      20%, 21.999%, 63%, 63.999%, 65%, 69.999% {
        opacity: 0.5;
      }
    }
    
    [data-theme="horror"] button, 
    [data-theme="horror"] input, 
    [data-theme="horror"] select,
    [data-theme="horror"] .chapter-title,
    [data-theme="horror"] .character-title,
    [data-theme="horror"] .lore-title {
      filter: blur(0.3px);
      letter-spacing: 1px;
    }
    
    [data-theme="horror"] #editor::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: repeating-linear-gradient(
        0deg,
        rgba(170, 0, 0, 0.03) 0px,
        rgba(170, 0, 0, 0.03) 1px,
        transparent 1px,
        transparent 2px
      );
      pointer-events: none;
      z-index: 1;
    }
    
    [data-theme="horror"] .book-cover {
      background: linear-gradient(135deg, var(--card-bg) 0%, var(--sidebar-bg) 100%);
      border: 1px solid var(--danger);
      box-shadow: 0 0 15px rgba(170, 0, 0, 0.5);
    }
    
    [data-theme="horror"] .book-cover::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(to bottom, transparent 95%, rgba(170, 0, 0, 0.8) 100%);
      pointer-events: none;
      opacity: 0.5;
    }
    
    /* Draggable items styling */
    .chapter-item.dragging, .character-item.dragging, .lore-item.dragging {
      opacity: 0.5;
      border: 2px dashed var(--primary);
    }
    
    .chapter-item.drop-above, .character-item.drop-above, .lore-item.drop-above {
      border-top: 2px solid var(--primary);
    }
    
    .chapter-item.drop-below, .character-item.drop-below, .lore-item.drop-below {
      border-bottom: 2px solid var(--primary);
    }
    
    .drag-handle {
      cursor: grab;
      color: var(--text-light);
      margin-right: 5px;
      user-select: none;
    }
    
    .drag-handle:hover {
      color: var(--primary);
    }
    

    
    /* Make sidebar scrollable but hide scrollbar */
    #sidebar {
      overflow-y: scroll;
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE and Edge */
    }
    
    /* Hide scrollbar in WebKit browsers */
    #sidebar::-webkit-scrollbar, html::-webkit-scrollbar {
      display: none;
    }
/* Theme Variables */
    :root {
      /* Light theme (default) */
      --background: #f5f5f5;
      --text: #333333;
      --text-light: #777777;
      --primary: #4CAF50;
      --primary-hover: #45a049;
      --secondary: #2196F3;
      --secondary-hover: #0b7dda;
      --accent: #FF9800;
      --accent-hover: #e68a00;
      --danger: #f44336;
      --danger-hover: #d32f2f;
      --border: #dddddd;
      --card-bg: #ffffff;
      --sidebar-bg: #f9f9f9;
      --toolbar-bg: #eeeeee;
      --hover-bg: #e0e0e0;
      --menu-bg: white;
      --shadow: rgba(0,0,0,0.1);
      --input-bg: white;
      --input-border: #dddddd;
      --editor-bg: white;
      --active-item: #e0e0e0;
      --chapter-item-bg: #f1f1f1;
      --modal-overlay: rgba(0,0,0,0.7);
      --special-char-btn: #f9f9f9;
      --link-color: #2196F3;
      --code-bg: #f5f5f5;
    }

    /* Dark theme */
    [data-theme="dark"] {
      --background: #1e1e1e;
      --text: #e0e0e0;
      --text-light: #aaaaaa;
      --primary: #5cbb60;
      --primary-hover: #4CAF50;
      --secondary: #42a5f5;
      --secondary-hover: #2196F3;
      --accent: #FFA726;
      --accent-hover: #FF9800;
      --danger: #f44336;
      --danger-hover: #d32f2f;
      --border: #444444;
      --card-bg: #2d2d2d;
      --sidebar-bg: #252525;
      --toolbar-bg: #333333;
      --hover-bg: #3a3a3a;
      --menu-bg: #2d2d2d;
      --shadow: rgba(0,0,0,0.3);
      --input-bg: #333333;
      --input-border: #3a3a3a;
      --editor-bg: #2d2d2d;
      --active-item: #3a3a3a;
      --chapter-item-bg: #333333;
      --modal-overlay: rgba(0,0,0,0.8);
      --special-char-btn: #333333;
      --link-color: #42a5f5;
      --code-bg: #333333;
    }
    
    /* Fantasy theme - Enchanted Edition */
    [data-theme="fantasy"] {
      --background: #f5eedd; /* Aged parchment background */
      --text: #2a1a12; /* Rich mahogany text */
      --text-light: #614c3e; /* Aged oak for secondary text */
      --primary: #7d2933; /* Royal crimson */
      --primary-hover: #5e2027; /* Deep blood red */
      --secondary: #3f593d; /* Forest green */
      --secondary-hover: #2b3f2a; /* Deep forest */
      --accent: #c39b5e; /* Metallic gold */
      --accent-hover: #a1814e; /* Burnished gold */
      --danger: #9b2c2c; /* Dragon red */
      --danger-hover: #7e2222; /* Dragon blood */
      --border: #d0bda5; /* Ancient scroll border */
      --card-bg: #fffbf5; /* Ivory parchment */
      --sidebar-bg: #f4eadc; /* Aged parchment */
      --toolbar-bg: #e9dcc9; /* Weathered leather */
      --hover-bg: #e6d8be; /* Sun-bleached parchment */
      --menu-bg: #f4eadc; /* Scroll menu */
      --shadow: rgba(32,22,16,0.25); /* Mystic shadow */
      --input-bg: #fffdf9; /* Pure parchment */
      --input-border: #d0bda5; /* Quill-marked border */
      --editor-bg: #fffdf9; /* Writing parchment */
      --active-item: #e6d8be; /* Selected item */
      --chapter-item-bg: #f4eadc; /* Chapter scroll */
      --modal-overlay: rgba(20,10,5,0.75); /* Magical veil */
      --special-char-btn: #f4eadc; /* Rune buttons */
      --link-color: #7d2933; /* Ink link */
      --code-bg: #f4eadc; /* Script background */
      
      /* Set primary font */
      font-family: 'Cinzel', 'EB Garamond', serif;
      
      /* Add fantasy-specific decorative elements */
      background-image: 
        url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M54 22c0-12-18-8-18 4 0 12 18 8 18-4zM22 38c0-12-18-8-18 4 0 12 18 8 18-4zM50 50c0-6-9-4-9 2 0 6 9 4 9-2zM10 10c0-6-9-4-9 2 0 6 9 4 9-2zM30 30c0-6-9-4-9 2 0 6 9 4 9-2z' fill='%23d5c7b1' fill-opacity='0.15' fill-rule='evenodd'/%3E%3C/svg%3E"),
        linear-gradient(0deg, rgba(245,238,221,1) 0%, rgba(245,238,221,0.97) 100%);
      
      /* Add subtle texture */
      text-shadow: 1px 1px 1px rgba(0,0,0,0.05);
      
      /* Add a subtle vignette effect */
      position: relative;
    }
    
    /* Mystery theme - Sherlock Holmes Study */
    [data-theme="mystery"] {
      --background: #1a1a14; /* Victorian study dark background */
      --text: #e8dec1; /* Aged parchment text */
      --text-light: #b5a88a; /* Faded parchment for secondary text */
      --primary: #73341d; /* Rich mahogany wood */
      --primary-hover: #5c2816; /* Deeper mahogany */
      --secondary: #2d3319; /* Dark olive green - Victorian color */
      --secondary-hover: #1e2211; /* Deeper olive */
      --accent: #b8860b; /* Antique brass accent */
      --accent-hover: #96700d; /* Deeper brass */
      --danger: #802116; /* Victorian era dark red */
      --danger-hover: #651a11; /* Deeper red */
      --border: #5c4827; /* Aged wood border */
      --card-bg: #252318; /* Victorian wallpaper dark background */
      --sidebar-bg: #1e1d16; /* Deep study sidebar */
      --toolbar-bg: #2a241d; /* Toolbar like polished wood */
      --hover-bg: #39301f; /* Hover like gaslamp light */
      --menu-bg: #252318; /* Menu dropdown */
      --shadow: rgba(0,0,0,0.65); /* Victorian gaslight shadows */
      --input-bg: #2a241d; /* Input fields like old paper */
      --input-border: #5c4827; /* Input borders like wood trim */
      --editor-bg: #1e1d16; /* Editor like an old case notebook */
      --active-item: #39301f; /* Selected item highlighted with gaslamp glow */
      --chapter-item-bg: #2a241d; /* Chapter items like book pages */
      --modal-overlay: rgba(0,0,0,0.85); /* London fog overlay */
      --special-char-btn: #2a241d; /* Special character buttons */
      --link-color: #b8860b; /* Links like brass fixtures */
      --code-bg: #2a241d; /* Code snippets */
      
      /* Set primary font */
      font-family: 'IM Fell English', 'Libre Bodoni', 'Baskervville', serif;
      
      /* Add Victorian wallpaper texture */
      background-image:
        url("data:image/svg+xml,%3Csvg width='52' height='26' viewBox='0 0 52 26' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%235c4827' fill-opacity='0.15'%3E%3Cpath d='M10 10c0-2.21-1.79-4-4-4-3.314 0-6-2.686-6-6h2c0 2.21 1.79 4 4 4 3.314 0 6 2.686 6 6 0 2.21 1.79 4 4 4 3.314 0 6 2.686 6 6 0 2.21 1.79 4 4 4v2c-3.314 0-6-2.686-6-6 0-2.21-1.79-4-4-4-3.314 0-6-2.686-6-6zm25.464-1.95l8.486 8.486-1.414 1.414-8.486-8.486 1.414-1.414z' /%3E%3C/g%3E%3C/g%3E%3C/svg%3E"),
        radial-gradient(circle at center, rgba(42, 36, 29, 0.97) 0%, rgba(26, 26, 20, 1) 70%);
        
      /* Add vignette effect like gaslamp lighting */
      position: relative;
    }

    /* Mystery theme specific decorative elements */
    [data-theme="mystery"]::after {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(
          circle at center,
          transparent 30%,
          rgba(0, 0, 0, 0.65) 100%
        );
      pointer-events: none;
      z-index: -1;
    }

    /* Sherlock Holmes decorative elements */
    [data-theme="mystery"] h1, 
    [data-theme="mystery"] h2,
    [data-theme="mystery"] h3,
    [data-theme="mystery"] h4 {
      font-family: 'IM Fell English SC', 'Libre Bodoni', serif;
      letter-spacing: 1px;
      color: #b8860b;
      position: relative;
      text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
    }

    [data-theme="mystery"] h1::before,
    [data-theme="mystery"] h2::before,
    [data-theme="mystery"] h3::before {
      content: "☞"; /* Victorian era pointing hand symbol */
      position: absolute;
      left: -25px;
      color: var(--accent);
      opacity: 0.7;
    }

    [data-theme="mystery"] h1::after,
    [data-theme="mystery"] h2::after,
    [data-theme="mystery"] h3::after {
      content: "";
      position: absolute;
      height: 1px;
      left: 0;
      bottom: -5px;
      width: 100%;
      background: linear-gradient(90deg, 
        var(--accent) 0%, 
        transparent 100%);
      opacity: 0.8;
    }

    /* Mystery UI decorations */
    [data-theme="mystery"] button {
      border-radius: 0;
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-size: 12px;
      font-family: 'IM Fell English', serif;
      background-image: linear-gradient(to bottom, 
        rgba(0,0,0,0.1) 0%, 
        rgba(0,0,0,0.25) 100%);
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    [data-theme="mystery"] button::before {
      content: "";
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(
        90deg, 
        transparent, 
        rgba(184, 134, 11, 0.15), 
        transparent
      );
      transition: left 0.7s ease;
    }

    [data-theme="mystery"] button:hover::before {
      left: 100%;
    }

    [data-theme="mystery"] button.btn-primary,
    [data-theme="mystery"] button.open-button,
    [data-theme="mystery"] .book-button.open-button {
      background-color: var(--primary);
      color: #e8dec1;
      border: 1px solid #8b5e34;
    }

    [data-theme="mystery"] button.btn-secondary,
    [data-theme="mystery"] button.edit-button,
    [data-theme="mystery"] .book-button.edit-button {
      background-color: var(--secondary);
      color: #e8dec1;
      border: 1px solid #414a28;
    }

    [data-theme="mystery"] input, 
    [data-theme="mystery"] select, 
    [data-theme="mystery"] textarea {
      background-color: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 0;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.5);
      color: var(--text);
      font-family: 'IM Fell English', serif;
      transition: all 0.3s ease;
    }

    [data-theme="mystery"] input:focus, 
    [data-theme="mystery"] select:focus, 
    [data-theme="mystery"] textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 5px rgba(184, 134, 11, 0.4), inset 0 1px 3px rgba(0,0,0,0.5);
      outline: none;
    }

    /* Mystery chapter and character items */
    [data-theme="mystery"] .chapter-item,
    [data-theme="mystery"] .character-item,
    [data-theme="mystery"] .lore-item {
      background: var(--chapter-item-bg);
      border: 1px solid var(--border);
      box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
      margin-bottom: 8px;
      position: relative;
      transition: all 0.3s ease;
      border-radius: 0;
    }

    [data-theme="mystery"] .chapter-item::before,
    [data-theme="mystery"] .character-item::before,
    [data-theme="mystery"] .lore-item::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 3px;
      background: linear-gradient(to bottom, 
        var(--accent) 0%, 
        transparent 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    [data-theme="mystery"] .chapter-item:hover::before,
    [data-theme="mystery"] .character-item:hover::before,
    [data-theme="mystery"] .lore-item:hover::before,
    [data-theme="mystery"] .chapter-item.active::before,
    [data-theme="mystery"] .character-item.active::before,
    [data-theme="mystery"] .lore-item.active::before {
      opacity: 1;
    }

    [data-theme="mystery"] .chapter-item:hover,
    [data-theme="mystery"] .character-item:hover,
    [data-theme="mystery"] .lore-item:hover {
      transform: translateX(3px);
      box-shadow: 3px 3px 7px rgba(0,0,0,0.7);
    }

    /* Mystery editor with parchment effect */
    [data-theme="mystery"] #editor {
      background: var(--editor-bg);
      color: var(--text);
      border: 1px solid var(--border);
      box-shadow: inset 0 0 10px rgba(0,0,0,0.7);
      padding: 20px;
      line-height: 1.8;
      font-family: 'IM Fell English', serif;
      font-size: 17px;
      background-image: 
        url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%235c4827' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E"),
        linear-gradient(0deg, var(--editor-bg) 0%, rgba(36, 33, 25, 0.97) 100%);
      position: relative;
    }

    [data-theme="mystery"] #editor::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        linear-gradient(to right, rgba(36, 33, 25, 0.1) 0%, transparent 20%, transparent 80%, rgba(36, 33, 25, 0.1) 100%),
        linear-gradient(to bottom, rgba(36, 33, 25, 0.1) 0%, transparent 20%, transparent 80%, rgba(36, 33, 25, 0.1) 100%);
      pointer-events: none;
    }

    [data-theme="mystery"] #editor blockquote {
      border-left: 3px solid var(--accent);
      background-color: rgba(42, 36, 29, 0.5);
      padding: 15px 20px;
      margin: 15px 0;
      position: relative;
      font-style: italic;
      color: var(--text);
    }

    [data-theme="mystery"] #editor blockquote::before {
      content: """;
      font-family: 'Baskervville', serif;
      font-size: 60px;
      color: var(--accent);
      opacity: 0.3;
      position: absolute;
      top: -15px;
      left: 5px;
    }

    /* Mystery book styles with Sherlock Holmes aesthetic */
    [data-theme="mystery"] .book {
      perspective: 1200px;
      transform-style: preserve-3d;
      filter: drop-shadow(0 10px 15px rgba(0,0,0,0.7));
    }

    [data-theme="mystery"] .book-cover {
      background: linear-gradient(45deg, 
        #1a1a14 0%, 
        #252318 40%, 
        #39301f 60%, 
        #252318 80%, 
        #1a1a14 100%);
      box-shadow: 0 0 20px rgba(0,0,0,0.7);
      position: relative;
      overflow: hidden;
      border: 1px solid #5c4827;
    }

    [data-theme="mystery"] .book-cover::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        url("data:image/svg+xml,%3Csvg width='6' height='6' viewBox='0 0 6 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%235c4827' fill-opacity='0.2'%3E%3Cpath d='M5 0h1L0 5v1H5V0zm1 5v1H5v-1H0v-1h6V5z'/%3E%3C/g%3E%3C/svg%3E"),
        repeating-linear-gradient(
          -45deg,
          transparent,
          transparent 2px,
          rgba(184, 134, 11, 0.05) 2px,
          rgba(184, 134, 11, 0.05) 4px
        );
      pointer-events: none;
    }

    [data-theme="mystery"] .book-spine {
      background: linear-gradient(to right, 
        #1a1a14 0%, 
        #73341d 30%, 
        #b8860b 50%, 
        #73341d 70%, 
        #1a1a14 100%);
      box-shadow: inset 0 0 10px rgba(0,0,0,0.8);
    }

    [data-theme="mystery"] .book-page {
      background: rgba(232, 222, 193, 0.05);
      box-shadow: inset 0 0 20px rgba(0,0,0,0.6);
    }

    [data-theme="mystery"] .book-title {
      font-family: 'IM Fell English SC', serif;
      color: var(--text);
      letter-spacing: 1px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
    }

    /* Add Victorian-era stamp effect */
    [data-theme="mystery"] .book-cover::before {
      content: "";
      position: absolute;
      width: 60px;
      height: 60px;
      bottom: 20px;
      right: 20px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60' viewBox='0 0 60 60'%3E%3Cpath d='M30 0C13.432 0 0 13.432 0 30s13.432 30 30 30 30-13.432 30-30S46.568 0 30 0zm0 5c13.807 0 25 11.193 25 25S43.807 55 30 55 5 43.807 5 30 16.193 5 30 5zm0 5c-11.046 0-20 8.954-20 20s8.954 20 20 20 20-8.954 20-20S41.046 10 30 10z' fill='%23b8860b' fill-opacity='0.2'/%3E%3C/svg%3E");
      opacity: 0.4;
      transform: rotate(-15deg);
    }

    /* Add magnifying glass icon for search-like elements */
    [data-theme="mystery"] input[type="search"],
    [data-theme="mystery"] input[type="text"] {
      background-position: 5px center;
      background-repeat: no-repeat;
      padding-left: 25px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24'%3E%3Cpath d='M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z' fill='%23b8860b' fill-opacity='0.5'/%3E%3C/svg%3E");
    }

    /* Add fog effects to borders */
    [data-theme="mystery"] .sidebar-bg,
    [data-theme="mystery"] .card-bg,
    [data-theme="mystery"] .toolbar-bg {
      position: relative;
      overflow: hidden;
    }

    [data-theme="mystery"] .sidebar-bg::after,
    [data-theme="mystery"] .card-bg::after,
    [data-theme="mystery"] .toolbar-bg::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(to bottom, 
        rgba(26, 26, 20, 0.4) 0%, 
        transparent 20%, 
        transparent 80%, 
        rgba(26, 26, 20, 0.4) 100%);
      pointer-events: none;
    }

    /* Add pipe icon to bullet points */
    [data-theme="mystery"] ul li::marker {
      content: "🔍 ";
      font-size: 0.8em;
    }
    
    /* Suspense theme - Edge of Tension */
    [data-theme="suspense"] {
      --background: #080808; /* Deep dark background */
      --text: #f0f0f0; /* Stark white text */
      --text-light: #a02c2c; /* Dull red for secondary text */
      --primary: #d91f1f; /* Intense red */
      --primary-hover: #b21919; /* Darker red */
      --secondary: #2a2a2a; /* Dark grey */
      --secondary-hover: #1f1f1f; /* Deeper grey */
      --accent: #f7d100; /* Warning yellow */
      --accent-hover: #d9bc00; /* Darker yellow */
      --danger: #ff0d0d; /* Bright danger red */
      --danger-hover: #cc0000; /* Deeper danger */
      --border: #2f2f2f; /* Dark borders */
      --card-bg: #131313; /* Very dark cards */
      --sidebar-bg: #0a0a0a; /* Nearly black sidebar */
      --toolbar-bg: #1a1a1a; /* Dark toolbar */
      --hover-bg: #202020; /* Slightly lighter for hover */
      --menu-bg: #131313; /* Dark menus */
      --shadow: rgba(0,0,0,0.8); /* Deep shadows */
      --input-bg: #1a1a1a; /* Dark inputs */
      --input-border: #2f2f2f; /* Dark borders */
      --editor-bg: #0a0a0a; /* Dark editor */
      --active-item: #202020; /* Selected items */
      --chapter-item-bg: #1a1a1a; /* Chapter items */
      --modal-overlay: rgba(0,0,0,0.9); /* Very dark overlay */
      --special-char-btn: #1a1a1a; /* Dark buttons */
      --link-color: #d91f1f; /* Red links */
      --code-bg: #1a1a1a; /* Dark code */
      
      /* Set primary font */
      font-family: 'Carrois Gothic SC', 'Barlow', sans-serif;
      
      /* Add suspense-specific texture */
      background-image:
        url("data:image/svg+xml,%3Csvg width='6' height='6' viewBox='0 0 6 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23222222' fill-opacity='0.4' fill-rule='evenodd'%3E%3Cpath d='M5 0h1L0 5v1H5V0zm1 5v1H5v-1H0v-1h6V5z'/%3E%3C/g%3E%3C/svg%3E"),
        linear-gradient(to bottom, rgba(8,8,8,1) 0%, rgba(15,15,15,1) 100%);
    }
    
    /* Suspense theme specific decorative elements */
    [data-theme="suspense"]::after {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        linear-gradient(90deg, 
          rgba(0,0,0,0.3) 0%, 
          transparent 20%, 
          transparent 80%, 
          rgba(0,0,0,0.3) 100%);
      pointer-events: none;
      z-index: -1;
    }
    
    [data-theme="suspense"] h1, 
    [data-theme="suspense"] h2,
    [data-theme="suspense"] h3,
    [data-theme="suspense"] h4 {
      font-family: 'Barlow', sans-serif;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--primary);
      position: relative;
    }
    
    [data-theme="suspense"] h1::after,
    [data-theme="suspense"] h2::after,
    [data-theme="suspense"] h3::after {
      content: "";
      position: absolute;
      height: 2px;
      left: 0;
      bottom: -5px;
      width: 100%;
      background: linear-gradient(90deg, 
        var(--primary) 0%, 
        transparent 100%);
      transform-origin: left center;
      animation: suspense-line-width 5s ease infinite;
    }
    
    @keyframes suspense-line-width {
      0% { transform: scaleX(1); }
      50% { transform: scaleX(0.7); }
      100% { transform: scaleX(1); }
    }
    
    /* Suspense UI decorations */
    [data-theme="suspense"] button {
      border-radius: 0;
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-size: 12px;
      background-image: linear-gradient(to bottom, 
        rgba(0,0,0,0.1) 0%, 
        rgba(0,0,0,0.2) 100%);
      clip-path: polygon(
        0 0, 
        100% 0, 
        100% calc(100% - 5px), 
        calc(100% - 5px) 100%, 
        0 100%
      );
    }
    
    [data-theme="suspense"] button::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background-color: var(--primary);
      transition: transform 0.3s ease;
      transform: translateX(-4px);
    }
    
    [data-theme="suspense"] button:hover::after {
      transform: translateX(0);
    }
    
    [data-theme="suspense"] button.btn-primary,
    [data-theme="suspense"] button.open-button,
    [data-theme="suspense"] .book-button.open-button {
      background-color: var(--primary);
      color: var(--text);
    }
    
    [data-theme="suspense"] button.btn-secondary,
    [data-theme="suspense"] button.edit-button,
    [data-theme="suspense"] .book-button.edit-button {
      background-color: var(--secondary);
      color: var(--text);
    }
    
    [data-theme="suspense"] input, 
    [data-theme="suspense"] select, 
    [data-theme="suspense"] textarea {
      background-color: var(--input-bg);
      border: none;
      border-bottom: 1px solid var(--border);
      border-left: 4px solid var(--primary);
      border-radius: 0;
      box-shadow: inset 0 0 4px rgba(0,0,0,0.5);
      color: var(--text);
      font-family: 'Barlow', sans-serif;
      letter-spacing: 0.5px;
      transition: all 0.3s ease;
      padding-left: 10px;
    }
    
    [data-theme="suspense"] input:focus, 
    [data-theme="suspense"] select:focus, 
    [data-theme="suspense"] textarea:focus {
      border-color: var(--primary);
      border-bottom-color: var(--primary);
      box-shadow: 0 0 5px rgba(217, 31, 31, 0.2), inset 0 0 4px rgba(0,0,0,0.5);
      outline: none;
    }
    
    /* Suspense chapter and character items */
    [data-theme="suspense"] .chapter-item,
    [data-theme="suspense"] .character-item,
    [data-theme="suspense"] .lore-item {
      background: var(--chapter-item-bg);
      border: none;
      border-left: 4px solid var(--secondary);
      box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
      margin-bottom: 8px;
      position: relative;
      transition: all 0.3s ease;
      border-radius: 0;
      clip-path: polygon(
        0 0, 
        100% 0, 
        100% calc(100% - 8px), 
        calc(100% - 8px) 100%, 
        0 100%
      );
    }
    
    [data-theme="suspense"] .chapter-item::after,
    [data-theme="suspense"] .character-item::after,
    [data-theme="suspense"] .lore-item::after {
      content: "";
      position: absolute;
      bottom: 0;
      right: 0;
      border-style: solid;
      border-width: 0 0 8px 8px;
      border-color: transparent transparent var(--primary) transparent;
      transition: all 0.3s ease;
      opacity: 0;
    }
    
    [data-theme="suspense"] .chapter-item:hover::after,
    [data-theme="suspense"] .character-item:hover::after,
    [data-theme="suspense"] .lore-item:hover::after,
    [data-theme="suspense"] .chapter-item.active::after,
    [data-theme="suspense"] .character-item.active::after,
    [data-theme="suspense"] .lore-item.active::after {
      opacity: 1;
    }
    
    [data-theme="suspense"] .chapter-item:hover,
    [data-theme="suspense"] .character-item:hover,
    [data-theme="suspense"] .lore-item:hover {
      transform: translateX(3px);
      border-left-color: var(--primary);
    }
    
    [data-theme="suspense"] .chapter-item.active,
    [data-theme="suspense"] .character-item.active,
    [data-theme="suspense"] .lore-item.active {
      border-left-color: var(--primary);
    }
    
    /* Suspense editor */
    [data-theme="suspense"] #editor {
      background-color: var(--editor-bg);
      color: var(--text);
      border: none;
      box-shadow: inset 0 0 20px rgba(0,0,0,0.7);
      padding: 25px;
      line-height: 1.7;
      font-family: 'Barlow', sans-serif;
      font-size: 17px;
      position: relative;
      letter-spacing: 0.3px;
    }
    
    [data-theme="suspense"] #editor::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(to right, 
        var(--primary) 0%, 
        transparent 100%);
    }
    
    [data-theme="suspense"] #editor::after {
      content: "";
      position: absolute;
      bottom: 0;
      right: 0;
      left: 0;
      height: 3px;
      background: linear-gradient(to left, 
        var(--primary) 0%, 
        transparent 100%);
    }
    
    /* Add a ticking cursor effect for suspense */
    [data-theme="suspense"] #editor:focus::after {
      content: "";
      position: absolute;
      bottom: 20px;
      right: 20px;
      width: 10px;
      height: 10px;
      background-color: var(--primary);
      animation: suspense-ticker 1s infinite;
    }
    
    @keyframes suspense-ticker {
      0%, 100% { opacity: 0; }
      50% { opacity: 1; }
    }
    
    [data-theme="suspense"] #editor blockquote {
      border-left: 3px solid var(--primary);
      background-color: rgba(26, 26, 26, 0.5);
      padding: 15px 20px;
      margin: 15px 0;
      position: relative;
      font-style: italic;
      color: var(--text);
      clip-path: polygon(
        0 0, 
        100% 0, 
        100% calc(100% - 10px), 
        calc(100% - 10px) 100%, 
        0 100%
      );
    }
    
    /* Suspense book styles */
    [data-theme="suspense"] .book {
      perspective: 1200px;
      transform-style: preserve-3d;
      filter: drop-shadow(0 10px 15px rgba(0,0,0,0.5));
    }
    
    [data-theme="suspense"] .book-cover {
      background: linear-gradient(45deg, 
        #080808 0%, 
        #131313 40%, 
        #202020 60%, 
        #131313 80%, 
        #080808 100%);
      box-shadow: 0 0 20px rgba(0,0,0,0.7);
      clip-path: polygon(
        0 0, 
        100% 0, 
        100% calc(100% - 15px), 
        calc(100% - 15px) 100%, 
        0 100%
      );
      border-left: 2px solid var(--primary);
    }
    
    [data-theme="suspense"] .book-spine {
      background: linear-gradient(to right, 
        #080808 0%, 
        var(--primary) 50%, 
        #080808 100%);
      box-shadow: inset 0 0 10px rgba(0,0,0,0.8);
    }
    
    /* Gothic theme - Haunted Elegance */
    [data-theme="gothic"] {
      --background: #1a0f17; /* Deep purple-black */
      --text: #d9c5c1; /* Faded rose */
      --text-light: #8c7d86; /* Muted purple */
      --primary: #6e0823; /* Deep blood red */
      --primary-hover: #560a1d; /* Darker blood red */
      --secondary: #330a24; /* Dark purple */
      --secondary-hover: #26061a; /* Deeper purple */
      --accent: #aa8d67; /* Aged gold */
      --accent-hover: #8c7250; /* Darker gold */
      --danger: #92181f; /* Deep crimson */
      --danger-hover: #7a1119; /* Darker crimson */
      --border: #45253c; /* Dark purple border */
      --card-bg: #231521; /* Dark purple card */
      --sidebar-bg: #170b13; /* Very dark purple sidebar */
      --toolbar-bg: #2c1925; /* Dark purple toolbar */
      --hover-bg: #3a1f31; /* Slightly lighter for hover */
      --menu-bg: #231521; /* Dark menus */
      --shadow: rgba(0,0,0,0.7); /* Deep shadows */
      --input-bg: #2c1925; /* Dark inputs */
      --input-border: #45253c; /* Dark borders */
      --editor-bg: #170b13; /* Dark editor */
      --active-item: #3a1f31; /* Selected items */
      --chapter-item-bg: #2c1925; /* Chapter items */
      --modal-overlay: rgba(10,0,10,0.9); /* Very dark overlay */
      --special-char-btn: #2c1925; /* Dark buttons */
      --link-color: #aa8d67; /* Gold links */
      --code-bg: #2c1925; /* Dark code */
      
      /* Set primary font */
      font-family: 'IM Fell English', 'Baskervville', serif;
      
      /* Add gothic-specific texture */
      background-image:
        url("data:image/svg+xml,%3Csvg width='52' height='26' viewBox='0 0 52 26' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23330a24' fill-opacity='0.15'%3E%3Cpath d='M10 10c0-2.21-1.79-4-4-4-3.314 0-6-2.686-6-6h2c0 2.21 1.79 4 4 4 3.314 0 6 2.686 6 6 0 2.21 1.79 4 4 4 3.314 0 6 2.686 6 6 0 2.21 1.79 4 4 4v2c-3.314 0-6-2.686-6-6 0-2.21-1.79-4-4-4-3.314 0-6-2.686-6-6zm25.464-1.95l8.486 8.486-1.414 1.414-8.486-8.486 1.414-1.414z' /%3E%3C/g%3E%3C/g%3E%3C/svg%3E"),
        radial-gradient(circle at center, rgba(35, 21, 33, 0.95) 0%, rgba(26, 15, 23, 1) 70%);
    }
    
    /* Gothic theme specific decorative elements */
    [data-theme="gothic"]::after {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(
          circle at center,
          transparent 80%,
          rgba(0, 0, 0, 0.7) 100%
        );
      pointer-events: none;
      z-index: -1;
    }
    
    [data-theme="gothic"] h1, 
    [data-theme="gothic"] h2,
    [data-theme="gothic"] h3,
    [data-theme="gothic"] h4 {
      font-family: 'IM Fell English SC', 'UnifrakturMaguntia', serif;
      letter-spacing: 1px;
      color: var(--accent);
      position: relative;
    }
    
    /* Add ornamental decoration to headings */
    [data-theme="gothic"] h1::before,
    [data-theme="gothic"] h2::before,
    [data-theme="gothic"] h3::before {
      content: "❦";
      position: absolute;
      left: -25px;
      color: var(--primary);
      opacity: 0.5;
    }
    
    [data-theme="gothic"] h1::after,
    [data-theme="gothic"] h2::after,
    [data-theme="gothic"] h3::after {
      content: "❦";
      position: absolute;
      right: -25px;
      top: 0;
      color: var(--primary);
      opacity: 0.5;
    }
    
    /* Gothic UI decorations */
    [data-theme="gothic"] button {
      border-radius: 0;
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
      font-family: 'IM Fell English', serif;
      background-image: linear-gradient(to bottom, 
        rgba(0,0,0,0.1) 0%, 
        rgba(0,0,0,0.3) 100%);
    }
    
    [data-theme="gothic"] button::before,
    [data-theme="gothic"] button::after {
      content: "•";
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      color: var(--accent);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    [data-theme="gothic"] button::before {
      left: 5px;
    }
    
    [data-theme="gothic"] button::after {
      right: 5px;
    }
    
    [data-theme="gothic"] button:hover::before,
    [data-theme="gothic"] button:hover::after {
      opacity: 1;
    }
    
    [data-theme="gothic"] button.btn-primary,
    [data-theme="gothic"] button.open-button,
    [data-theme="gothic"] .book-button.open-button {
      background-color: var(--primary);
      color: var(--text);
    }
    
    [data-theme="gothic"] button.btn-secondary,
    [data-theme="gothic"] button.edit-button,
    [data-theme="gothic"] .book-button.edit-button {
      background-color: var(--secondary);
      color: var(--text);
    }
    
    [data-theme="gothic"] input, 
    [data-theme="gothic"] select, 
    [data-theme="gothic"] textarea {
      background-color: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 0;
      box-shadow: inset 0 3px 5px rgba(0,0,0,0.5);
      color: var(--text);
      font-family: 'IM Fell English', serif;
      transition: all 0.3s ease;
    }
    
    [data-theme="gothic"] input:focus, 
    [data-theme="gothic"] select:focus, 
    [data-theme="gothic"] textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 5px rgba(170, 141, 103, 0.3), inset 0 3px 5px rgba(0,0,0,0.5);
      outline: none;
    }
    
    /* Gothic chapter and character items */
    [data-theme="gothic"] .chapter-item,
    [data-theme="gothic"] .character-item,
    [data-theme="gothic"] .lore-item {
      background: var(--chapter-item-bg);
      border: 1px solid var(--border);
      box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
      margin-bottom: 10px;
      position: relative;
      transition: all 0.3s ease;
      border-radius: 0;
      padding: 12px 10px;
    }
    
    /* Add ornamental corners */
    [data-theme="gothic"] .chapter-item::before,
    [data-theme="gothic"] .chapter-item::after,
    [data-theme="gothic"] .character-item::before,
    [data-theme="gothic"] .character-item::after,
    [data-theme="gothic"] .lore-item::before,
    [data-theme="gothic"] .lore-item::after {
      content: "";
      position: absolute;
      width: 8px;
      height: 8px;
      border: 1px solid var(--accent);
      opacity: 0.5;
      transition: all 0.3s ease;
    }
    
    [data-theme="gothic"] .chapter-item::before,
    [data-theme="gothic"] .character-item::before,
    [data-theme="gothic"] .lore-item::before {
      top: 3px;
      left: 3px;
      border-right: none;
      border-bottom: none;
    }
    
    [data-theme="gothic"] .chapter-item::after,
    [data-theme="gothic"] .character-item::after,
    [data-theme="gothic"] .lore-item::after {
      top: 3px;
      right: 3px;
      border-left: none;
      border-bottom: none;
    }
    
    [data-theme="gothic"] .chapter-item:hover::before,
    [data-theme="gothic"] .chapter-item:hover::after,
    [data-theme="gothic"] .character-item:hover::before,
    [data-theme="gothic"] .character-item:hover::after,
    [data-theme="gothic"] .lore-item:hover::before,
    [data-theme="gothic"] .lore-item:hover::after,
    [data-theme="gothic"] .chapter-item.active::before,
    [data-theme="gothic"] .chapter-item.active::after,
    [data-theme="gothic"] .character-item.active::before,
    [data-theme="gothic"] .character-item.active::after,
    [data-theme="gothic"] .lore-item.active::before,
    [data-theme="gothic"] .lore-item.active::after {
      opacity: 1;
      width: 12px;
      height: 12px;
    }
    
    [data-theme="gothic"] .chapter-item:hover,
    [data-theme="gothic"] .character-item:hover,
    [data-theme="gothic"] .lore-item:hover {
      background-color: var(--hover-bg);
      border-color: var(--accent);
    }
    
    /* Gothic editor */
    [data-theme="gothic"] #editor {
      background: var(--editor-bg);
      color: var(--text);
      border: 1px solid var(--border);
      box-shadow: inset 0 0 20px rgba(0,0,0,0.7);
      padding: 25px;
      line-height: 1.8;
      font-family: 'IM Fell English', serif;
      font-size: 17px;
      position: relative;
      background-image: 
        url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23330a24' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E"),
        linear-gradient(0deg, var(--editor-bg) 0%, rgba(26, 15, 23, 0.95) 100%);
    }
    
    /* Add fancy ornamental border to editor */
    [data-theme="gothic"] #editor::before {
      content: "";
      position: absolute;
      top: 10px;
      right: 10px;
      bottom: 10px;
      left: 10px;
      border: 1px solid var(--accent);
      opacity: 0.2;
      pointer-events: none;
    }
    
    [data-theme="gothic"] #editor blockquote {
      border-left: 3px solid var(--accent);
      background-color: rgba(26, 15, 23, 0.7);
      padding: 15px 20px 15px 40px;
      margin: 15px 0;
      position: relative;
      font-style: italic;
      color: var(--text);
    }
    
    [data-theme="gothic"] #editor blockquote::before {
      content: """;
      font-family: 'IM Fell English', serif;
      font-size: 60px;
      color: var(--primary);
      opacity: 0.5;
      position: absolute;
      top: 10px;
      left: 10px;
    }
    
    /* Gothic book styles */
    [data-theme="gothic"] .book {
      perspective: 1200px;
      transform-style: preserve-3d;
      filter: drop-shadow(0 10px 20px rgba(0,0,0,0.7));
    }
    
    [data-theme="gothic"] .book-cover {
      background: linear-gradient(135deg, 
        #1a0f17 0%, 
        #231521 40%, 
        #3a1f31 60%, 
        #231521 80%, 
        #1a0f17 100%);
      border: 1px solid var(--accent);
      box-shadow: 0 0 20px rgba(0,0,0,0.7);
      position: relative;
      overflow: hidden;
    }
    
    /* Add gothic ornamental design to book cover */
    [data-theme="gothic"] .book-cover::before {
      content: "";
      position: absolute;
      top: 10px;
      right: 10px;
      bottom: 10px;
      left: 10px;
      border: 1px solid var(--accent);
      opacity: 0.3;
      pointer-events: none;
    }
    
    [data-theme="gothic"] .book-cover::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Cg fill='%23330a24' fill-opacity='0.1'%3E%3Cpath d='M0 0h80v80H0V0zm20 20v40h40V20H20zm20 35a15 15 0 1 1 0-30 15 15 0 0 1 0 30z' /%3E%3C/g%3E%3C/svg%3E");
      opacity: 0.5;
      pointer-events: none;
    }
    
    [data-theme="gothic"] .book-spine {
      background: linear-gradient(to right, 
        #1a0f17 0%, 
        #6e0823 30%, 
        #aa8d67 50%, 
        #6e0823 70%, 
        #1a0f17 100%);
      box-shadow: inset 0 0 10px rgba(0,0,0,0.8);
    }
    
    [data-theme="gothic"] .book-page {
      background: rgba(217, 197, 193, 0.03);
      box-shadow: inset 0 0 20px rgba(0,0,0,0.7);
      border: 1px solid rgba(110, 8, 35, 0.2);
    }
    
    [data-theme="gothic"] .book-title {
      font-family: 'IM Fell English SC', serif;
      color: var(--text);
      letter-spacing: 1px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
    }
    
    [data-theme="gothic"] .book-author {
      font-family: 'IM Fell English', serif;
      font-style: italic;
      color: var(--text-light);
    }
    
    /* Special effects */
    @keyframes gothic-flicker {
      0%, 100% { opacity: 0.9; }
      50% { opacity: 1; }
    }
    
    [data-theme="gothic"] .book:hover .book-cover {
      animation: gothic-flicker 4s infinite;
    }
    
    /* Underwater theme - Coral Reef */
    [data-theme="underwater"] {
      --background: #053047; /* Deep ocean blue background */
      --text: #e0f7ff; /* Light blue text like water surface */
      --text-light: #8fcbd9; /* Lighter blue for secondary text */
      --primary: #ff7f50; /* Coral orange */
      --primary-hover: #ff6347; /* Deeper coral */
      --secondary: #20b2aa; /* Teal like sea plants */
      --secondary-hover: #00868f; /* Deeper teal */
      --accent: #ffdb58; /* Yellow like tropical fish */
      --accent-hover: #ffd700; /* Brighter yellow */
      --danger: #ff4f4f; /* Red anemone */
      --danger-hover: #e64242; /* Deeper red */
      --border: #64c5e3; /* Light blue border like water surface */
      --card-bg: #0c4863; /* Slightly lighter blue than main background */
      --sidebar-bg: #042638; /* Darker blue sidebar like deep water */
      --toolbar-bg: #0a3c56; /* Dark blue toolbar */
      --hover-bg: #155372; /* Slightly lighter for hover */
      --menu-bg: #0c4863; /* Menu dropdown */
      --shadow: rgba(0,0,0,0.5); /* Deep ocean shadows */
      --input-bg: #0a3c56; /* Input fields */
      --input-border: #64c5e3; /* Input borders */
      --editor-bg: #042638; /* Editor like deep water */
      --active-item: #155372; /* Selected item */
      --chapter-item-bg: #0a3c56; /* Chapter items */
      --modal-overlay: rgba(2,39,58,0.85); /* Deep water overlay */
      --special-char-btn: #0a3c56; /* Special character buttons */
      --link-color: #64c5e3; /* Links like water surface */
      --code-bg: #0a3c56; /* Code snippets */
      
      /* Set primary font */
      font-family: 'Quicksand', 'Comfortaa', sans-serif;
      
      /* Add underwater-specific texture */
      background-image:
        url("data:image/svg+xml,%3Csvg width='100' height='20' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M21.184 20c.357-.13.72-.264 1.088-.402l1.768-.661C33.64 15.347 39.647 14 50 14c10.271 0 15.362 1.222 24.629 4.928.955.383 1.869.74 2.75 1.072h6.225c-2.51-.73-5.139-1.691-8.233-2.928C65.888 13.278 60.562 12 50 12c-10.626 0-16.855 1.397-26.66 5.063l-1.767.662c-2.475.923-4.66 1.674-6.724 2.275h6.335zm0-20C13.258 2.892 8.077 4 0 4V2c5.744 0 9.951-.574 14.85-2h6.334zM77.38 0C85.239 2.966 90.502 4 100 4V2c-6.842 0-11.386-.542-16.396-2h-6.225zM0 14c8.44 0 13.718-1.21 22.272-4.402l1.768-.661C33.64 5.347 39.647 4 50 4c10.271 0 15.362 1.222 24.629 4.928C84.112 12.722 89.438 14 100 14v-2c-10.271 0-15.362-1.222-24.629-4.928C65.888 3.278 60.562 2 50 2 39.374 2 33.145 3.397 23.34 7.063l-1.767.662C13.223 10.84 8.163 12 0 12v2z' fill='%23136a99' fill-opacity='0.2' fill-rule='evenodd'/%3E%3C/svg%3E"),
        radial-gradient(ellipse at center, rgba(8, 57, 82, 0.8) 0%, rgba(5, 48, 71, 1) 100%);
      
      /* Add underwater effect with bubbles */
      position: relative;
    }
    
    /* Underwater theme specific decorative elements */
    [data-theme="underwater"]::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(
          circle at 10% 20%,
          rgba(100, 197, 227, 0.2) 0%,
          transparent 45%
        ),
        radial-gradient(
          circle at 90% 85%,
          rgba(32, 178, 170, 0.25) 0%,
          transparent 40%
        );
      pointer-events: none;
      z-index: -1;
    }
    
    /* Add bubbles animation effect */
    [data-theme="underwater"]::after {
      content: "";
      position: fixed;
      top: 100%;
      left: 0;
      right: 0;
      height: 100%;
      background-image: 
        radial-gradient(circle at 20% 80%, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.15) 45%, rgba(255, 255, 255, 0) 50%),
        radial-gradient(circle at 40% 70%, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0.15) 35%, rgba(255, 255, 255, 0) 40%),
        radial-gradient(circle at 60% 90%, rgba(255, 255, 255, 0.13) 0%, rgba(255, 255, 255, 0.15) 25%, rgba(255, 255, 255, 0) 30%),
        radial-gradient(circle at 80% 75%, rgba(255, 255, 255, 0.11) 0%, rgba(255, 255, 255, 0.15) 30%, rgba(255, 255, 255, 0) 35%);
      background-size: 120px 120px, 90px 90px, 60px 60px, 40px 40px;
      background-repeat: repeat-x;
      animation: underwater-bubbles 20s linear infinite;
      opacity: 0.5;
      pointer-events: none;
      z-index: -1;
    }
    
    @keyframes underwater-bubbles {
      0% { transform: translateY(0); }
      100% { transform: translateY(-100%); }
    }
    
    [data-theme="underwater"] h1, 
    [data-theme="underwater"] h2,
    [data-theme="underwater"] h3,
    [data-theme="underwater"] h4 {
      font-family: 'Quicksand', 'Comfortaa', sans-serif;
      color: var(--accent);
      position: relative;
      text-shadow: 0 2px 5px rgba(0,0,0,0.2);
      letter-spacing: 1px;
    }
    
    [data-theme="underwater"] h1::after,
    [data-theme="underwater"] h2::after,
    [data-theme="underwater"] h3::after {
      content: "";
      position: absolute;
      height: 2px;
      left: 0;
      bottom: -5px;
      width: 100%;
      background: linear-gradient(90deg, 
        var(--primary) 0%, 
        var(--secondary) 50%, 
        transparent 100%);
      opacity: 0.8;
      animation: underwater-wave 4s ease-in-out infinite;
    }
    
    @keyframes underwater-wave {
      0%, 100% { transform: translateX(0) scaleX(1); }
      50% { transform: translateX(10px) scaleX(0.95); }
    }
    
    /* Underwater UI decorations */
    [data-theme="underwater"] button {
      border-radius: 8px;
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
      background-image: linear-gradient(to bottom, 
        rgba(255,255,255,0.1) 0%, 
        rgba(0,0,0,0.1) 100%);
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    /* Add ripple effect to buttons */
    [data-theme="underwater"] button::before {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      width: 250%;
      height: 250%;
      background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 60%);
      transform: translate(-50%, -50%) scale(0);
      opacity: 0;
      transition: transform 0.8s ease, opacity 0.8s ease;
      pointer-events: none;
    }
    
    [data-theme="underwater"] button:hover::before {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
    }
    
    [data-theme="underwater"] button.btn-primary,
    [data-theme="underwater"] button.open-button,
    [data-theme="underwater"] .book-button.open-button {
      background-color: var(--primary);
      color: white;
    }
    
    [data-theme="underwater"] button.btn-secondary,
    [data-theme="underwater"] button.edit-button,
    [data-theme="underwater"] .book-button.edit-button {
      background-color: var(--secondary);
      color: white;
    }
    
    [data-theme="underwater"] input, 
    [data-theme="underwater"] select, 
    [data-theme="underwater"] textarea {
      background-color: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: inset 0 2px 5px rgba(0,0,0,0.2);
      color: var(--text);
      font-family: 'Quicksand', sans-serif;
      transition: all 0.3s ease;
    }
    
    [data-theme="underwater"] input:focus, 
    [data-theme="underwater"] select:focus, 
    [data-theme="underwater"] textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 8px rgba(100, 197, 227, 0.6), inset 0 2px 5px rgba(0,0,0,0.2);
      outline: none;
    }
    
    /* Underwater chapter and character items */
    [data-theme="underwater"] .chapter-item,
    [data-theme="underwater"] .character-item,
    [data-theme="underwater"] .lore-item {
      background: var(--chapter-item-bg);
      border: 1px solid var(--border);
      box-shadow: 0 3px 8px rgba(0,0,0,0.3);
      margin-bottom: 8px;
      position: relative;
      transition: all 0.3s ease;
      border-radius: 8px;
      overflow: hidden;
    }
    
    /* Add wave effect to chapter items */
    [data-theme="underwater"] .chapter-item::before,
    [data-theme="underwater"] .character-item::before,
    [data-theme="underwater"] .lore-item::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      transform: translateX(-100%);
      animation: underwater-shine 4s infinite;
      pointer-events: none;
    }
    
    @keyframes underwater-shine {
      0% { transform: translateX(-100%); }
      20%, 100% { transform: translateX(100%); }
    }
    
    [data-theme="underwater"] .chapter-item:hover,
    [data-theme="underwater"] .character-item:hover,
    [data-theme="underwater"] .lore-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 12px rgba(0,0,0,0.4);
      border-color: var(--accent);
    }
    
    [data-theme="underwater"] .chapter-item.active,
    [data-theme="underwater"] .character-item.active,
    [data-theme="underwater"] .lore-item.active {
      border-color: var(--primary);
      background-color: var(--active-item);
    }
    
    /* Underwater editor */
    [data-theme="underwater"] #editor {
      background: var(--editor-bg);
      color: var(--text);
      border: 1px solid var(--border);
      box-shadow: inset 0 0 20px rgba(0,0,0,0.3);
      padding: 25px;
      line-height: 1.7;
      font-family: 'Quicksand', sans-serif;
      font-size: 17px;
      position: relative;
      border-radius: 8px;
      overflow: hidden;
    }
    
    /* Add underwater reflections to editor */
    [data-theme="underwater"] #editor::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        linear-gradient(135deg, rgba(100, 197, 227, 0.05) 0%, transparent 50%),
        linear-gradient(225deg, rgba(32, 178, 170, 0.05) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }
    
    /* Add underwater lighting effect */
    [data-theme="underwater"] #editor::after {
      content: "";
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(ellipse at top, rgba(100, 197, 227, 0.1) 0%, transparent 70%);
      animation: underwater-light 10s ease-in-out infinite;
      pointer-events: none;
      z-index: 0;
    }
    
    @keyframes underwater-light {
      0%, 100% { transform: translate(-30%, -30%); }
      50% { transform: translate(10%, 10%); }
    }
    
    [data-theme="underwater"] #editor blockquote {
      border-left: 3px solid var(--primary);
      background-color: rgba(10, 60, 86, 0.5);
      padding: 15px 20px;
      margin: 15px 0;
      position: relative;
      font-style: italic;
      color: var(--text);
      border-radius: 0 8px 8px 0;
    }
    
    [data-theme="underwater"] #editor blockquote::before {
      content: """;
      font-family: 'Georgia', serif;
      font-size: 60px;
      color: var(--primary);
      opacity: 0.3;
      position: absolute;
      top: -15px;
      left: 5px;
    }
    
    /* Underwater book styles */
    [data-theme="underwater"] .book {
      perspective: 1200px;
      transform-style: preserve-3d;
      filter: drop-shadow(0 10px 15px rgba(0,0,0,0.4));
    }
    
    [data-theme="underwater"] .book-cover {
      background: linear-gradient(45deg, 
        #042638 0%, 
        #0c4863 40%, 
        #155372 60%, 
        #0c4863 80%, 
        #042638 100%);
      border-radius: 8px 12px 12px 8px;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      position: relative;
      overflow: hidden;
    }
    
    /* Add coral reef pattern to book cover */
    [data-theme="underwater"] .book-cover::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Cg fill='%2320b2aa' fill-opacity='0.12'%3E%3Cpath d='M0,0 Q5,10 0,20 Q5,30 0,40 Q5,50 0,60 Q5,70 0,80 Q5,90 0,100' stroke='%2320b2aa' stroke-width='2' fill='none'/%3E%3C/svg%3E");
      opacity: 0.7;
      pointer-events: none;
    }
    
    /* Add shimmer effects */
    [data-theme="underwater"] .book-cover::after {
      content: "";
      position: absolute;
      top: -150%;
      left: -50%;
      width: 200%;
      height: 300%;
      background: linear-gradient(
        rgba(255, 255, 255, 0),
        rgba(255, 255, 255, 0.1),
        rgba(255, 255, 255, 0)
      );
      transform: rotate(30deg);
      animation: underwater-shimmer 7s ease-in-out infinite;
      pointer-events: none;
    }
    
    @keyframes underwater-shimmer {
      0% { transform: rotate(30deg) translateY(0%); opacity: 0; }
      25% { opacity: 0.2; }
      50% { transform: rotate(30deg) translateY(-30%); opacity: 0; }
      100% { transform: rotate(30deg) translateY(-60%); opacity: 0; }
    }
    
    [data-theme="underwater"] .book-spine {
      background: linear-gradient(to right, 
        #042638 0%, 
        var(--primary) 30%, 
        var(--secondary) 50%, 
        var(--primary) 70%, 
        #042638 100%);
      box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
    }
    
    [data-theme="underwater"] .book-page {
      background: rgba(224, 247, 255, 0.05);
      box-shadow: inset 0 0 20px rgba(0,0,0,0.3);
      border-radius: 0 8px 8px 0;
    }
    
    [data-theme="underwater"] .book-title {
      font-family: 'Quicksand', 'Comfortaa', sans-serif;
      color: var(--text);
      letter-spacing: 1px;
      text-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    
    [data-theme="underwater"] .book-author {
      font-family: 'Quicksand', sans-serif;
      color: var(--text-light);
    }
    
    /* Special floating animation for underwater hover */
    @keyframes underwater-float {
      0%, 100% { transform: translateY(0) rotateY(-20deg); }
      50% { transform: translateY(-5px) rotateY(-25deg); }
    }
    
    [data-theme="underwater"] .book:hover .book-cover {
      animation: underwater-float 3s ease-in-out infinite;
    }
    
    /* Special Fantasy theme effects */
    [data-theme="fantasy"] h1, 
    [data-theme="fantasy"] h2,
    [data-theme="fantasy"] h3,
    [data-theme="fantasy"] h4 {
      font-family: 'Cinzel Decorative', 'Cinzel', serif;
      letter-spacing: 0.5px;
      color: var(--primary);
      position: relative;
    }
    
    [data-theme="fantasy"] h1::after,
    [data-theme="fantasy"] h2::after,
    [data-theme="fantasy"] h3::after {
      content: "";
      position: absolute;
      height: 3px;
      left: 0;
      bottom: -5px;
      width: 100%;
      background: linear-gradient(90deg, 
        var(--primary) 0%, 
        var(--accent) 50%, 
        var(--primary) 100%);
      transform: scaleX(0.8);
      opacity: 0.7;
    }
    
    /* Special fantasy UI enhancements */
    [data-theme="fantasy"] button {
      border-radius: 0;
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
      background-image: linear-gradient(to bottom, 
        rgba(255,255,255,0.1) 0%, 
        rgba(255,255,255,0) 100%);
    }
    
    [data-theme="fantasy"] button::before {
      content: "";
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(
        90deg, 
        transparent, 
        rgba(255,255,255,0.2), 
        transparent
      );
      transition: left 0.7s ease;
    }
    
    [data-theme="fantasy"] button:hover::before {
      left: 100%;
    }
    
    [data-theme="fantasy"] button.btn-primary,
    [data-theme="fantasy"] button.open-button,
    [data-theme="fantasy"] .book-button.open-button {
      background-color: var(--primary);
      background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M20 20.5V18H0v-2h20v-2.5L25 18l-5 4.5z' fill='%23ffffff' fill-opacity='0.2' fill-rule='evenodd'/%3E%3C/svg%3E"),
        linear-gradient(to bottom, 
          rgba(255,255,255,0.1) 0%, 
          rgba(0,0,0,0.1) 100%);
    }
    
    [data-theme="fantasy"] button.btn-secondary,
    [data-theme="fantasy"] button.edit-button,
    [data-theme="fantasy"] .book-button.edit-button {
      background-color: var(--secondary);
      background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M20 20.5V18H0v-2h20v-2.5L25 18l-5 4.5z' fill='%23ffffff' fill-opacity='0.2' fill-rule='evenodd'/%3E%3C/svg%3E"),
        linear-gradient(to bottom, 
          rgba(255,255,255,0.1) 0%, 
          rgba(0,0,0,0.1) 100%);
    }
    
    [data-theme="fantasy"] .btn-danger,
    [data-theme="fantasy"] .delete-button,
    [data-theme="fantasy"] .book-button.delete-button {
      background-color: var(--danger);
      background-image: linear-gradient(to bottom, 
        rgba(255,255,255,0.1) 0%, 
        rgba(0,0,0,0.1) 100%);
    }
    
    /* Fantasy input elements */
    [data-theme="fantasy"] input, 
    [data-theme="fantasy"] select, 
    [data-theme="fantasy"] textarea {
      background-color: var(--input-bg);
      background-image: linear-gradient(to bottom,
        rgba(255,255,255,0.7) 0%,
        rgba(255,255,255,0) 100%);
      border: 1px solid var(--border);
      border-radius: 0;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
      font-family: 'EB Garamond', serif;
      transition: all 0.3s ease;
    }
    
    [data-theme="fantasy"] input:focus, 
    [data-theme="fantasy"] select:focus, 
    [data-theme="fantasy"] textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 5px rgba(125, 41, 51, 0.3), inset 0 1px 3px rgba(0,0,0,0.1);
      outline: none;
    }
    
    /* Fantasy chapter and character items */
    [data-theme="fantasy"] .chapter-item,
    [data-theme="fantasy"] .character-item,
    [data-theme="fantasy"] .lore-item {
      background: var(--chapter-item-bg);
      border: 1px solid var(--border);
      box-shadow: 2px 2px 5px rgba(0,0,0,0.05);
      margin-bottom: 8px;
      position: relative;
      transition: all 0.3s ease;
      border-radius: 0;
      background-image: linear-gradient(to bottom,
        rgba(255,255,255,0.5) 0%,
        rgba(255,255,255,0) 100%);
      padding: 12px 10px;
    }
    
    [data-theme="fantasy"] .chapter-item::before,
    [data-theme="fantasy"] .character-item::before,
    [data-theme="fantasy"] .lore-item::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 4px;
      background: linear-gradient(to bottom, 
        var(--primary) 0%, 
        var(--primary-hover) 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    [data-theme="fantasy"] .chapter-item:hover::before,
    [data-theme="fantasy"] .character-item:hover::before,
    [data-theme="fantasy"] .lore-item:hover::before,
    [data-theme="fantasy"] .chapter-item.active::before,
    [data-theme="fantasy"] .character-item.active::before,
    [data-theme="fantasy"] .lore-item.active::before {
      opacity: 1;
    }
    
    [data-theme="fantasy"] .chapter-item:hover,
    [data-theme="fantasy"] .character-item:hover,
    [data-theme="fantasy"] .lore-item:hover {
      transform: translateX(3px);
      box-shadow: 3px 3px 7px rgba(0,0,0,0.1);
    }
    
    [data-theme="fantasy"] .chapter-item.active,
    [data-theme="fantasy"] .character-item.active,
    [data-theme="fantasy"] .lore-item.active {
      background-color: var(--active-item);
      border-color: var(--border);
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
      transform: translateX(3px);
    }
    
    /* Fantasy editor */
    [data-theme="fantasy"] #editor {
      background: var(--editor-bg);
      background-image: 
        linear-gradient(#f4eadc 1px, transparent 1px),
        linear-gradient(90deg, rgba(122, 98, 67, 0.03) 1px, transparent 1px);
      background-size: 100% 26px, 100% 26px;
      background-position: 0 1px;
      border: 1px solid var(--border);
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      padding: 26px 15px 15px 15px;
      line-height: 26px;
      font-family: 'EB Garamond', serif;
      font-size: 18px;
      color: var(--text);
    }
    
    /* Fantasy book styles */
    [data-theme="fantasy"] .book {
      perspective: 1200px;
      transform-style: preserve-3d;
      filter: drop-shadow(0 10px 15px rgba(0,0,0,0.2));
    }
    
    [data-theme="fantasy"] .book-cover {
      background: linear-gradient(45deg, 
        #5d432c 0%, 
        #a97d4c 40%, 
        #d9b174 60%, 
        #a97d4c 80%, 
        #5d432c 100%);
      border-radius: 0 5px 5px 0;
      border: 1px solid #4a3520;
      border-left: 2px ridge #d9b174;
      box-shadow: 
        inset 0 0 30px rgba(0,0,0,0.2),
        1px 1px 2px rgba(255,255,255,0.2);
      transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    
    [data-theme="fantasy"] .book:hover .book-cover {
      transform: rotateY(-30deg);
    }
    
    [data-theme="fantasy"] .book-spine {
      background: linear-gradient(to right, 
        #4a3520 0%, 
        #a97d4c 30%, 
        #d9b174 50%, 
        #a97d4c 70%, 
        #4a3520 100%);
      box-shadow: inset -2px 0 5px rgba(0,0,0,0.5);
    }
    
    [data-theme="fantasy"] .book-page {
      background: #f5eedd;
      border-radius: 0 3px 3px 0;
      box-shadow: 
        inset 0 0 20px rgba(0,0,0,0.2),
        1px 1px 1px rgba(0,0,0,0.1);
    }
    
    [data-theme="fantasy"] .book-info {
      background: rgba(255,251,245,0.9);
      border-top: 1px solid rgba(0,0,0,0.1);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.3);
    }
    
    [data-theme="fantasy"] .book-title {
      font-family: 'Cinzel', serif;
      text-shadow: 1px 1px 1px rgba(0,0,0,0.2);
      letter-spacing: 0.5px;
    }
    
    [data-theme="fantasy"] .book-author {
      font-family: 'EB Garamond', serif;
      font-style: italic;
    }
    
    [data-theme="fantasy"] .book-cover-img {
      border: 4px double #d0bda5;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    
    /* Fantasy modal styles */
    [data-theme="fantasy"] #imageModal,
    [data-theme="fantasy"] #specialCharModal,
    [data-theme="fantasy"] #characterImagePreviewModal,
    [data-theme="fantasy"] #loreImagePreviewModal {
      background-image: radial-gradient(
        circle at center,
        rgba(20,10,5,0.7) 0%,
        rgba(20,10,5,0.9) 100%
      );
    }
    
    [data-theme="fantasy"] #imageModal > div,
    [data-theme="fantasy"] #specialCharModal > div,
    [data-theme="fantasy"] #loreEditorContainer {
      background: var(--card-bg);
      border: 1px solid var(--border);
      box-shadow: 0 0 30px rgba(0,0,0,0.3);
      border-radius: 0;
      position: relative;
      background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M54 22c0-12-18-8-18 4 0 12 18 8 18-4zM22 38c0-12-18-8-18 4 0 12 18 8 18-4zM50 50c0-6-9-4-9 2 0 6 9 4 9-2zM10 10c0-6-9-4-9 2 0 6 9 4 9-2zM30 30c0-6-9-4-9 2 0 6 9 4 9-2z' fill='%23d5c7b1' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E"),
        linear-gradient(0deg, var(--card-bg) 0%, rgba(255,251,245,0.97) 100%);
    }
    
    [data-theme="fantasy"] #imageModal > div::before,
    [data-theme="fantasy"] #specialCharModal > div::before {
      content: "";
      position: absolute;
      top: -10px;
      left: -10px;
      right: -10px;
      bottom: -10px;
      border: 1px solid var(--accent);
      z-index: -1;
      opacity: 0.3;
      pointer-events: none;
    }
    
    [data-theme="fantasy"] .special-char-btn {
      border: 1px solid var(--border);
      background-color: var(--special-char-btn);
      color: var(--text);
      font-family: 'Cinzel', serif;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(2px);
    }
    
    [data-theme="fantasy"] .special-char-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 3px 5px rgba(0,0,0,0.1);
      border-color: var(--accent);
      color: var(--primary);
    }
    
    /* Fantasy toolbar */
    [data-theme="fantasy"] #toolbar {
      background-color: var(--toolbar-bg);
      background-image: linear-gradient(to bottom,
        rgba(255,255,255,0.5) 0%,
        rgba(255,255,255,0) 100%);
      border: 1px solid var(--border);
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      padding: 12px;
      border-radius: 0;
    }
    
    /* Add decorative corners to certain elements */
    [data-theme="fantasy"] header,
    [data-theme="fantasy"] #novelEditorContainer > div:first-child,
    [data-theme="fantasy"] #characterEditorContainer > div:first-child,
    [data-theme="fantasy"] #loreEditorContainer > div:first-child,
    [data-theme="fantasy"] #toolbar,
    [data-theme="fantasy"] #editor {
      position: relative;
    }
    
    [data-theme="fantasy"] header::before,
    [data-theme="fantasy"] header::after,
    [data-theme="fantasy"] #novelEditorContainer > div:first-child::before,
    [data-theme="fantasy"] #novelEditorContainer > div:first-child::after,
    [data-theme="fantasy"] #characterEditorContainer > div:first-child::before,
    [data-theme="fantasy"] #characterEditorContainer > div:first-child::after,
    [data-theme="fantasy"] #loreEditorContainer > div:first-child::before,
    [data-theme="fantasy"] #loreEditorContainer > div:first-child::after,
    [data-theme="fantasy"] #toolbar::before,
    [data-theme="fantasy"] #toolbar::after,
    [data-theme="fantasy"] #editor::before,
    [data-theme="fantasy"] #editor::after {
      content: "";
      position: absolute;
      width: 20px;
      height: 20px;
      border-color: var(--primary);
      border-style: solid;
      pointer-events: none;
      opacity: 0.6;
    }
    
    [data-theme="fantasy"] header::before,
    [data-theme="fantasy"] #novelEditorContainer > div:first-child::before,
    [data-theme="fantasy"] #characterEditorContainer > div:first-child::before,
    [data-theme="fantasy"] #loreEditorContainer > div:first-child::before,
    [data-theme="fantasy"] #toolbar::before,
    [data-theme="fantasy"] #editor::before {
      top: 5px;
      left: 5px;
      border-width: 2px 0 0 2px;
    }
    
    [data-theme="fantasy"] header::after,
    [data-theme="fantasy"] #novelEditorContainer > div:first-child::after,
    [data-theme="fantasy"] #characterEditorContainer > div:first-child::after,
    [data-theme="fantasy"] #loreEditorContainer > div:first-child::after,
    [data-theme="fantasy"] #toolbar::after,
    [data-theme="fantasy"] #editor::after {
      top: 5px;
      right: 5px;
      border-width: 2px 2px 0 0;
    }
    
    [data-theme="fantasy"] header > img {
      filter: sepia(0.3);
    }
    
    /* Character images */
    [data-theme="fantasy"] .character-image-item,
    [data-theme="fantasy"] .lore-image-item {
      border: 1px solid var(--border);
      background: var(--input-bg);
      transition: all 0.3s ease;
      position: relative;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    [data-theme="fantasy"] .character-image-item::before,
    [data-theme="fantasy"] .lore-image-item::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(
        circle at center,
        rgba(255,255,255,0) 30%,
        rgba(195,155,94,0.2) 100%
      );
      pointer-events: none;
    }
    
    [data-theme="fantasy"] .character-image-item:hover,
    [data-theme="fantasy"] .lore-image-item:hover {
      transform: scale(1.05) rotate(1deg);
      box-shadow: 0 5px 10px rgba(0,0,0,0.15);
      border-color: var(--accent);
    }
    
    [data-theme="fantasy"] .character-image-item img,
    [data-theme="fantasy"] .lore-image-item img {
      transition: all 0.5s ease;
    }
    
    [data-theme="fantasy"] .character-image-item:hover img,
    [data-theme="fantasy"] .lore-image-item:hover img {
      transform: scale(1.1) rotate(-1deg);
    }
    
    /* Fantasy blockquote */
    [data-theme="fantasy"] #editor blockquote {
      border-left: 3px solid var(--primary);
      background-color: rgba(245,238,221,0.5);
      padding: 10px 15px;
      margin: 15px 0;
      position: relative;
      font-style: italic;
      color: var(--text);
    }
    
    [data-theme="fantasy"] #editor blockquote::before {
      content: """;
      font-family: 'EB Garamond', serif;
      font-size: 60px;
      color: var(--primary);
      opacity: 0.2;
      position: absolute;
      top: -15px;
      left: 5px;
    }
    
    /* Cyberpunk theme */
    [data-theme="cyberpunk"] {
      --background: #050b18;
      --text: #00ffff;
      --text-light: #ff00ff;
      --primary: #00ffaa;
      --primary-hover: #00cc88;
      --secondary: #ff00aa;
      --secondary-hover: #cc0088;
      --accent: #ffcc00;
      --accent-hover: #cc9900;
      --danger: #ff3366;
      --danger-hover: #cc2a52;
      --border: #0077ff;
      --card-bg: #101a2c;
      --sidebar-bg: #09142b;
      --toolbar-bg: #0d1833;
      --hover-bg: #132347;
      --menu-bg: #101a2c;
      --shadow: rgba(0,255,255,0.3);
      --input-bg: #0d1833;
      --input-border: #0077ff;
      --editor-bg: #09142b;
      --active-item: #132347;
      --chapter-item-bg: #0d1833;
      --modal-overlay: rgba(5,11,24,0.9);
      --special-char-btn: #0d1833;
      --link-color: #00ffff;
      --code-bg: #0d1833;
      font-family: 'Orbitron', sans-serif;
    }
    
    /* Sci-Fi theme */
    [data-theme="scifi"] {
      --background: #0a1017;
      --text: #8be9fd;
      --text-light: #6272a4;
      --primary: #50fa7b;
      --primary-hover: #41bb6c;
      --secondary: #bd93f9;
      --secondary-hover: #a075e8;
      --accent: #ffb86c;
      --accent-hover: #e59c59;
      --danger: #ff5555;
      --danger-hover: #e64545;
      --border: #44475a;
      --card-bg: #0e1620;
      --sidebar-bg: #080f18;
      --toolbar-bg: #111b27;
      --hover-bg: #162433;
      --menu-bg: #0e1620;
      --shadow: rgba(139,233,253,0.2);
      --input-bg: #111b27;
      --input-border: #44475a;
      --editor-bg: #080f18;
      --active-item: #162433;
      --chapter-item-bg: #111b27;
      --modal-overlay: rgba(10,16,23,0.9);
      --special-char-btn: #111b27;
      --link-color: #8be9fd;
      --code-bg: #111b27;
      font-family: 'Rajdhani', sans-serif;
    }
    
    /* Horror theme */
    [data-theme="horror"] {
      --background: #0a0000;
      --text: #cf0000;
      --text-light: #700000;
      --primary: #8b0000;
      --primary-hover: #6d0000;
      --secondary: #400000;
      --secondary-hover: #2e0000;
      --accent: #610000;
      --accent-hover: #4d0000;
      --danger: #ff0000;
      --danger-hover: #cc0000;
      --border: #300000;
      --card-bg: #1a0000;
      --sidebar-bg: #150000;
      --toolbar-bg: #240000;
      --hover-bg: #2c0000;
      --menu-bg: #1a0000;
      --shadow: rgba(170,0,0,0.5);
      --input-bg: #240000;
      --input-border: #300000;
      --editor-bg: #150000;
      --active-item: #2c0000;
      --chapter-item-bg: #240000;
      --modal-overlay: rgba(10,0,0,0.9);
      --special-char-btn: #240000;
      --link-color: #cf0000;
      --code-bg: #240000;
      font-family: 'Special Elite', cursive;
    }

  @media (max-width: 768px) {
    #sidebar { 
      display: none; 
      position: fixed; 
      top: 0; 
      left: 0; 
      right: 0; 
      height: 100vh; 
      width: 100%; 
      z-index: 200; 
      background: var(--sidebar-bg);
      overflow-y: scroll;
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE and Edge */
    }
    
    /* Hide scrollbar in WebKit browsers */
    #sidebar::-webkit-scrollbar {
      display: none;
    }
    
    #editorContainer { width: 100%; }
    #novelListContainer { width: 100%; }
    #characterEditorContainer { width: 100%; }
    #novelEditorContainer { width: 100%; }
    #loreEditorContainer { width: 100%; }
    #mainContent { padding-bottom: 50px; }
    #toolbar { flex-wrap: wrap; overflow-x: auto; }
  }
  
  .chapter-item, .character-item, .lore-item { 
    padding: 8px; 
    margin-bottom: 5px; 
    background: var(--chapter-item-bg); 
    border-radius: 4px; 
    cursor: pointer; 
    transition: background-color 0.3s;
    position: relative;
    overflow: hidden;
  }
  
  .chapter-item.active, .character-item.active, .lore-item.active { 
    background: var(--active-item); 
    font-weight: bold; 
  }
  
  [contenteditable=true]:empty:before {
    content: attr(placeholder);
    color: var(--text-light);
    font-style: italic;
  }
  
  /* Rich text editor specific styles */
  #editor blockquote {
    border-left: 3px solid var(--border);
    margin-left: 5px;
    padding-left: 15px;
    color: var(--text-light);
  }
  
  #editor pre {
    background-color: var(--code-bg);
    padding: 10px;
    border: 1px solid var(--border);
    border-radius: 4px;
    font-family: 'Courier New', Courier, monospace;
  }
  
  #editor table {
    border-collapse: collapse;
    width: 100%;
    margin: 10px 0;
  }
  
  #editor table td, #editor table th {
    border: 1px solid var(--border);
    padding: 8px;
  }
  
  #editor img {
    max-width: 100%;
    height: auto;
    cursor: pointer;
  }
  
  #editor img.selected {
    outline: 2px solid var(--primary);
  }
  
  #editor hr {
    border: none;
    border-top: 1px solid var(--border);
    margin: 20px 0;
  }
  
  /* Special character button styles */
  .special-char-btn {
    padding: 10px;
    min-width: 40px;
    font-size: 12px;
    border: 1px solid var(--border);
    background: var(--special-char-btn);
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.2s;
    color: var(--text);
  }
  
  .special-char-btn:hover {
    background: var(--hover-bg);
  }
  
  /* Novel card styles */
  .novel-card {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 15px;
    width: 220px;
    box-shadow: 0 2px 4px var(--shadow);
    transition: transform 0.2s, box-shadow 0.2s;
    color: var(--text);
  }
  
  .novel-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 8px var(--shadow);
  }
  
  .novel-title {
    margin-top: 0;
    margin-bottom: 10px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: var(--text);
  }
  
  /* Editable chapter title styles */
  .chapter-title, .character-title, .lore-title {
    flex: 1;
    cursor: pointer;
    padding: 2px 4px;
    border-radius: 2px;
    font-size: 0.9rem;
    color: var(--text);
  }
  
  .chapter-title:hover, .character-title:hover, .lore-title:hover {
    background-color: var(--hover-bg);
  }
  
  .chapter-title[contenteditable="true"], .character-title[contenteditable="true"], .lore-title[contenteditable="true"] {
    background-color: var(--input-bg);
    border: 1px solid var(--primary);
    outline: none;
    cursor: text;
  }
  
  /* Character and Lore image styles */
  .character-image-item, .lore-image-item {
    position: relative;
    width: 120px;
    height: 120px;
    border: 1px dashed var(--border);
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    transition: transform 0.2s;
    background: var(--input-bg);
    color: var(--text-light);
  }
  
  .character-image-item:hover, .lore-image-item:hover {
    transform: scale(1.05);
  }
  
  .character-image-item img, .lore-image-item img {
    max-width: 100%;
    max-height: 100%;
    object-fit: cover;
    transition: transform 0.3s;
  }
  
  .character-image-item img:hover, .lore-image-item img:hover {
    transform: scale(1.1);
  }
  
  /* Book styles */
  .book {
    width: 180px;
    height: 350px;
    position: relative;
    perspective: 1000px;
    margin-bottom: 20px;
    transform-style: preserve-3d;
  }
  
  .book-cover {
    width: 100%;
    height: 100%;
    position: absolute;
    transform-style: preserve-3d;
    transform-origin: left center;
    transition: transform 0.5s ease;
    background: var(--card-bg);
    box-shadow: 0 0 20px var(--shadow);
    border-radius: 2px 6px 6px 2px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    cursor: pointer;
  }
  
  .book:hover .book-cover {
    transform: rotateY(-25deg);
    box-shadow: 20px 0 20px var(--shadow);
  }
  
  .book-spine {
    position: absolute;
    width: 20px;
    height: 100%;
    left: 0;
    background: linear-gradient(to right, var(--hover-bg), var(--primary));
    transform: rotateY(90deg) translateZ(-10px);
    transform-origin: left;
    box-shadow: inset -2px 0 5px var(--shadow);
  }
  
  .book-page {
    position: absolute;
    width: 95%;
    height: 96%;
    top: 2%;
    right: 0;
    background: var(--background);
    transform: translateZ(-1px);
    border-radius: 1px 5px 5px 1px;
    box-shadow: 0 0 2px var(--shadow);
  }
  
  .book-cover-img {
    margin: 0px;
    width: 100%;
    height: 100%;
    object-fit: cover;
    background-color: transparent;
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
  }
  
  .book-info {
    padding: 10px;
    padding-top: 4px;
    background: var(--card-bg);
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    color: var(--text);
  }
  
  .book-title {
    font-weight: bold;
    font-size: 14px;
    margin: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: var(--text);
  }
  
  .book-author {
    font-size: 12px;
    color: var(--text-light);
    margin: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .book-stats {
    font-size: 10px;
    color: var(--text-light);
    margin-top: 4px;
  }
  
  .book-buttons {
    display: flex;
    position: absolute;
    bottom: -40px;
    left: 0;
    right: 0;
    transition: bottom 0.3s ease;
  }
  
  .book:hover .book-buttons {
    bottom: 0;
  }
  
  .book-button {
    flex: 1;
    padding: 8px 0;
    text-align: center;
    font-size: 12px;
    border: none;
    cursor: pointer;
    transition: background 0.2s;
  }
  
  .edit-button {
    background: var(--secondary);
    color: white;
  }
  
  .edit-button:hover {
    background: var(--secondary-hover);
  }
  
  .open-button {
    background: var(--primary);
    color: white;
  }
  
  .open-button:hover {
    background: var(--primary-hover);
  }
  
  .delete-button {
    background: var(--danger);
    color: white;
  }
  
  .delete-button:hover {
    background: var(--danger-hover);
  }
  
  /* Novel cover image */
  #novelCoverPreviewContainer {
    transition: transform 0.2s;
    overflow: hidden;
    background: var(--input-bg);
  }
  
  #novelCoverPreviewContainer:hover {
    transform: scale(1.05);
  }
  
  #novelCoverPreview {
    object-fit: cover;
    transition: transform 0.3s;
  }
  
  #novelCoverPreview:hover {
    transform: scale(1.1);
  }
  
  /* Apply theme transitions */
  * {
    transition: background-color 0.3s, color 0.3s, border-color 0.3s;
  }
  
  /* Cyberpunk theme effects */
  [data-theme="cyberpunk"] h1, 
  [data-theme="cyberpunk"] h2,
  [data-theme="cyberpunk"] h3,
  [data-theme="cyberpunk"] h4,
  [data-theme="cyberpunk"] .book-title,
  [data-theme="cyberpunk"] button {
    text-shadow: 0 0 5px var(--text), 0 0 10px var(--text);
  }
  
  [data-theme="cyberpunk"] #editor,
  [data-theme="cyberpunk"] .chapter-item,
  [data-theme="cyberpunk"] .character-item,
  [data-theme="cyberpunk"] .lore-item,
  [data-theme="cyberpunk"] .book {
    position: relative;
    overflow: hidden;
  }
  
  [data-theme="cyberpunk"] #editor::before,
  [data-theme="cyberpunk"] .chapter-item::before,
  [data-theme="cyberpunk"] .character-item::before,
  [data-theme="cyberpunk"] .lore-item::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--text), transparent);
    animation: cyberpunk-scanline 3s linear infinite;
    opacity: 0.5;
    pointer-events: none;
    z-index: 1;
  }
  
  @keyframes cyberpunk-scanline {
    0% { transform: translateY(-100%); }
    100% { transform: translateY(1000%); }
  }
  
  [data-theme="cyberpunk"] button:hover {
    animation: cyberpunk-glitch 0.3s linear;
  }
  
  @keyframes cyberpunk-glitch {
    0% { transform: translate(2px, 0); }
    25% { transform: translate(-2px, 0); }
    50% { transform: translate(2px, 0); }
    75% { transform: translate(-2px, 0); }
    100% { transform: translate(0, 0); }
  }
  
  [data-theme="cyberpunk"] input:focus, 
  [data-theme="cyberpunk"] select:focus, 
  [data-theme="cyberpunk"] textarea:focus,
  [data-theme="cyberpunk"] #editor:focus {
    box-shadow: 0 0 10px var(--primary), 0 0 20px var(--primary);
  }
  
  [data-theme="cyberpunk"] .book-cover {
    background: linear-gradient(135deg, var(--card-bg) 0%, var(--sidebar-bg) 100%);
    border: 1px solid var(--primary);
    box-shadow: 0 0 15px var(--primary);
  }
  
  [data-theme="cyberpunk"] .book-spine {
    background: linear-gradient(to right, var(--primary), var(--secondary));
  }
  
  /* Sci-fi Theme Effects */
  [data-theme="scifi"] button,
  [data-theme="scifi"] .chapter-item,
  [data-theme="scifi"] .character-item,
  [data-theme="scifi"] .lore-item {
    position: relative;
    overflow: hidden;
  }
  
  [data-theme="scifi"] button::after,
  [data-theme="scifi"] .chapter-item::after,
  [data-theme="scifi"] .character-item::after,
  [data-theme="scifi"] .lore-item::after {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: linear-gradient(45deg, transparent 45%, rgba(139,233,253,0.1) 50%, transparent 55%);
    background-size: 200% 200%;
    animation: scifi-holographic 3s ease infinite;
    pointer-events: none;
  }

[data-theme="comic book"] {
  /* High contrast, vibrant background */
  --background: #fff600;
  --foreground: #1a1a1a;
  --primary: #e60012;
  --secondary: #0078ff;
  --accent: #00ff26;
  --highlight: #ffae00;
  --muted: #fff200;
  --border: #1a1a1a;
  --shadow: 0 6px 30px 0 rgba(0,0,0,0.4), 0 1.5px 6px 0 #0078ff;
  --dropdown-bg: #fff600;
  --dropdown-border: #1a1a1a;
  --dropdown-shadow: 0 2px 12px 0 rgba(0,0,0,0.24);

  /* Comic book font stack - use bold, dynamic fonts */
  --font-family: 'Bangers', 'Comic Sans MS', 'Comic Sans', Impact, fantasy, sans-serif;
  --font-weight: 900;
  --font-size: 18px;
  --line-height: 1.2;
}

[data-theme="comic book"] body {
  background: var(--background);
  color: var(--foreground);
  font-family: var(--font-family);
  font-weight: var(--font-weight);
  font-size: 12px;
  line-height: var(--line-height);
  letter-spacing: 0.02em;
  text-shadow: 1px 1px 0 #fff, 2px 2px 0 #1a1a1a;
  text-decoration: italic;
}

/* Action-packed comic panel borders */
[data-theme="comic book"] *,
[data-theme="comic book"] *:before,
[data-theme="comic book"] *:after {
  box-sizing: border-box;
}

/* ThemeSelect dropdown box styling */
[data-theme="comic book"] select {
  background: var(--dropdown-bg);
  color: var(--primary);
  border: 4px solid var(--dropdown-border);
  border-radius: 10px;
  box-shadow: var(--dropdown-shadow);
  font-family: var(--font-family);
  font-weight: 900;
  font-size: 1.2em;
  outline: 3px solid var(--primary);
  outline-offset: 2px;
  padding: 0.6em 1.5em;
  transition: border-color 0.2s, background 0.2s;
  text-shadow: 1px 1px 0 #fff, 2px 2px 0 #1a1a1a;
  cursor: pointer;
}

[data-theme="comic book"] select:focus, 
[data-theme="comic book"] select:hover {
  border-color: var(--accent);
  background: var(--highlight);
  color: var(--secondary);
}

[data-theme="comic book"] option {
  background: var(--dropdown-bg);
  color: var(--primary);
  font-family: var(--font-family);
  font-weight: 900;
  font-size: 1em;
  text-shadow: 1px 1px 0 #fff, 1.5px 1.5px 0 #1a1a1a;
}

/* Comic pop effect for headings */
[data-theme="comic book"] h1, 
[data-theme="comic book"] h2, 
[data-theme="comic book"] h3, 
[data-theme="comic book"] h4, 
[data-theme="comic book"] h5, 
[data-theme="comic book"] h6 {
  color: var(--primary);
  font-family: var(--font-family);
  font-size: 18px;
  font-weight: 900;
  text-transform: uppercase;
  letter-spacing: 0.04em;
  text-shadow:
    2px 2px 0 #fff,
    4px 4px 0 #1a1a1a,
    0 0 10px var(--secondary);
  margin-top: 1em;
  margin-bottom: 0.5em;
}

/* Comic panel look for containers */
[data-theme="comic book"] [role="main"], 
[data-theme="comic book"] main,
[data-theme="comic book"] section,
[data-theme="comic book"] .panel,
[data-theme="comic book"] .card {
  background: #fffde7;
  border: 5px solid var(--primary);
  border-radius: 18px 4px 16px 8px;
  box-shadow: 0 8px 30px 0 rgba(0,0,0,0.35), 0 2px 8px 0 var(--secondary);
  padding: 1.2em 2em;
  margin: 1em 0;
  position: relative;
  z-index: 1;
}

/* Add a starburst effect to the dropdown */
[data-theme="comic book"] select {
  background-image: radial-gradient(circle at 60% 40%, #00fd87 25%, #fff600 100%);
}

[data-theme="comic book"] select:active {
  background: var(--accent);
  color: var(--foreground);
  border-color: var(--primary);
  box-shadow: 0 0 0 5px var(--secondary);
}

/* Energetic comic button style */
[data-theme="comic book"] button,
[data-theme="comic book"] input[type="button"],
[data-theme="comic book"] input[type="submit"] {
  background: var(--primary);
  color: #fff;
  border: 2px solid var(--foreground);
  border-radius: 10px;
  font-family: var(--font-family);
  font-size: 12px
  font-weight: 900;
  font-size: 0.9em;
  letter-spacing: 0.03em;
  text-shadow: 1px 1px 0 #000, 2px 2px 0 #1a1a1a;
  padding: 0.2em 0.4em;
  box-shadow: 0 3px 4px 0 var(--secondary);
  cursor: pointer;
  transition: background 0.15s, color 0.15s, border-color 0.15s;
}

[data-theme="comic book"] button:hover,
[data-theme="comic book"] button:focus,
[data-theme="comic book"] input[type="button"]:hover,
[data-theme="comic book"] input[type="button"]:focus,
[data-theme="comic book"] input[type="submit"]:hover,
[data-theme="comic book"] input[type="submit"]:focus {
  background-color: yellow;
  color: var(--primary);
  border-color: var(--secondary);
  box-shadow: 0 0 0 4px var(--highlight);
}

/* Speech bubble effect for tooltips */
[data-theme="comic book"] [role="tooltip"], 
[data-theme="comic book"] .tooltip {
  background: #66d;
  color: var(--primary);
  border: 4px solid var(--secondary);
  border-radius: 14px;
  font-family: var(--font-family);
  font-weight: 900;
  font-size: 12px;
  padding: 0.7em 1em;
  box-shadow: 0 2px 10px 0 #1a1a1a;
  position: relative;
}
[data-theme="comic book"] [role="tooltip"]:after, 
[data-theme="comic book"] .tooltip:after {
  content: "";
  position: absolute;
  left: 20px;
  bottom: -15px;
  width: 0; 
  height: 0; 
  border-left: 10px solid transparent;
  border-right: 10px solid transparent;
  border-top: 15px solid #fff;
  filter: drop-shadow(0 2px 0 #1a1a1a);
}
[data-theme="comic book"] #editor > * {
  text-shadow: none;
  font-family: Bangers, 'Comic Sans MS', 'Comic Sans', Impact, fantasy, sans-serif;
  
}
    
/* Comic-style links */
[data-theme="comic book"] a {
  color: var(--secondary);
  font-weight: 900;
  text-decoration: underline wavy var(--primary) 2px;
  text-shadow: 1px 1px 0 #fff, 1.5px 1.5px 0 #1a1a1a;
  transition: color 0.15s;
}
[data-theme="comic book"] a:hover,
[data-theme="comic book"] a:focus {
  color: var(--accent);
  text-decoration-color: var(--secondary);
}

/* Add comic halftone dot overlay to dropdown */
[data-theme="comic book"] select {
  position: relative;
  z-index: 1;
  background-blend-mode: multiply;
  background-image:
    radial-gradient(circle at 80% 30%, #fffbe5 7%, transparent 12%),
    repeating-radial-gradient(circle, #11e500 1px, transparent 2px, transparent 10px);
}

/* Hide scrollbars for a cleaner comic look */
[data-theme="comic book"] #editor::-webkit-scrollbar {
  width: 10px;
  background: var(--muted);
}
[data-theme="comic book"] #editor::-webkit-scrollbar-thumb {
  background: var(--primary);
  border-radius: 8px;
}
[data-theme="comic book"] #editor::-webkit-scrollbar-thumb:hover {
  background: var(--secondary);
}


    
  @keyframes scifi-holographic {
    0% { background-position: 0% 0%; }
    50% { background-position: 100% 100%; }
    100% { background-position: 0% 0%; }
  }
  
  [data-theme="scifi"] input:focus, 
  [data-theme="scifi"] select:focus, 
  [data-theme="scifi"] textarea:focus,
  [data-theme="scifi"] #editor {
    box-shadow: 0 0 5px var(--primary), 0 0 10px var(--primary);
  }
  
  [data-theme="scifi"] .book {
    transform-style: preserve-3d;
  }
  
  [data-theme="scifi"] .book-cover {
    background: linear-gradient(135deg, var(--card-bg) 0%, var(--sidebar-bg) 100%);
    border: 1px solid var(--primary);
    box-shadow: 0 0 15px rgba(80, 250, 123, 0.3);
  }
  
  /* Horror Theme Effects */
  [data-theme="horror"] .chapter-item,
  [data-theme="horror"] .character-item,
  [data-theme="horror"] .lore-item,
  [data-theme="horror"] h1,
  [data-theme="horror"] h2,
  [data-theme="horror"] h3,
  [data-theme="horror"] button {
    position: relative;
  }
  
  [data-theme="horror"] .chapter-item::before,
  [data-theme="horror"] .character-item::before,
  [data-theme="horror"] .lore-item::before,
  [data-theme="horror"] h1::before,
  [data-theme="horror"] h2::before,
  [data-theme="horror"] h3::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 5px;
    background: var(--text);
    clip-path: polygon(
      0% 0%, 5% 100%, 10% 0%, 15% 70%, 20% 0%, 25% 100%, 30% 0%, 
      35% 90%, 40% 0%, 45% 50%, 50% 0%, 55% 80%, 60% 0%, 65% 40%, 
      70% 0%, 75% 60%, 80% 0%, 85% 100%, 90% 0%, 95% 70%, 100% 0%
    );
    z-index: 1;
  }
  
  [data-theme="horror"] button,
  [data-theme="horror"] .book-title,
  [data-theme="horror"] h1, 
  [data-theme="horror"] h2, 
  [data-theme="horror"] h3 {
    animation: horror-flicker 5s linear infinite;
  }
  
  @keyframes horror-flicker {
    0%, 19.999%, 22%, 62.999%, 64%, 64.999%, 70%, 100% {
      opacity: 1;
    }
    20%, 21.999%, 63%, 63.999%, 65%, 69.999% {
      opacity: 0.5;
    }
  }
  
  [data-theme="horror"] button, 
  [data-theme="horror"] input, 
  [data-theme="horror"] select,
  [data-theme="horror"] .chapter-title,
  [data-theme="horror"] .character-title,
  [data-theme="horror"] .lore-title {
    filter: blur(0.3px);
    letter-spacing: 1px;
  }
  
  [data-theme="horror"] #editor::after {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: repeating-linear-gradient(
      0deg,
      rgba(170, 0, 0, 0.03) 0px,
      rgba(170, 0, 0, 0.03) 1px,
      transparent 1px,
      transparent 2px
    );
    pointer-events: none;
    z-index: 1;
  }
  
  [data-theme="horror"] .book-cover {
    background: linear-gradient(135deg, var(--card-bg) 0%, var(--sidebar-bg) 100%);
    border: 1px solid var(--danger);
    box-shadow: 0 0 15px rgba(170, 0, 0, 0.5);
  }
  
  [data-theme="horror"] .book-cover::after {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(to bottom, transparent 95%, rgba(170, 0, 0, 0.8) 100%);
    pointer-events: none;
    opacity: 0.5;
  }
  
  /* Draggable items styling */
  .chapter-item.dragging, .character-item.dragging, .lore-item.dragging {
    opacity: 0.5;
    border: 2px dashed var(--primary);
  }
  
  .chapter-item.drop-above, .character-item.drop-above, .lore-item.drop-above {
    border-top: 2px solid var(--primary);
  }
  
  .chapter-item.drop-below, .character-item.drop-below, .lore-item.drop-below {
    border-bottom: 2px solid var(--primary);
  }
  
  .drag-handle {
    cursor: grab;
    color: var(--text-light);
    margin-right: 5px;
    user-select: none;
  }
  
  .drag-handle:hover {
    color: var(--primary);
  }
  
  /* Always hide body scrollbar when editorContainer is visible */
  body {
    overflow: auto;
  }
  
  /* Underwater theme bubble effects */
  [data-theme="underwater"] .book {
    overflow: visible;
  }
  
  [data-theme="underwater"] .book::before {
    content: "";
    position: absolute;
    width: 15px;
    height: 15px;
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.2);
    left: -20px;
    top: 40%;
    animation: underwater-bubble 8s ease-in infinite;
    z-index: 5;
  }
  
  [data-theme="underwater"] .book::after {
    content: "";
    position: absolute;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.15);
    left: -15px;
    top: 60%;
    animation: underwater-bubble 10s ease-in 1s infinite;
    z-index: 5;
  }
  
  @keyframes underwater-bubble {
    0% {
      transform: translateY(0) translateX(0) scale(0.5);
      opacity: 0;
    }
    10% {
      transform: translateY(-10px) translateX(5px) scale(0.8);
      opacity: 0.8;
    }
    40% {
      transform: translateY(-30px) translateX(10px) scale(1);
      opacity: 0.6;
    }
    70% {
      transform: translateY(-70px) translateX(15px) scale(1.2);
      opacity: 0.4;
    }
    100% {
      transform: translateY(-100px) translateX(20px) scale(0.8);
      opacity: 0;
    }
  }
  
  /* Underwater theme seaweed effect for lists */
  [data-theme="underwater"] ul {
    position: relative;
  }
  
  [data-theme="underwater"] ul::before {
    content: "";
    position: absolute;
    left: -15px;
    top: 0;
    bottom: 0;
    width: 5px;
    background: var(--secondary);
    mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='5' height='100' viewBox='0 0 5 100'%3E%3Cpath d='M0,0 Q5,10 0,20 Q5,30 0,40 Q5,50 0,60 Q5,70 0,80 Q5,90 0,100' stroke='%2320b2aa' stroke-width='2' fill='none'/%3E%3C/svg%3E");
    mask-size: cover;
    animation: underwater-seaweed 5s ease-in-out infinite;
    opacity: 0.3;
  }


    
  @keyframes underwater-seaweed {
    0%, 100% { transform: translateX(0); }
    50% { transform: translateX(3px); }
  }
    @keyframes twinkling {
      0% { opacity: 0.1; }
      50% { opacity: 1; }
      100% { opacity: 0.1; }
    }
    
    @keyframes floatingStars {
      0% { transform: translateY(0) translateX(0); }
      25% { transform: translateY(-5px) translateX(3px); }
      50% { transform: translateY(0) translateX(0); }
      75% { transform: translateY(5px) translateX(-3px); }
      100% { transform: translateY(0) translateX(0); }
    }
    
    @keyframes nebulaPulse {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    @keyframes galaxyRotate {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @keyframes cosmic-glow {
      0% { box-shadow: 0 0 5px rgba(111, 0, 255, 0.5), 0 0 10px rgba(0, 174, 255, 0.3); }
      50% { box-shadow: 0 0 10px rgba(111, 0, 255, 0.8), 0 0 20px rgba(0, 174, 255, 0.6); }
      100% { box-shadow: 0 0 5px rgba(111, 0, 255, 0.5), 0 0 10px rgba(0, 174, 255, 0.3); }
    }

    .star {
      position: absolute;
      background-color: white;
      border-radius: 50%;
      animation: twinkling 4s infinite;
    }
    
    .star.sm {
      width: 1px;
      height: 1px;
      opacity: 0.8;
    }
    
    .star.md {
      width: 2px;
      height: 2px;
      opacity: 0.9;
    }
    
    .star.lg {
      width: 3px;
      height: 3px;
      opacity: 1;
    }

    /* Create a starfield overlay for galaxy theme */
    .starfield-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10;
    }
    
    /* Galaxy theme specific styles */
    [data-theme="galaxy"] {
      --background: #0a0821;
      --card-bg: #1a1135;
      --sidebar-bg: #13082f;
      --toolbar-bg: #241445;
      --menu-bg: #1a1135;
      --primary: linear-gradient(135deg, #9c27b0, #3949ab);
      --secondary: linear-gradient(135deg, #673ab7, #1976d2);
      --danger: #ff416c;
      --text: #e0e0ff;
      --text-light: #a0a0d0;
      --border: #4e379a;
      --shadow: rgba(0, 0, 0, 0.35);
      --input-bg: rgba(18, 10, 40, 0.8);
      --input-border: #4e379a;
      --editor-bg: #120a28;
      --modal-overlay: rgba(13, 7, 33, 0.8);
      --hover-bg: rgba(111, 0, 255, 0.1);
      
      background: var(--background);
      color: var(--text);
      transition: all 0.3s ease;
      font-family: 'Orbitron', sans-serif;
    }
    
    [data-theme="galaxy"] #novelApp {
      position: relative;
      background: linear-gradient(to bottom, #0a0821, #1a0e3b, #0a0821);
    }
    
    [data-theme="galaxy"] #sidebar {
      background-image: linear-gradient(to bottom, #13082f, #1a0e3b);
      border-right: 1px solid rgba(111, 0, 255, 0.3);
      animation: nebulaPulse 15s ease infinite;
      position: relative;
    }
    
    [data-theme="galaxy"] #sidebar::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: 
        radial-gradient(circle at 20% 30%, rgba(111, 0, 255, 0.3) 0%, transparent 30%),
        radial-gradient(circle at 80% 70%, rgba(0, 174, 255, 0.3) 0%, transparent 30%);
      opacity: 0.5;
      pointer-events: none;
    }
    
    [data-theme="galaxy"] .sidebar-header img {
      filter: drop-shadow(0 0 8px rgba(111, 0, 255, 0.8));
    }
    
    [data-theme="galaxy"] #chapterList li,
    [data-theme="galaxy"] #characterList li,
    [data-theme="galaxy"] #loreList li {
      background: rgba(26, 14, 59, 0.7);
      border: 1px solid rgba(111, 0, 255, 0.3);
      margin-bottom: 8px;
      border-radius: 8px;
      padding: 8px 12px;
      transition: all 0.3s ease;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
      animation: cosmic-glow 3s infinite;
      list-style-type: none;
    }
    
    [data-theme="galaxy"] #chapterList li:hover,
    [data-theme="galaxy"] #characterList li:hover,
    [data-theme="galaxy"] #loreList li:hover {
      background: rgba(38, 20, 87, 0.9);
      transform: translateY(-2px);
      box-shadow: 0 0 15px rgba(111, 0, 255, 0.4);
    }
    
    [data-theme="galaxy"] #chapterList li a,
    [data-theme="galaxy"] #characterList li a,
    [data-theme="galaxy"] #loreList li a {
      color: var(--text);
      text-decoration: none;
      display: block;
    }
    
    [data-theme="galaxy"] #menuBtn,
    [data-theme="galaxy"] #showNovelListBtn,
    [data-theme="galaxy"] #addChapterBtn,
    [data-theme="galaxy"] #addCharacterBtn,
    [data-theme="galaxy"] #addLoreBtn,
    [data-theme="galaxy"] #timelinebtn,
    [data-theme="galaxy"] #addNovelBtn,
    [data-theme="galaxy"] #AIgen,
    [data-theme="galaxy"] #timerBtn,
    [data-theme="galaxy"] .submit-btn,
    [data-theme="galaxy"] #toggleExportBtn,
    [data-theme="galaxy"] #toggleSidebarBtn {
      background: var(--primary);
      border-radius: 8px;
      border: none;
      box-shadow: 0 0 15px rgba(111, 0, 255, 0.3);
      transition: all 0.3s ease;
      animation: cosmic-glow 3s infinite;
    }
    
    [data-theme="galaxy"] #menuBtn:hover,
    [data-theme="galaxy"] #showNovelListBtn:hover,
    [data-theme="galaxy"] #addChapterBtn:hover,
    [data-theme="galaxy"] #addCharacterBtn:hover,
    [data-theme="galaxy"] #addLoreBtn:hover,
    [data-theme="galaxy"] #timelinebtn:hover,
    [data-theme="galaxy"] #addNovelBtn:hover,
    [data-theme="galaxy"] #AIgen:hover,
    [data-theme="galaxy"] #timerBtn:hover,
    [data-theme="galaxy"] .submit-btn:hover,
    [data-theme="galaxy"] #toggleExportBtn:hover,
    [data-theme="galaxy"] #toggleSidebarBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 20px rgba(111, 0, 255, 0.5);
    }
    
    [data-theme="galaxy"] #editor {
      background: linear-gradient(to bottom, #120a28, #1a0e3b);
      border: 1px solid var(--border);
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
      animation: nebulaPulse 20s ease infinite;
      background-size: 400% 400%;
    }
    
    [data-theme="galaxy"] .toolbar-button,
    [data-theme="galaxy"] #formatSelect,
    [data-theme="galaxy"] #fontSelect,
    [data-theme="galaxy"] #sizeSelect,
    [data-theme="galaxy"] .form-input,
    [data-theme="galaxy"] .form-textarea {
      background-color: rgba(18, 10, 40, 0.8);
      border: 1px solid rgba(111, 0, 255, 0.5);
      box-shadow: 0 0 5px rgba(111, 0, 255, 0.3);
      color: #e0e0ff;
      border-radius: 4px;
      transition: all 0.3s ease;
    }
    
    [data-theme="galaxy"] .toolbar-button:hover,
    [data-theme="galaxy"] #formatSelect:hover,
    [data-theme="galaxy"] #fontSelect:hover,
    [data-theme="galaxy"] #sizeSelect:hover,
    [data-theme="galaxy"] .form-input:focus,
    [data-theme="galaxy"] .form-textarea:focus {
      border-color: rgba(111, 0, 255, 0.8);
      box-shadow: 0 0 10px rgba(111, 0, 255, 0.5);
    }
    
    [data-theme="galaxy"] #toolbar {
      background: linear-gradient(135deg, #241445, #1a0e3b);
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
    }

    [data-theme="galaxy"] #novelListContainer,
    [data-theme="galaxy"] #editorContainer,
    [data-theme="galaxy"] #characterEditorContainer,
    [data-theme="galaxy"] #loreEditorContainer,
    [data-theme="galaxy"] #novelEditorContainer,
    [data-theme="galaxy"] #timelineContainer {
      background: linear-gradient(to bottom, #0a0821, #120a38);
    }
    
    [data-theme="galaxy"] .editor-content,
    [data-theme="galaxy"] #timelineDisplay {
      background: linear-gradient(to bottom, #1a1135, #241445);
      border: 1px solid var(--border);
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
    }
    
    [data-theme="galaxy"] .editor-header,
    [data-theme="galaxy"] .timeline-header {
      background: linear-gradient(135deg, #241445, #1a0e3b);
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
    }
    
    [data-theme="galaxy"] .modal-content,
    [data-theme="galaxy"] .summary-content,
    [data-theme="galaxy"] .timer-content,
    [data-theme="galaxy"] .timeline-event-content,
    [data-theme="galaxy"] .timeline-settings-content,
    [data-theme="galaxy"] .color-modal-content {
      background: linear-gradient(to bottom, #1a1135, #241445);
      border-radius: 15px;
      box-shadow: 0 0 25px rgba(0, 0, 0, 0.5), 0 0 40px rgba(111, 0, 255, 0.2);
      border: 1px solid rgba(111, 0, 255, 0.3);
    }
    
    [data-theme="galaxy"] h1,
    [data-theme="galaxy"] h2,
    [data-theme="galaxy"] h3,
    [data-theme="galaxy"] h4,
    [data-theme="galaxy"] .modal-title {
      background: linear-gradient(to right, #e0e0ff, #a0a0ff);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 15px;
    }
    
    #novelApp {
      max-width: 1200px;
      margin: 0 auto;
      text-align: left;
    }
    #mainContent {
      display: flex;
      flex-direction: column;
      min-height: calc(100vh - 110px);
    }
    #mainContent > div:first-child {
      display: flex;
      flex-direction: row;
      flex: 1;
      height: calc(100vh - 120px);
    }
    #sidebar {
      width: 250px;
      background: var(--sidebar-bg);
      border-right: 1px solid var(--border);
      padding: 10px;
      overflow-y: scroll;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    .sidebar-header {
      margin-bottom: 15px;
      text-align: center;
    }
    .sidebar-header img {
      margin-bottom: 10px;
    }
    #menuContainer {
      position: relative;
    }
    #menuBtn {
      width: 100%;
      background: var(--primary);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 18px;
    }
    #menuDropdown {
      display: none;
      position: absolute;
      right: 0;
      top: 100%;
      background-color: var(--menu-bg);
      width: 100%;
      box-shadow: 0px 8px 16px 0px var(--shadow);
      z-index: 1000;
      border-radius: 4px;
      margin-top: 5px;
    }
    #backupbtn, #importbtn, #exportNovel {
      color: var(--text);
      padding: 12px 16px;
      text-decoration: none;
      display: block;
      text-align: left;
    }
    #importbtn {
      border-top: 1px solid var(--border);
    }
    .menu-select-container {
      padding: 12px 16px;
      border-top: 1px solid var(--border);
    }
    #themeSelect {
      width: 100%;
      padding: 5px;
      background: var(--input-bg);
      color: var(--text);
      border: 1px solid var(--input-border);
      border-radius: 4px;
    }
    .novel-btn-container {
      margin-bottom: 10px;
    }
    #showNovelListBtn {
      width: 100%;
      padding: 8px;
      background: var(--secondary);
      color: white;
      border: none;
      border-radius: 4px;
    }
    .chapter-header, .character-header, .lore-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .chapter-header h4, .character-header h4, .lore-header h4 {
      margin: 0;
      color: var(--text);
    }
    .character-header, .lore-header {
      margin-top: 20px;
    }
    #toggleChapters, #toggleCharacters, #toggleLore {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      color: var(--text);
    }
    #addChapterBtn, #addCharacterBtn, #addLoreBtn {
      width: 100%;
      margin-bottom: 10px;
      padding: 8px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 4px;
    }
    #chapterList, #characterList, #loreList {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #timelineListContainer {
      margin-top: 10px;
    }
    #timelinebtn {
      width: 100%;
      margin-bottom: 10px;
      margin-top: 10px;
      padding: 8px;
      background: var(--secondary);
      color: white;
      border: none;
      border-radius: 4px;
    }
    #novelListContainer {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
      background: var(--background);
    }
    #novelListContainer h2 {
      color: var(--text);
    }
    #addNovelBtn {
      width: 200px;
      margin-bottom: 20px;
      padding: 8px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 4px;
    }
    #novelList {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }
    #editorContainer {
      flex: 1;
      height: 100vh;
      max-height: 100vh;
      display: none;
      flex-direction: column;
      padding: 10px;
      background: var(--background);
      position: sticky;
      top: 0;
      z-index: 100;
      overflow: hidden;
    }
    #toolbar {
      padding: 10px;
      background: var(--toolbar-bg);
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      align-items: center;
      margin-bottom: 10px;
      border-radius: 4px;
    }
    #formatSelect, #fontSelect, #sizeSelect {
      padding: 5px;
      background: var(--input-bg);
      color: var(--text);
      border: 1px solid var(--input-border);
      border-radius: 4px;
    }
    .toolbar-separator {
      border-left: 1px solid var(--border);
      height: 24px;
      margin: 0 5px;
    }
    .toolbar-button {
      padding: 5px;
      min-width: 30px;
      background: var(--input-bg);
      color: var(--text);
      border: 1px solid var(--input-border);
      border-radius: 4px;
    }
    #AIgen {
      padding: 5px 10px;
      background: var(--primary);
      color: white;
      border: 1px solid var(--input-border);
      border-radius: 4px;
      font-weight: bold;
    }
    #timerBtn {
      padding: 5px 10px;
      background: var(--secondary);
      color: white;
      border: 1px solid var(--input-border);
      border-radius: 4px;
      font-weight: bold;
    }
    #editor {
      flex: 1;
      border: 1px solid var(--border);
      padding: 15px;
      overflow-y: auto;
      background: var(--editor-bg);
      border-radius: 4px;
      line-height: 1.6;
      color: var(--text);
      position: relative;
    }
    #WCdiv {
      margin-top: 10px;
      color: var(--text-light);
      font-size: 0.9rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .word-count-container {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    #timerDisplay {
      display: none;
    }
    #cancelTimerBtn {
      background: none;
      border: none;
      color: var(--text-light);
      margin-left: 5px;
      cursor: pointer;
      font-size: 12px;
      padding: 0;
    }
    .export-container {
      display: flex;
      gap: 10px;
    }
    .export-menu-container {
      position: relative;
    }
    #exportMenuItems {
      position: absolute;
      bottom: 100%;
      right: 0;
      margin-bottom: 5px;
      display: none;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      box-shadow: 0 2px 5px var(--shadow);
      overflow: hidden;
      width: 150px;
      z-index: 100;
    }
    .export-btn {
      padding: 8px 12px;
      background: var(--card-bg);
      color: var(--text);
      border: none;
      border-radius: 0;
      font-size: 0.8rem;
      display: block;
      width: 100%;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    #exportTxtBtn {
      border-bottom: none;
    }
    #toggleExportBtn {
      padding: 5px 8px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 0.8rem;
    }
    #toggleSidebarBtn {
      padding: 5px 8px;
      background: var(--secondary);
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 0.8rem;
    }
    #characterEditorContainer {
      flex: 1;
      display: none;
      flex-direction: column;
      padding: 10px;
      background: var(--background);
    }
    .editor-header {
      padding: 10px;
      background: var(--toolbar-bg);
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: 4px;
    }
    #characterEditTitle {
      margin: 0;
      color: var(--text);
    }
    #closeCharacterBtn {
      padding: 5px 10px;
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 4px;
    }
    .editor-content {
      flex: 1;
      overflow-y: auto;
      border: 1px solid var(--border);
      padding: 15px;
      background: var(--card-bg);
      border-radius: 4px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: var(--text);
    }
    #addCharacterImageBtn {
      padding: 5px 10px;
      background: var(--secondary);
      color: white;
      border: none;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    #charImagesContainer {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .form-input {
      width: 100%;
      padding: 8px;
      background: var(--input-bg);
      color: var(--text);
      border: 1px solid var(--input-border);
      border-radius: 4px;
    }
    .physical-appearance {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .physical-input {
      flex: 1;
      min-width: 150px;
      padding: 8px;
      background: var(--input-bg);
      color: var(--text);
      border: 1px solid var(--input-border);
      border-radius: 4px;
    }
    .form-textarea {
      width: 100%;
      padding: 8px;
      background: var(--input-bg);
      color: var(--text);
      border: 1px solid var(--input-border);
      border-radius: 4px;
      height: 100px;
    }
    .form-submit {
      text-align: right;
    }
    .submit-btn {
      padding: 10px 15px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 4px;
      font-weight: bold;
    }
    #loreEditorContainer {
      flex: 1;
      display: none;
      flex-direction: column;
      padding: 10px;
      background: var(--background);
    }
    #loreEditTitle {
      margin: 0;
      color: var(--text);
    }
    #closeLoreBtn {
      padding: 5px 10px;
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 4px;
    }
    #addLoreImageBtn {
      padding: 5px 10px;
      background: var(--secondary);
      color: white;
      border: none;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    #loreImagesContainer {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    #customCategoryContainer {
      display: none;
      margin-bottom: 15px;
    }
    .category-fields {
      display: none;
    }
    .category-fields h4 {
      margin-top: 20px;
      margin-bottom: 10px;
      color: var(--text);
    }
    #novelEditorContainer {
      flex: 1;
      display: none;
      flex-direction: column;
      padding: 10px;
      background: var(--background);
    }
    #novelEditTitle {
      margin: 0;
      color: var(--text);
    }
    #closeNovelEditorBtn {
      padding: 5px 10px;
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 4px;
    }
    #novelCoverPreviewContainer {
      width: 150px;
      height: 200px;
      border: 1px dashed var(--border);
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      background: var(--input-bg);
    }
    #novelCoverPreview {
      max-width: 100%;
      max-height: 100%;
      display: none;
    }
    #coverUploadPrompt {
      color: var(--text-light);
    }
    #uploadCoverBtn {
      padding: 5px 10px;
      background: var(--secondary);
      color: white;
      border: none;
      border-radius: 4px;
      margin-bottom: 5px;
    }
    #removeCoverBtn {
      padding: 5px 10px;
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 4px;
      display: none;
    }
    .form-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }
    .form-col {
      flex: 1;
    }
    #timelineContainer {
      position: sticky;
      top: 0;
      flex: 1;
      display: none;
      flex-direction: column;
      padding: 10px;
      background: var(--background);
      height: 100vh;
      overflow-y: auto;
    }
    .timeline-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .timeline-header h2 {
      margin: 0;
      color: var(--text);
    }
    .timeline-controls {
      display: flex;
      gap: 10px;
    }
    #timelineSettingsBtn {
      padding: 5px 10px;
      background: var(--secondary);
      color: white;
      border: none;
      border-radius: 4px;
    }
    #addTimelineEventBtn {
      padding: 5px 10px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 4px;
    }
    #timelineViewMode {
      padding: 5px;
      background: var(--input-bg);
      color: var(--text);
      border: 1px solid var(--input-border);
      border-radius: 4px;
    }
    #closeTimelineBtn {
      padding: 5px 10px;
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 4px;
    }
    #timelineDisplay {
      flex: 1;
      border: 1px solid var(--border);
      padding: 15px;
      background: var(--card-bg);
      border-radius: 4px;
      overflow: auto;
    }
    #horizontalTimeline {
      display: none;
      min-width: max-content;
      position: relative;
      padding: 20px 0;
    }
    .horizontal-timeline-axis {
      height: 2px;
      background: var(--border);
      width: 100%;
      position: relative;
    }
    #verticalTimeline {
      position: relative;
      padding: 0 20px;
      min-height: 500px;
    }
    .vertical-timeline-axis {
      width: 2px;
      background: var(--border);
      height: 100%;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
    }
    #imageModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: var(--modal-overlay);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: var(--card-bg);
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      padding: 20px;
      box-shadow: 0 0 20px var(--shadow);
    }
    .modal-title {
      margin-top: 0;
      margin-bottom: 15px;
      color: var(--text);
    }
    .tab-buttons {
      display: flex;
      margin-bottom: 10px;
    }
    #urlTabBtn {
      flex: 1;
      padding: 8px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 4px 0 0 4px;
      font-weight: bold;
    }
    #uploadTabBtn {
      flex: 1;
      padding: 8px;
      background: var(--toolbar-bg);
      color: var(--text);
      border: none;
      border-radius: 0 4px 4px 0;
    }
    .input-field {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      background: var(--input-bg);
      color: var(--text);
      border: 1px solid var(--input-border);
      border-radius: 4px;
    }
    #uploadTab {
      display: none;
    }
    #imagePreview {
      display: none;
      margin-bottom: 10px;
      text-align: center;
    }
    #previewImg {
      max-width: 100%;
      max-height: 200px;
      border: 1px solid var(--border);
    }
    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    .cancel-btn {
      padding: 8px 12px;
      background: var(--toolbar-bg);
      color: var(--text);
      border: none;
      border-radius: 4px;
    }
    .insert-btn {
      padding: 8px 12px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 4px;
    }
    #specialCharModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: var(--modal-overlay);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .special-char-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    .special-char-btn {
      padding: 5px;
      min-width: 30px;
      background: var(--input-bg);
      color: var(--text);
      border: 1px solid var(--input-border);
      border-radius: 4px;
    }
    #textColorModal, #bgColorModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: var(--modal-overlay);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .color-modal-content {
      background: var(--card-bg);
      border-radius: 8px;
      width: 90%;
      max-width: 300px;
      padding: 20px;
      box-shadow: 0 0 20px var(--shadow);
    }
    .color-picker {
      width: 100%;
      height: 40px;
      margin-bottom: 10px;
    }
    .apply-color-btn {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 4px;
    }
    .unset-color-btn {
      width: 100%;
      padding: 8px;
      background: var(--secondary);
      color: white;
      border: none;
      border-radius: 4px;
    }
    #imageEditingToolbar {
      display: none;
      position: absolute;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      box-shadow: 0 2px 10px var(--shadow);
      padding: 8px;
      z-index: 100;
    }
    .image-toolbar-group {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    .toolbar-label {
      margin-right: 8px;
      font-size: 12px;
      color: var(--text);
    }
    #imageSizeSelect {
      padding: 4px;
      font-size: 12px;
      background: var(--input-bg);
      color: var(--text);
      border: 1px solid var(--input-border);
      border-radius: 4px;
    }
    #customSizeControls {
      display: none;
      margin-left: 8px;
    }
    .size-input {
      width: 50px;
      font-size: 12px;
      padding: 4px;
      background: var(--input-bg);
      color: var(--text);
      border: 1px solid var(--input-border);
      border-radius: 4px;
    }
    .size-separator {
      margin: 0 4px;
      color: var(--text);
    }
    #applyCustomSizeBtn {
      margin-left: 4px;
      padding: 4px;
      font-size: 12px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 4px;
    }
    .image-align-btn {
      padding: 4px 8px;
      font-size: 12px;
      background: var(--input-bg);
      color: var(--text);
      border: 1px solid var(--input-border);
      border-radius: 4px;
    }
    #imageBorderColor {
      width: 24px;
      height: 24px;
    }
    #imageBorderWidth {
      width: 40px;
      font-size: 12px;
      padding: 4px;
      margin: 0 8px;
      background: var(--input-bg);
      color: var(--text);
      border: 1px solid var(--input-border);
      border-radius: 4px;
    }
    #applyImageBorderBtn {
      padding: 4px 8px;
      font-size: 12px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 4px;
    }
    #imagePadding {
      width: 40px;
      font-size: 12px;
      padding: 4px;
      background: var(--input-bg);
      color: var(--text);
      border: 1px solid var(--input-border);
      border-radius: 4px;
    }
    #applyImagePaddingBtn {
      padding: 4px 8px;
      margin-left: 8px;
      font-size: 12px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 4px;
    }
    #imageAltText {
      flex: 1;
      font-size: 12px;
      padding: 4px;
      background: var(--input-bg);
      color: var(--text);
      border: 1px solid var(--input-border);
      border-radius: 4px;
    }
    #applyImageAltBtn {
      padding: 4px 8px;
      margin-left: 8px;
      font-size: 12px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 4px;
    }
    .image-toolbar-footer {
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
    }
    #removeImageBtn {
      padding: 4px 8px;
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 12px;
    }
    #closeImageEditingToolbarBtn {
      padding: 4px 8px;
      background: var(--toolbar-bg);
      color: var(--text);
      border: none;
      border-radius: 4px;
      font-size: 12px;
    }
    #characterImagePreviewModal, #loreImagePreviewModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: var(--modal-overlay);
      z-index: 1100;
      justify-content: center;
      align-items: center;
    }
    .preview-container {
      position: relative;
      max-width: 90%;
      max-height: 90%;
    }
    .close-preview-btn {
      position: absolute;
      top: -40px;
      right: 0;
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
    }
    #fullSizeCharacterImage, #fullSizeLoreImage {
      max-width: 100%;
      max-height: 90vh;
      border: 2px solid var(--border);
    }
    #summaryModal, #timerModal, #timelineEventModal, #timelineSettingsModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: var(--modal-overlay);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .summary-content {
      background: var(--card-bg);
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      padding: 20px;
      box-shadow: 0 0 20px var(--shadow);
    }
    #summaryTextarea {
      width: 100%;
      height: 200px;
      padding: 10px;
      background: var(--input-bg);
      color: var(--text);
      border: 1px solid var(--input-border);
      border-radius: 4px;
    }
    .summary-buttons {
      display: flex;
      justify-content: space-between;
    }
    #generateSummaryBtn {
      padding: 8px 12px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 4px;
    }
    .timer-content {
      background: var(--card-bg);
      border-radius: 8px;
      width: 90%;
      max-width: 300px;
      padding: 20px;
      box-shadow: 0 0 20px var(--shadow);
    }
    .timer-input {
      display: flex;
      justify-content: center;
      margin-bottom: 15px;
    }
    #timerMinutes {
      width: 70px;
      padding: 8px;
      text-align: center;
      background: var(--input-bg);
      color: var(--text);
      border: 1px solid var(--input-border);
      border-radius: 4px;
      font-size: 18px;
    }
    .timer-label {
      margin: 0 10px;
      font-size: 18px;
      line-height: 42px;
      color: var(--text);
    }
    #startTimerBtn {
      width: 100%;
      padding: 8px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 4px;
      font-weight: bold;
    }
    .timeline-event-content {
      background: var(--card-bg);
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      padding: 20px;
      box-shadow: 0 0 20px var(--shadow);
    }
    .timeline-settings-content {
      background: var(--card-bg);
      border-radius: 8px;
      width: 90%;
      max-width: 700px;
      padding: 20px;
      box-shadow: 0 0 20px var(--shadow);
      max-height: 90vh;
      overflow-y: auto;
    }
    .settings-section {
      margin-bottom: 20px;
      border: 1px solid var(--border);
      padding: 15px;
      border-radius: 4px;
    }
    .settings-section h4 {
      margin-top: 0;
      margin-bottom: 10px;
      color: var(--text);
    }
    #numMonths, #numDaysInWeek {
      width: 100px;
      padding: 8px;
      background: var(--input-bg);
      color: var(--text);
      border: 1px solid var(--input-border);
      border-radius: 4px;
    }
    #importFile {
      display: none;
    }
  </style>
  <div id="mainContent">
    <div>
      <div id="sidebar">
        <div class="starfield-overlay" id="sidebarStars"></div>
        <!-- Header image and menu relocated to top of sidebar -->
        <div class="sidebar-header">
          <img src="https://user-uploads.perchance.org/file/4044a9d1c0c27ccd58f0ed5c61694b06.png" width="230px">
          <div id="menuContainer">
            <button id="menuBtn">
              ☰
            </button>
            <div id="menuDropdown">
                <a id="exportNovel" href="#" onclick="openWordExportDialog()" style="text-decoration: none; text-align: left; width: 100%;">
    Export Novel</a>
              <a id="backupbtn" href="#">Backup Data</a>
              <a id="importbtn" href="#">Import Data</a>
              <div class="menu-select-container">
                <select id="themeSelect">
                  <option value="comic book">Comic Book</option>
                  <option value="cyberpunk">Cyberpunk</option>
                  <option value="dark">Dark Mode</option>
                  <option value="fantasy">Fantasy</option>
                  <option value="galaxy">Galaxy</option>
                  <option value="gothic">Gothic</option>
                  <option value="horror">Horror</option>
                  <option value="light">Light Mode</option>
                  <option value="mystery">Mystery</option>
                  <option value="scifi">Sci-Fi</option>
                  <option value="suspense">Suspense</option>
                  <option value="underwater">Underwater</option>
                </select>
              </div>
            </div>
          </div>
        </div>

<div id="wordExportDialog" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; z-index:9999; background:rgba(0,0,0,0.35);">
  <div style="background: var(--background); border-radius:10px; max-width:400px; margin:7vh auto; padding:2em; box-shadow:0 10px 40px #0002;">
    <h2>Export Document</h2>
    <form id="wordExportForm" onsubmit="event.preventDefault(); exportNovelToWord();">
      <label><input type="checkbox" name="exportChapters" checked> All Chapters</label><br>
      <label><input type="checkbox" name="exportCharacters" checked> All Characters</label><br>
      <label><input type="checkbox" name="exportLore" checked> All Lore Entries</label><br>
      <label><input type="checkbox" name="exportTimeline" checked> All Timeline Events</label><br>
      <div style="margin-top:1.5em;">
        <button type="submit" style="margin-right:1em;">Download Word Doc</button>
        <button type="button" onclick="closeWordExportDialog()">Cancel</button>
      </div>
    </form>
  </div>
</div>


        
        <div class="novel-btn-container">
          <button id="showNovelListBtn">My Novels</button>
        </div>
        <div class="chapter-header">
          <h4>Chapter List</h4>
          <button id="toggleChapters">▼</button>
        </div>
        <div id="chapterListContainer">
          <button id="addChapterBtn">+ Add Chapter</button>
          <ul id="chapterList"></ul>
        </div>
        
        <div class="character-header">
          <h4>Characters</h4>
          <button id="toggleCharacters">▼</button>
        </div>
        <div id="characterListContainer">
          <button id="addCharacterBtn">+ Add Character</button>
          <ul id="characterList"></ul>
        </div>
        
        <div class="lore-header">
          <h4>Lore</h4>
          <button id="toggleLore">▼</button>
        </div>
        <div id="loreListContainer">
          <button id="addLoreBtn">+ Add Lore Entry</button>
          <ul id="loreList"></ul>
        </div>
        
        <div id="timelineListContainer">
          <button id="timelinebtn">Open Timeline</button>
        </div>
      </div>

      <div id="novelListContainer">
        <div class="starfield-overlay" id="novelListStars"></div>
        <h2>My Novels</h2>
        <button id="addNovelBtn">+ Add Novel</button>
        <div id="novelList"></div>
      </div>

      <div id="editorContainer">
        <div class="starfield-overlay" id="editorStars"></div>
        <div id="toolbar">
          <!-- Text formatting options -->
          <select id="formatSelect">
            <option value="">Format</option>
            <option value="blockquote">Blockquote</option>
            <option value="pre">Code Block</option>
            <option value="h1">Heading 1</option>
            <option value="h2">Heading 2</option>
            <option value="h3">Heading 3</option>
            <option value="h4">Heading 4</option>
            <option value="p">Paragraph</option>
          </select>
          
          <select id="fontSelect">
            <option value="">Font</option>
            <!-- System Fonts -->
            <option value="Arial">Arial</option>
            <option value="Courier New">Courier New</option>
            <option value="Georgia">Georgia</option>
            <option value="Helvetica">Helvetica</option>
            <option value="Times New Roman">Times New Roman</option>
            <option value="Verdana">Verdana</option>
            
            <!-- Google Fonts - Sans-serif -->
            <optgroup label="Sans-serif">
              <option value="'Abel', sans-serif">Abel</option>
              <option value="'Albert Sans', sans-serif">Albert Sans</option>
              <option value="'Archivo', sans-serif">Archivo</option>
              <option value="'Asap', sans-serif">Asap</option>
              <option value="'Assistant', sans-serif">Assistant</option>
              <option value="'Athiti', sans-serif">Athiti</option>
              <option value="'Atkinson Hyperlegible', sans-serif">Atkinson Hyperlegible</option>
              <option value="'Barlow', sans-serif">Barlow</option>
              <option value="'Be Vietnam Pro', sans-serif">Be Vietnam Pro</option>
              <option value="'Cabin', sans-serif">Cabin</option>
              <option value="'Catamaran', sans-serif">Catamaran</option>
              <option value="'Comfortaa', sans-serif">Comfortaa</option>
              <option value="'Didact Gothic', sans-serif">Didact Gothic</option>
              <option value="'DM Sans', sans-serif">DM Sans</option>
              <option value="'Encode Sans', sans-serif">Encode Sans</option>
              <option value="'Epilogue', sans-serif">Epilogue</option>
              <option value="'Exo', sans-serif">Exo</option>
              <option value="'Figtree', sans-serif">Figtree</option>
              <option value="'Fira Sans', sans-serif">Fira Sans</option>
              <option value="'Fira Sans Condensed', sans-serif">Fira Sans Condensed</option>
              <option value="'Gudea', sans-serif">Gudea</option>
              <option value="'Heebo', sans-serif">Heebo</option>
              <option value="'Hind', sans-serif">Hind</option>
              <option value="'IBM Plex Sans', sans-serif">IBM Plex Sans</option>
              <option value="'Inter', sans-serif">Inter</option>
              <option value="'Jost', sans-serif">Jost</option>
              <option value="'Kanit', sans-serif">Kanit</option>
              <option value="'Karla', sans-serif">Karla</option>
              <option value="'Lato', sans-serif">Lato</option>
              <option value="'League Spartan', sans-serif">League Spartan</option>
              <option value="'Lexend', sans-serif">Lexend</option>
              <option value="'Manrope', sans-serif">Manrope</option>
              <option value="'Montserrat', sans-serif">Montserrat</option>
              <option value="'Mulish', sans-serif">Mulish</option>
              <option value="'Noto Sans', sans-serif">Noto Sans</option>
              <option value="'Noto Sans Display', sans-serif">Noto Sans Display</option>
              <option value="'Nunito', sans-serif">Nunito</option>
              <option value="'Nunito Sans', sans-serif">Nunito Sans</option>
              <option value="'Open Sans', sans-serif">Open Sans</option>
              <option value="'Oswald', sans-serif">Oswald</option>
              <option value="'Outfit', sans-serif">Outfit</option>
              <option value="'Overpass', sans-serif">Overpass</option>
              <option value="'Plus Jakarta Sans', sans-serif">Plus Jakarta Sans</option>
              <option value="'Poppins', sans-serif">Poppins</option>
              <option value="'PT Sans', sans-serif">PT Sans</option>
              <option value="'Public Sans', sans-serif">Public Sans</option>
              <option value="'Quicksand', sans-serif">Quicksand</option>
              <option value="'Raleway', sans-serif">Raleway</option>
              <option value="'Red Hat Display', sans-serif">Red Hat Display</option>
              <option value="'Red Hat Text', sans-serif">Red Hat Text</option>
              <option value="'Roboto', sans-serif">Roboto</option>
              <option value="'Roboto Condensed', sans-serif">Roboto Condensed</option>
              <option value="'Rubik', sans-serif">Rubik</option>
              <option value="'Signika Negative', sans-serif">Signika Negative</option>
              <option value="'Sora', sans-serif">Sora</option>
              <option value="'Source Sans Pro', sans-serif">Source Sans Pro</option>
              <option value="'Thasadith', sans-serif">Thasadith</option>
              <option value="'Titillium Web', sans-serif">Titillium Web</option>
              <option value="'Ubuntu', sans-serif">Ubuntu</option>
              <option value="'Urbanist', sans-serif">Urbanist</option>
              <option value="'Work Sans', sans-serif">Work Sans</option>
            </optgroup>
            
            <!-- Google Fonts - Serif -->
            <optgroup label="Serif">
              <option value="'Adamina', serif">Adamina</option>
              <option value="'Alegreya', serif">Alegreya</option>
              <option value="'Alice', serif">Alice</option>
              <option value="'Alike', serif">Alike</option>
              <option value="'Antic Didone', serif">Antic Didone</option>
              <option value="'Arvo', serif">Arvo</option>
              <option value="'Baskervville', serif">Baskervville</option>
              <option value="'Bitter', serif">Bitter</option>
              <option value="'Bodoni Moda', serif">Bodoni Moda</option>
              <option value="'Cardo', serif">Cardo</option>
              <option value="'Cormorant', serif">Cormorant</option>
              <option value="'Cormorant Garamond', serif">Cormorant Garamond</option>
              <option value="'Cormorant Infant', serif">Cormorant Infant</option>
              <option value="'Crimson Pro', serif">Crimson Pro</option>
              <option value="'Crimson Text', serif">Crimson Text</option>
              <option value="'DM Serif Display', serif">DM Serif Display</option>
              <option value="'EB Garamond', serif">EB Garamond</option>
              <option value="'Eczar', serif">Eczar</option>
              <option value="'Faustina', serif">Faustina</option>
              <option value="'Fraunces', serif">Fraunces</option>
              <option value="'Gelasio', serif">Gelasio</option>
              <option value="'Gentium Book Basic', serif">Gentium Book Basic</option>
              <option value="'Gilda Display', serif">Gilda Display</option>
              <option value="'IBM Plex Serif', serif">IBM Plex Serif</option>
              <option value="'IM Fell English', serif">IM Fell English</option>
              <option value="'IM Fell English SC', serif">IM Fell English SC</option>
              <option value="'Inria Serif', serif">Inria Serif</option>
              <option value="'Josefin Slab', serif">Josefin Slab</option>
              <option value="'Libre Baskerville', serif">Libre Baskerville</option>
              <option value="'Libre Bodoni', serif">Libre Bodoni</option>
              <option value="'Libre Caslon Display', serif">Libre Caslon Display</option>
              <option value="'Libre Caslon Text', serif">Libre Caslon Text</option>
              <option value="'Literata', serif">Literata</option>
              <option value="'Lora', serif">Lora</option>
              <option value="'Lustria', serif">Lustria</option>
              <option value="'Merriweather', serif">Merriweather</option>
              <option value="'Newsreader', serif">Newsreader</option>
              <option value="'Noto Serif', serif">Noto Serif</option>
              <option value="'Old Standard TT', serif">Old Standard TT</option>
              <option value="'Playfair Display', serif">Playfair Display</option>
              <option value="'Playfair Display SC', serif">Playfair Display SC</option>
              <option value="'Poly', serif">Poly</option>
              <option value="'PT Serif', serif">PT Serif</option>
              <option value="'Quattrocento', serif">Quattrocento</option>
              <option value="'Roboto Slab', serif">Roboto Slab</option>
              <option value="'Rosarivo', serif">Rosarivo</option>
              <option value="'Sorts Mill Goudy', serif">Sorts Mill Goudy</option>
              <option value="'Source Serif Pro', serif">Source Serif Pro</option>
              <option value="'Spectral', serif">Spectral</option>
              <option value="'Tinos', serif">Tinos</option>
              <option value="'Vidaloka', serif">Vidaloka</option>
              <option value="'Vollkorn', serif">Vollkorn</option>
            </optgroup>
            
            <!-- Google Fonts - Display -->
            <optgroup label="Display">
              <option value="'Abril Fatface', cursive">Abril Fatface</option>
              <option value="'Alfa Slab One', cursive">Alfa Slab One</option>
              <option value="'Amatic SC', cursive">Amatic SC</option>
              <option value="'Baloo 2', cursive">Baloo 2</option>
              <option value="'Bangers', cursive">Bangers</option>
              <option value="'Bebas Neue', cursive">Bebas Neue</option>
              <option value="'Black Ops One', cursive">Black Ops One</option>
              <option value="'Bungee', cursive">Bungee</option>
              <option value="'Bungee Inline', cursive">Bungee Inline</option>
              <option value="'Bungee Shade', cursive">Bungee Shade</option>
              <option value="'Changa One', cursive">Changa One</option>
              <option value="'Cinzel', serif">Cinzel</option>
              <option value="'Codystar', cursive">Codystar</option>
              <option value="'Creepster', cursive">Creepster</option>
              <option value="'Diplomata', cursive">Diplomata</option>
              <option value="'Emilys Candy', cursive">Emilys Candy</option>
              <option value="'Exo 2', sans-serif">Exo 2</option>
              <option value="'Faster One', cursive">Faster One</option>
              <option value="'Fredoka One', cursive">Fredoka One</option>
              <option value="'Fugaz One', cursive">Fugaz One</option>
              <option value="'Girassol', cursive">Girassol</option>
              <option value="'Graduate', serif">Graduate</option>
              <option value="'Holtwood One SC', serif">Holtwood One SC</option>
              <option value="'Josefin Sans', sans-serif">Josefin Sans</option>
              <option value="'Kaushan Script', cursive">Kaushan Script</option>
              <option value="'Koulen', cursive">Koulen</option>
              <option value="'Lobster', cursive">Lobster</option>
              <option value="'Lobster Two', cursive">Lobster Two</option>
              <option value="'Megrim', cursive">Megrim</option>
              <option value="'Monoton', cursive">Monoton</option>
              <option value="'Oleo Script Swash Caps', cursive">Oleo Script Swash Caps</option>
              <option value="'Orbitron', sans-serif">Orbitron</option>
              <option value="'Passion One', cursive">Passion One</option>
              <option value="'Piedra', cursive">Piedra</option>
              <option value="'Poiret One', cursive">Poiret One</option>
              <option value="'Righteous', cursive">Righteous</option>
              <option value="'Rowdies', cursive">Rowdies</option>
              <option value="'Rubik Mono One', cursive">Rubik Mono One</option>
              <option value="'Ruslan Display', cursive">Ruslan Display</option>
              <option value="'Russo One', sans-serif">Russo One</option>
              <option value="'Rye', cursive">Rye</option>
              <option value="'Sacramento', cursive">Sacramento</option>
              <option value="'Sancreek', cursive">Sancreek</option>
              <option value="'Sarina', cursive">Sarina</option>
              <option value="'Shrikhand', cursive">Shrikhand</option>
              <option value="'Special Elite', cursive">Special Elite</option>
              <option value="'Staatliches', cursive">Staatliches</option>
              <option value="'Ultra', serif">Ultra</option>
              <option value="'Vast Shadow', cursive">Vast Shadow</option>
              <option value="'Viga', sans-serif">Viga</option>
              <option value="'Yanone Kaffeesatz', sans-serif">Yanone Kaffeesatz</option>
            </optgroup>
            
            <!-- Google Fonts - Handwriting -->
            <optgroup label="Handwriting">
              <option value="'Annie Use Your Telescope', cursive">Annie Use Your Telescope</option>
              <option value="'Architects Daughter', cursive">Architects Daughter</option>
              <option value="'Arizonia', cursive">Arizonia</option>
              <option value="'Bilbo', cursive">Bilbo</option>
              <option value="'Calligraffitti', cursive">Calligraffitti</option>
              <option value="'Caveat', cursive">Caveat</option>
              <option value="'Cedarville Cursive', cursive">Cedarville Cursive</option>
              <option value="'Comic Neue', cursive">Comic Neue</option>
              <option value="'Covered By Your Grace', cursive">Covered By Your Grace</option>
              <option value="'Dancing Script', cursive">Dancing Script</option>
              <option value="'Dawning of a New Day', cursive">Dawning of a New Day</option>
              <option value="'East Sea Dokdo', cursive">East Sea Dokdo</option>
              <option value="'Gloria Hallelujah', cursive">Gloria Hallelujah</option>
              <option value="'Gochi Hand', cursive">Gochi Hand</option>
              <option value="'Herr Von Muellerhoff', cursive">Herr Von Muellerhoff</option>
              <option value="'Homemade Apple', cursive">Homemade Apple</option>
              <option value="'Indie Flower', cursive">Indie Flower</option>
              <option value="'Just Another Hand', cursive">Just Another Hand</option>
              <option value="'Just Me Again Down Here', cursive">Just Me Again Down Here</option>
              <option value="'Kalam', cursive">Kalam</option>
              <option value="'Kristi', cursive">Kristi</option>
              <option value="'La Belle Aurore', cursive">La Belle Aurore</option>
              <option value="'Loved by the King', cursive">Loved by the King</option>
              <option value="'Mali', cursive">Mali</option>
              <option value="'Marck Script', cursive">Marck Script</option>
              <option value="'Mr Dafoe', cursive">Mr Dafoe</option>
              <option value="'Mr De Haviland', cursive">Mr De Haviland</option>
              <option value="'Ms Madi', cursive">Ms Madi</option>
              <option value="'Nothing You Could Do', cursive">Nothing You Could Do</option>
              <option value="'Over the Rainbow', cursive">Over the Rainbow</option>
              <option value="'Pacifico', cursive">Pacifico</option>
              <option value="'Patrick Hand', cursive">Patrick Hand</option>
              <option value="'Permanent Marker', cursive">Permanent Marker</option>
              <option value="'Petit Formal Script', cursive">Petit Formal Script</option>
              <option value="'Qwigley', cursive">Qwigley</option>
              <option value="'Rancho', cursive">Rancho</option>
              <option value="'Reenie Beanie', cursive">Reenie Beanie</option>
              <option value="'Rock Salt', cursive">Rock Salt</option>
              <option value="'Schoolbell', cursive">Schoolbell</option>
              <option value="'Seaweed Script', cursive">Seaweed Script</option>
              <option value="'Sedgwick Ave', cursive">Sedgwick Ave</option>
              <option value="'Shadows Into Light', cursive">Shadows Into Light</option>
              <option value="'Satisfy', cursive">Satisfy</option>
              <option value="'Sue Ellen Francisco', cursive">Sue Ellen Francisco</option>
              <option value="'Swanky and Moo Moo', cursive">Swanky and Moo Moo</option>
              <option value="'The Girl Next Door', cursive">The Girl Next Door</option>
              <option value="'Walter Turncoat', cursive">Walter Turncoat</option>
            </optgroup>
            
            <!-- Google Fonts - Monospace -->
            <optgroup label="Monospace">
              <option value="'Anonymous Pro', monospace">Anonymous Pro</option>
              <option value="'Azeret Mono', monospace">Azeret Mono</option>
              <option value="'B612 Mono', monospace">B612 Mono</option>
              <option value="'Chivo Mono', monospace">Chivo Mono</option>
              <option value="'Courier Prime', monospace">Courier Prime</option>
              <option value="'Cousine', monospace">Cousine</option>
              <option value="'Cutive Mono', monospace">Cutive Mono</option>
              <option value="'DM Mono', monospace">DM Mono</option>
              <option value="'Fira Code', monospace">Fira Code</option>
              <option value="'Fira Mono', monospace">Fira Mono</option>
              <option value="'Fragment Mono', monospace">Fragment Mono</option>
              <option value="'IBM Plex Mono', monospace">IBM Plex Mono</option>
              <option value="'Inconsolata', monospace">Inconsolata</option>
              <option value="'JetBrains Mono', monospace">JetBrains Mono</option>
              <option value="'Major Mono Display', monospace">Major Mono Display</option>
              <option value="'Nanum Gothic Coding', monospace">Nanum Gothic Coding</option>
              <option value="'Noto Sans Mono', monospace">Noto Sans Mono</option>
              <option value="'Nova Mono', monospace">Nova Mono</option>
              <option value="'Overpass Mono', monospace">Overpass Mono</option>
              <option value="'Oxygen Mono', monospace">Oxygen Mono</option>
              <option value="'PT Mono', monospace">PT Mono</option>
              <option value="'Recursive', monospace">Recursive</option>
              <option value="'Red Hat Mono', monospace">Red Hat Mono</option>
              <option value="'Roboto Mono', monospace">Roboto Mono</option>
              <option value="'Share Tech Mono', monospace">Share Tech Mono</option>
              <option value="'Sometype Mono', monospace">Sometype Mono</option>
              <option value="'Source Code Pro', monospace">Source Code Pro</option>
              <option value="'Space Grotesk', monospace">Space Grotesk</option>
              <option value="'Space Mono', monospace">Space Mono</option>
              <option value="'Spline Sans Mono', monospace">Spline Sans Mono</option>
              <option value="'Syne Mono', monospace">Syne Mono</option>
              <option value="'Ubuntu Mono', monospace">Ubuntu Mono</option>
              <option value="'Victor Mono', monospace">Victor Mono</option>
              <option value="'VT323', monospace">VT323</option>
              <option value="'Xanh Mono', monospace">Xanh Mono</option>
            </optgroup>
            
            <!-- Cyberpunk/Sci-Fi/Horror Fonts -->
            <optgroup label="Cyberpunk & Sci-Fi">
              <option value="'Audiowide', cursive">Audiowide</option>
              <option value="'Chakra Petch', sans-serif">Chakra Petch</option>
              <option value="'Michroma', sans-serif">Michroma</option>
              <option value="'Orbitron', sans-serif">Orbitron</option>
              <option value="'Oxanium', cursive">Oxanium</option>
              <option value="'Press Start 2P', cursive">Press Start 2P</option>
              <option value="'Rajdhani', sans-serif">Rajdhani</option>
              <option value="'Sarpanch', sans-serif">Sarpanch</option>
              <option value="'Silkscreen', cursive">Silkscreen</option>
              <option value="'Syncopate', sans-serif">Syncopate</option>
              <option value="'Teko', sans-serif">Teko</option>
              <option value="'Wallpoet', cursive">Wallpoet</option>
            </optgroup>
            
            <optgroup label="Horror">
              <option value="'Butcherman', cursive">Butcherman</option>
              <option value="'Creepster', cursive">Creepster</option>
              <option value="'Eater', cursive">Eater</option>
              <option value="'Frijole', cursive">Frijole</option>
              <option value="'Jolly Lodger', cursive">Jolly Lodger</option>
              <option value="'Metal Mania', cursive">Metal Mania</option>
              <option value="'Nosifer', cursive">Nosifer</option>
              <option value="'Rubik Glitch', cursive">Rubik Glitch</option>
              <option value="'Rubik Wet Paint', cursive">Rubik Wet Paint</option>
              <option value="'Special Elite', cursive">Special Elite</option>
            </optgroup>
            
            <!-- Fantasy Fonts -->
            <optgroup label="Fantasy">
              <option value="'Almendra', serif">Almendra</option>
              <option value="'Astloch', cursive">Astloch</option>
              <option value="'Berkshire Swash', cursive">Berkshire Swash</option>
              <option value="'Cinzel', serif">Cinzel</option>
              <option value="'Cinzel Decorative', serif">Cinzel Decorative</option>
              <option value="'Eagle Lake', cursive">Eagle Lake</option>
              <option value="'Fondamento', cursive">Fondamento</option>
              <option value="'Grenze Gotisch', cursive">Grenze Gotisch</option>
              <option value="'MedievalSharp', cursive">MedievalSharp</option>
              <option value="'Metamorphous', cursive">Metamorphous</option>
              <option value="'Pirata One', cursive">Pirata One</option>
              <option value="'Uncial Antiqua', cursive">Uncial Antiqua</option>
            </optgroup>
            
            <!-- Mystery, Suspense & Gothic Fonts -->
            <optgroup label="Mystery & Suspense">
              <option value="'Bodoni Moda', serif">Bodoni Moda</option>
              <option value="'Carrois Gothic SC', sans-serif">Carrois Gothic SC</option>
              <option value="'IM Fell English', serif">IM Fell English</option>
              <option value="'IM Fell English SC', serif">IM Fell English SC</option>
              <option value="'Jacques Francois Shadow', cursive">Jacques Francois Shadow</option>
              <option value="'Libre Bodoni', serif">Libre Bodoni</option>
              <option value="'Old Standard TT', serif">Old Standard TT</option>
              <option value="'Special Elite', cursive">Special Elite</option>
              <option value="'UnifrakturMaguntia', cursive">UnifrakturMaguntia</option>
              <option value="'Vidaloka', serif">Vidaloka</option>
            </optgroup>
            
            <!-- Underwater/Ocean Fonts -->
            <optgroup label="Underwater/Ocean">
              <option value="'Baloo Bhai 2', cursive">Baloo Bhai 2</option>
              <option value="'Bubblegum Sans', cursive">Bubblegum Sans</option>
              <option value="'Comfortaa', cursive">Comfortaa</option>
              <option value="'Finger Paint', cursive">Finger Paint</option>
              <option value="'Handlee', cursive">Handlee</option>
              <option value="'Marhey', cursive">Marhey</option>
              <option value="'Quicksand', sans-serif">Quicksand</option>
              <option value="'Rancho', cursive">Rancho</option>
            </optgroup>
          </select>
          
          <select id="sizeSelect">
            <option value="">Size</option>
            <option value="1">8pt</option>
            <option value="1.5">9pt</option>
            <option value="2">10pt</option>
            <option value="2.5">11pt</option>
            <option value="3">12pt</option>
            <option value="3.5">13pt</option>
            <option value="4">14pt</option>
            <option value="4.5">16pt</option>
            <option value="5">18pt</option>
            <option value="5.5">21pt</option>
            <option value="6">24pt</option>
            <option value="6.5">30pt</option>
            <option value="7">36pt</option>
            <option value="8">48pt</option>
            <option value="9">60pt</option>
            <option value="10">72pt</option>
          </select>
          
          <span class="toolbar-separator"></span>
          
          <!-- Text style -->
          <button id="boldFormatBtn" class="toolbar-button" title="Bold"><b>B</b></button>
          <button id="italicFormatBtn" class="toolbar-button" title="Italic"><i>I</i></button>
          <button id="underlineFormatBtn" class="toolbar-button" title="Underline"><u>U</u></button>
          <button id="strikeFormatBtn" class="toolbar-button" title="Strikethrough"><s>S</s></button>
          <button id="superscriptFormatBtn" class="toolbar-button" title="Superscript">x<sup>2</sup></button>
          <button id="subscriptFormatBtn" class="toolbar-button" title="Subscript">x<sub>2</sub></button>
          
          <span class="toolbar-separator"></span>
          
          <!-- Colors -->
          <button id="textColorBtn" class="toolbar-button" title="Text Color">A</button>
          <button id="bgColorBtn" class="toolbar-button" title="Background Color">BG</button>
          
          <span class="toolbar-separator"></span>
          
          <!-- Alignment -->
          <button id="alignLeftBtn" class="toolbar-button" title="Align Left">⟵</button>
          <button id="alignCenterBtn" class="toolbar-button" title="Align Center">↔</button>
          <button id="alignRightBtn" class="toolbar-button" title="Align Right">⟶</button>
          <button id="alignJustifyBtn" class="toolbar-button" title="Justify">≡</button>
          
          <span class="toolbar-separator"></span>
          
          <!-- Lists -->
          <button id="bulletListBtn" class="toolbar-button" title="Bullet List">•</button>
          <button id="numberedListBtn" class="toolbar-button" title="Numbered List">1.</button>
          <button id="indentBtn" class="toolbar-button" title="Increase Indent">→</button>
          <button id="outdentBtn" class="toolbar-button" title="Decrease Indent">←</button>
          
          <span class="toolbar-separator"></span>
          
          <!-- Insert elements -->
          <button id="insertLinkBtn" class="toolbar-button" title="Insert Link">🔗</button>
          <button id="insertImageBtn" class="toolbar-button" title="Insert Image">🖼️</button>
          <button id="insertTableBtn" class="toolbar-button" title="Insert Table">🏢</button>
          <button id="insertHrBtn" class="toolbar-button" title="Insert Horizontal Line">—</button>
          <button id="specialCharBtn" class="toolbar-button" title="Insert Special Character">Ω</button>
          
          <span class="toolbar-separator"></span>
          
          <!-- Utilities -->
          <button id="undoBtn" class="toolbar-button" title="Undo">↩️</button>
          <button id="redoBtn" class="toolbar-button" title="Redo">↪️</button>
          <button id="clearFormatBtn" class="toolbar-button" title="Clear Formatting">✕</button>
          <button id="smartQuotesBtn" class="toolbar-button" title="Convert to Smart Quotes">"</button>
          
          <span class="toolbar-separator"></span>
          
          <!-- AI Button -->
          <button id="AIgen" title="AI Assistance">AI</button>
          
          <!-- Timer Button -->
          <button id="timerBtn" title="Writing Sprint Timer">⏱️</button>
        </div>
        
        <div id="editor" contenteditable="true"></div>
        <div id="WCdiv">
          <div class="word-count-container">
            <div>Word count: <span id="wordCount">0</span></div>
            <div id="timerDisplay">
              Sprint Timer: <span id="timerRemainingDisplay">15:00</span>
              <button id="cancelTimerBtn" title="Cancel Timer">✕</button>
            </div>
          </div>
          <div class="export-container">
            <div class="export-menu-container">
              <div id="exportMenuItems">
                <button id="exportWordBtn" class="export-btn">Word (.docx)</button>
                <button id="exportPdfBtn" class="export-btn">PDF (.pdf)</button>
                <button id="exportTxtBtn" class="export-btn">Text (.txt)</button>
              </div>
              <button id="toggleExportBtn">Export ▲</button>
            </div>
            <button id="toggleSidebarBtn">Toggle Sidebar</button>
          </div>
        </div>
      </div>

      <div id="characterEditorContainer">
        <div class="starfield-overlay" id="charEditorStars"></div>
        <div class="editor-header">
          <h3 id="characterEditTitle">New Character</h3>
          <button id="closeCharacterBtn">Close</button>
        </div>
        
        <div class="editor-content">
          <form id="characterForm">
            <div class="form-group">
              <label for="charImages" class="form-label">Character Images:</label>
              <button type="button" id="addCharacterImageBtn">+ Add Image</button>
              <div id="charImagesContainer">
                <!-- Character images will be added here dynamically -->
              </div>
              
              <input type="file" id="charImageInput" accept="image/*" style="display:none;">
            </div>
            
            <div class="form-group">
              <label for="charName" class="form-label">Name:</label>
              <input type="text" id="charName" class="form-input" required>
            </div>
            
            <div class="form-group">
              <label for="charRole" class="form-label">Role in Story:</label>
              <select id="charRole" class="form-input">
                <option value="Antagonist">Antagonist</option>
                <option value="Foil">Foil</option>
                <option value="Love Interest">Love Interest</option>
                <option value="Mentor">Mentor</option>
                <option value="Minor Character">Minor Character</option>
                <option value="Other">Other</option>
                <option value="Protagonist">Protagonist</option>
                <option value="Sidekick">Sidekick</option>
                <option value="Support Character">Support Character</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="charAge" class="form-label">Age:</label>
              <input type="text" id="charAge" class="form-input">
            </div>
            
            <div class="form-group">
              <label for="charGender" class="form-label">Gender:</label>
              <input type="text" id="charGender" class="form-input">
            </div>
            
            <div class="form-group">
              <label for="charOccupation" class="form-label">Occupation:</label>
              <input type="text" id="charOccupation" class="form-input">
            </div>
            
            <div class="form-group">
              <label class="form-label">Physical Appearance:</label>
              <div class="physical-appearance">
                <input type="text" id="charHeight" placeholder="Height" class="physical-input">
                <input type="text" id="charBuild" placeholder="Build" class="physical-input">
                <input type="text" id="charHair" placeholder="Hair" class="physical-input">
                <input type="text" id="charEyes" placeholder="Eyes" class="physical-input">
                <input type="text" id="charSkin" placeholder="Skin" class="physical-input">
                <input type="text" id="charFeatures" placeholder="Distinctive Features" class="physical-input">
              </div>
            </div>
            
            <div class="form-group">
              <label for="charPersonality" class="form-label">Personality Traits:</label>
              <textarea id="charPersonality" class="form-textarea"></textarea>
            </div>
            
            <div class="form-group">
              <label for="charBackstory" class="form-label">Backstory:</label>
              <textarea id="charBackstory" class="form-textarea"></textarea>
            </div>
            
            <div class="form-group">
              <label for="charMotivation" class="form-label">Motivation:</label>
              <textarea id="charMotivation" class="form-textarea"></textarea>
            </div>
            
            <div class="form-group">
              <label for="charFlaws" class="form-label">Flaws & Weaknesses:</label>
              <textarea id="charFlaws" class="form-textarea"></textarea>
            </div>
            
            <div class="form-group">
              <label for="charStrengths" class="form-label">Strengths & Abilities:</label>
              <textarea id="charStrengths" class="form-textarea"></textarea>
            </div>
            
            <div class="form-group">
              <label for="charRelationships" class="form-label">Relationships:</label>
              <textarea id="charRelationships" class="form-textarea" placeholder="Describe relationships with other characters"></textarea>
            </div>
            
            <div class="form-group">
              <label for="charNotes" class="form-label">Additional Notes:</label>
              <textarea id="charNotes" class="form-textarea"></textarea>
            </div>
            
            <div class="form-submit">
              <button type="submit" class="submit-btn">Save Character</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Lore Editor Container -->
      <div id="loreEditorContainer">
        <div class="starfield-overlay" id="loreEditorStars"></div>
        <div class="editor-header">
          <h3 id="loreEditTitle">New Lore Entry</h3>
          <button id="closeLoreBtn">Close</button>
        </div>
        
        <div class="editor-content">
          <form id="loreForm">
            <div class="form-group">
              <label for="loreImages" class="form-label">Reference Images:</label>
              <button type="button" id="addLoreImageBtn">+ Add Image</button>
              
              <div id="loreImagesContainer">
                <!-- Lore images will be added here dynamically -->
              </div>
              
              <input type="file" id="loreImageInput" accept="image/*" style="display:none;">
            </div>
            
            <div class="form-group">
              <label for="loreName" class="form-label">Name/Title:</label>
              <input type="text" id="loreName" class="form-input" required>
            </div>
            
            <div class="form-group">
              <label for="loreCategory" class="form-label">Category:</label>
              <select id="loreCategory" class="form-input">
                <option value="">Select a Category</option>
                <option value="Creature">Creature</option>
                <option value="Custom">Custom</option>
                <option value="Event">Historical Event</option>
                <option value="Food">Food/Cuisine</option>
                <option value="Item">Item</option>
                <option value="Language">Language</option>
                <option value="Location">Location</option>
                <option value="Magic">Magic System</option>
                <option value="Organization">Organization</option>
                <option value="Race">Race/Species</option>
                <option value="Religion">Religion/Belief</option>
                <option value="Technology">Technology</option>
                <option value="Tradition">Tradition/Custom</option>
              </select>
            </div>
            
            <div id="customCategoryContainer">
              <label for="loreCustomCategory" class="form-label">Custom Category:</label>
              <input type="text" id="loreCustomCategory" class="form-input">
            </div>
            
            <div class="form-group">
              <label for="loreDescription" class="form-label">Description:</label>
              <textarea id="loreDescription" class="form-textarea" style="height:120px;"></textarea>
            </div>
            
            <!-- Location specific fields -->
            <div class="category-fields" id="locationFields">
              <h4>Location Details</h4>
              
              <div class="form-group">
                <label for="locationType" class="form-label">Type:</label>
                <select id="locationType" class="form-input">
                  <option value="Building">Building</option>
                  <option value="Castle">Castle</option>
                  <option value="Cave">Cave</option>
                  <option value="City">City</option>
                  <option value="Desert">Desert</option>
                  <option value="Dungeon">Dungeon</option>
                  <option value="Forest">Forest</option>
                  <option value="Fortress">Fortress</option>
                  <option value="Island">Island</option>
                  <option value="Lake">Lake</option>
                  <option value="Mountain">Mountain</option>
                  <option value="Ocean">Ocean</option>
                  <option value="Other">Other</option>
                  <option value="Palace">Palace</option>
                  <option value="River">River</option>
                  <option value="Ruins">Ruins</option>
                  <option value="Sea">Sea</option>
                  <option value="Temple">Temple</option>
                  <option value="Town">Town</option>
                  <option value="Village">Village</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="locationClimate" class="form-label">Climate/Environment:</label>
                <input type="text" id="locationClimate" class="form-input">
              </div>
              
              <div class="form-group">
                <label for="locationPopulation" class="form-label">Population/Inhabitants:</label>
                <textarea id="locationPopulation" class="form-textarea" style="height:80px;"></textarea>
              </div>
              
              <div class="form-group">
                <label for="locationGovernment" class="form-label">Government/Leadership:</label>
                <textarea id="locationGovernment" class="form-textarea" style="height:80px;"></textarea>
              </div>
              
              <div class="form-group">
                <label for="locationHistory" class="form-label">History:</label>
                <textarea id="locationHistory" class="form-textarea"></textarea>
              </div>
              
              <div class="form-group">
                <label for="locationCulture" class="form-label">Culture/Customs:</label>
                <textarea id="locationCulture" class="form-textarea"></textarea>
              </div>
              
              <div class="form-group">
                <label for="locationEconomy" class="form-label">Economy/Resources:</label>
                <textarea id="locationEconomy" class="form-textarea" style="height:80px;"></textarea>
              </div>
              
              <div class="form-group">
                <label for="locationNotableFeatures" class="form-label">Notable Features/Landmarks:</label>
                <textarea id="locationNotableFeatures" class="form-textarea"></textarea>
              </div>
            </div>
            
            <!-- Item specific fields -->
            <div class="category-fields" id="itemFields">
              <h4>Item Details</h4>
              
              <div class="form-group">
                <label for="itemType" class="form-label">Type:</label>
                <select id="itemType" class="form-input">
                  <option value="Armor">Armor</option>
                  <option value="Artifact">Artifact</option>
                  <option value="Book">Book/Scroll</option>
                  <option value="Clothing">Clothing</option>
                  <option value="Currency">Currency</option>
                  <option value="Food">Food/Drink</option>
                  <option value="Jewelry">Jewelry</option>
                  <option value="Magical Item">Magical Item</option>
                  <option value="Other">Other</option>
                  <option value="Potion">Potion</option>
                  <option value="Relic">Relic</option>
                  <option value="Technology">Technology</option>
                  <option value="Tool">Tool</option>
                  <option value="Weapon">Weapon</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="itemCreator" class="form-label">Creator/Origin:</label>
                <input type="text" id="itemCreator" class="form-input">
              </div>
              
              <div class="form-group">
                <label for="itemAge" class="form-label">Age/Time Period:</label>
                <input type="text" id="itemAge" class="form-input">
              </div>
              
              <div class="form-group">
                <label for="itemAppearance" class="form-label">Appearance/Physical Description:</label>
                <textarea id="itemAppearance" class="form-textarea" style="height:80px;"></textarea>
              </div>
              
              <div class="form-group">
                <label for="itemMaterials" class="form-label">Materials/Composition:</label>
                <textarea id="itemMaterials" class="form-textarea" style="height:80px;"></textarea>
              </div>
              
              <div class="form-group">
                <label for="itemPowers" class="form-label">Powers/Abilities/Effects:</label>
                <textarea id="itemPowers" class="form-textarea"></textarea>
              </div>
              
              <div class="form-group">
                <label for="itemHistory" class="form-label">History/Lore:</label>
                <textarea id="itemHistory" class="form-textarea"></textarea>
              </div>
              
              <div class="form-group">
                <label for="itemOwnership" class="form-label">Current/Past Ownership:</label>
                <textarea id="itemOwnership" class="form-textarea" style="height:80px;"></textarea>
              </div>
              
              <div class="form-group">
                <label for="itemValue" class="form-label">Value/Worth:</label>
                <input type="text" id="itemValue" class="form-input">
              </div>
            </div>
            
            <!-- Creature specific fields -->
            <div class="category-fields" id="creatureFields">
              <h4>Creature Details</h4>
              
              <div class="form-group">
                <label for="creatureType" class="form-label">Type/Species:</label>
                <input type="text" id="creatureType" class="form-input">
              </div>
              
              <div class="form-group">
                <label for="creatureHabitat" class="form-label">Habitat/Environment:</label>
                <input type="text" id="creatureHabitat" class="form-input">
              </div>
              
              <div class="form-group">
                <label for="creatureAppearance" class="form-label">Appearance/Physical Description:</label>
                <textarea id="creatureAppearance" class="form-textarea"></textarea>
              </div>
              
              <div class="form-group">
                <label for="creatureAbilities" class="form-label">Abilities/Powers:</label>
                <textarea id="creatureAbilities" class="form-textarea"></textarea>
              </div>
              
              <div class="form-group">
                <label for="creatureBehavior" class="form-label">Behavior/Psychology:</label>
                <textarea id="creatureBehavior" class="form-textarea"></textarea>
              </div>
              
              <div class="form-group">
                <label for="creatureDiet" class="form-label">Diet/Feeding Habits:</label>
                <textarea id="creatureDiet" class="form-textarea" style="height:80px;"></textarea>
              </div>
              
              <div class="form-group">
                <label for="creatureLifecycle" class="form-label">Lifecycle/Reproduction:</label>
                <textarea id="creatureLifecycle" class="form-textarea" style="height:80px;"></textarea>
              </div>
              
              <div class="form-group">
                <label for="creatureSociety" class="form-label">Society/Culture:</label>
                <textarea id="creatureSociety" class="form-textarea" style="height:80px;"></textarea>
              </div>
              
              <div class="form-group">
                <label for="creatureHistory" class="form-label">History/Mythology:</label>
                <textarea id="creatureHistory" class="form-textarea" style="height:80px;"></textarea>
              </div>
              
              <div class="form-group">
                <label for="creatureWeaknesses" class="form-label">Weaknesses/Vulnerabilities:</label>
                <textarea id="creatureWeaknesses" class="form-textarea" style="height:80px;"></textarea>
              </div>
            </div>
            
            <!-- Organization specific fields -->
            <div class="category-fields" id="organizationFields">
              <h4>Organization Details</h4>
              
              <div class="form-group">
                <label for="orgType" class="form-label">Type:</label>
                <select id="orgType" class="form-input">
                  <option value="Crime">Criminal Organization</option>
                  <option value="Cult">Cult</option>
                  <option value="Government">Government</option>
                  <option value="Guild">Guild</option>
                  <option value="Mercenary">Mercenary Group</option>
                  <option value="Merchant">Merchant Group</option>
                  <option value="Military">Military</option>
                  <option value="Other">Other</option>
                  <option value="Political">Political Party</option>
                  <option value="Religious">Religious</option>
                  <option value="Resistance">Resistance/Rebellion</option>
                  <option value="School">School/Academy</option>
                  <option value="Secret Society">Secret Society</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="orgLeadership" class="form-label">Leadership/Important Members:</label>
                <textarea id="orgLeadership" class="form-textarea"></textarea>
              </div>
              
              <div class="form-group">
                <label for="orgHeadquarters" class="form-label">Headquarters/Location:</label>
                <input type="text" id="orgHeadquarters" class="form-input">
              </div>
              
              <div class="form-group">
                <label for="orgStructure" class="form-label">Structure/Hierarchy:</label>
                <textarea id="orgStructure" class="form-textarea"></textarea>
              </div>
              
              <div class="form-group">
                <label for="orgGoals" class="form-label">Goals/Objectives:</label>
                <textarea id="orgGoals" class="form-textarea"></textarea>
              </div>
              
              <div class="form-group">
                <label for="orgMethods" class="form-label">Methods/Activities:</label>
                <textarea id="orgMethods" class="form-textarea"></textarea>
              </div>
              
              <div class="form-group">
                <label for="orgResources" class="form-label">Resources/Assets:</label>
                <textarea id="orgResources" class="form-textarea" style="height:80px;"></textarea>
              </div>
              
              <div class="form-group">
                <label for="orgHistory" class="form-label">History/Origin:</label>
                <textarea id="orgHistory" class="form-textarea"></textarea>
              </div>
              
              <div class="form-group">
                <label for="orgAllies" class="form-label">Allies/Affiliations:</label>
                <textarea id="orgAllies" class="form-textarea" style="height:80px;"></textarea>
              </div>
              
              <div class="form-group">
                <label for="orgEnemies" class="form-label">Enemies/Rivals:</label>
                <textarea id="orgEnemies" class="form-textarea" style="height:80px;"></textarea>
              </div>
            </div>
            
            <!-- Event specific fields -->
            <div class="category-fields" id="eventFields">
              <h4>Historical Event Details</h4>
              
              <div class="form-group">
                <label for="eventType" class="form-label">Type:</label>
                <select id="eventType" class="form-input">
                  <option value="Assassination">Assassination</option>
                  <option value="Battle">Battle</option>
                  <option value="Catastrophe">Catastrophe</option>
                  <option value="Coronation">Coronation/Rise to Power</option>
                  <option value="Discovery">Discovery/Invention</option>
                  <option value="Festival">Festival/Celebration</option>
                  <option value="Migration">Migration/Settlement</option>
                  <option value="Natural Disaster">Natural Disaster</option>
                  <option value="Other">Other</option>
                  <option value="Religious">Religious Event</option>
                  <option value="Revolution">Revolution/Uprising</option>
                  <option value="Treaty">Treaty/Agreement</option>
                  <option value="War">War</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="eventDate" class="form-label">Date/Time Period:</label>
                <input type="text" id="eventDate" class="form-input">
              </div>
              
              <div class="form-group">
                <label for="eventLocation" class="form-label">Location:</label>
                <input type="text" id="eventLocation" class="form-input">
              </div>
              
              <div class="form-group">
                <label for="eventParticipants" class="form-label">Key Participants:</label>
                <textarea id="eventParticipants" class="form-textarea"></textarea>
              </div>
              
              <div class="form-group">
                <label for="eventCauses" class="form-label">Causes/Build-up:</label>
                <textarea id="eventCauses" class="form-textarea"></textarea>
              </div>
              
              <div class="form-group">
                <label for="eventOutcome" class="form-label">Outcome/Resolution:</label>
                <textarea id="eventOutcome" class="form-textarea"></textarea>
              </div>
              
              <div class="form-group">
                <label for="eventConsequences" class="form-label">Long-term Consequences:</label>
                <textarea id="eventConsequences" class="form-textarea"></textarea>
              </div>
              
              <div class="form-group">
                <label for="eventCulturalImpact" class="form-label">Cultural Impact/Legacy:</label>
                <textarea id="eventCulturalImpact" class="form-textarea" style="height:80px;"></textarea>
              </div>
              
              <div class="form-group">
                <label for="eventCommemoration" class="form-label">Commemoration/Remembrance:</label>
                <textarea id="eventCommemoration" class="form-textarea" style="height:80px;"></textarea>
              </div>
            </div>
            
            <div class="form-group">
              <label for="loreNotes" class="form-label">Additional Notes:</label>
              <textarea id="loreNotes" class="form-textarea"></textarea>
            </div>
            
            <div class="form-submit">
              <button type="submit" class="submit-btn">Save Lore Entry</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Novel Editor Container -->
      <div id="novelEditorContainer">
        <div class="starfield-overlay" id="novelEditorStars"></div>
        <div class="editor-header">
          <h3 id="novelEditTitle">Edit Novel Details</h3>
          <button id="closeNovelEditorBtn">Close</button>
        </div>
        
        <div class="editor-content">
          <form id="novelForm">
            <div class="form-group">
              <label for="novelCoverImage" class="form-label">Cover Image:</label>
              <div style="display:flex; align-items:center; gap:15px;">
                <div id="novelCoverPreviewContainer">
                  <img id="novelCoverPreview">
                  <span id="coverUploadPrompt">Click to upload cover</span>
                </div>
                <input type="file" id="novelCoverInput" accept="image/*" style="display:none;">
                <div>
                  <button type="button" id="uploadCoverBtn">Upload Cover</button>
                  <button type="button" id="removeCoverBtn">Remove</button>
                </div>
              </div>
            </div>
            
            <div class="form-group">
              <label for="novelTitle" class="form-label">Title:</label>
              <input type="text" id="novelTitle" class="form-input" required>
            </div>
            
            <div class="form-group">
              <label for="novelAuthor" class="form-label">Author:</label>
              <input type="text" id="novelAuthor" class="form-input">
            </div>
            
            <div class="form-row">
              <div class="form-col">
                <label for="novelGenre" class="form-label">Genre:</label>
                <select id="novelGenre" class="form-input">
                  <option value="">Select Genre</option>
                  <option value="Biography">Biography</option>
                  <option value="Biopunk">Biopunk</option>
                  <option value="Children's">Children's</option>
                  <option value="Contemporary">Contemporary</option>
                  <option value="Cosmic Horror">Cosmic Horror</option>
                  <option value="Cyberpunk">Cyberpunk</option>
                  <option value="Detective">Detective</option>
                  <option value="Dystopian">Dystopian</option>
                  <option value="Fantasy">Fantasy</option>
                  <option value="Gothic">Gothic</option>
                  <option value="Gothic Horror">Gothic Horror</option>
                  <option value="Historical Fiction">Historical Fiction</option>
                  <option value="Horror">Horror</option>
                  <option value="Literary Fiction">Literary Fiction</option>
                  <option value="Marine Adventure">Marine Adventure</option>
                  <option value="Memoir">Memoir</option>
                  <option value="Mermaid Tale">Mermaid Tale</option>
                  <option value="Mystery">Mystery</option>
                  <option value="Noir">Noir</option>
                  <option value="Non-fiction">Non-fiction</option>
                  <option value="Oceanic Fantasy">Oceanic Fantasy</option>
                  <option value="Other">Other</option>
                  <option value="Post-Apocalyptic">Post-Apocalyptic</option>
                  <option value="Psychological Horror">Psychological Horror</option>
                  <option value="Romance">Romance</option>
                  <option value="Science Fiction">Science Fiction</option>
                  <option value="Space Opera">Space Opera</option>
                  <option value="Steampunk">Steampunk</option>
                  <option value="Supernatural Horror">Supernatural Horror</option>
                  <option value="Suspense">Suspense</option>
                  <option value="Thriller">Thriller</option>
                  <option value="Underwater">Underwater</option>
                  <option value="Young Adult">Young Adult</option>
                </select>
              </div>
              
              <div class="form-col">
                <label for="novelStatus" class="form-label">Status:</label>
                <select id="novelStatus" class="form-input">
                  <option value="Complete">Complete</option>
                  <option value="Editing">Editing</option>
                  <option value="First Draft">First Draft</option>
                  <option value="In Progress">In Progress</option>
                  <option value="Planning">Planning</option>
                  <option value="Published">Published</option>
                  <option value="Revising">Revising</option>
                </select>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-col">
                <label for="novelTargetAudience" class="form-label">Target Audience:</label>
                <input type="text" id="novelTargetAudience" class="form-input">
              </div>
              
              <div class="form-col">
                <label for="novelWordCountGoal" class="form-label">Word Count Goal:</label>
                <input type="number" id="novelWordCountGoal" class="form-input">
              </div>
            </div>
            
            <div class="form-group">
              <label for="novelSeries" class="form-label">Series Name (if applicable):</label>
              <input type="text" id="novelSeries" class="form-input">
            </div>
            
            <div class="form-row">
              <div class="form-col">
                <label for="novelSeriesNumber" class="form-label">Book # in Series:</label>
                <input type="number" id="novelSeriesNumber" class="form-input">
              </div>
              
              <div class="form-col">
                <label for="novelLanguage" class="form-label">Language:</label>
                <input type="text" id="novelLanguage" class="form-input" value="English">
              </div>
            </div>
            
            <div class="form-group">
              <label for="novelTags" class="form-label">Tags/Keywords (comma separated):</label>
              <input type="text" id="novelTags" class="form-input" placeholder="e.g. adventure, coming of age, magic">
            </div>
            
            <div class="form-group">
              <label for="novelSynopsis" class="form-label">Synopsis/Description:</label>
              <textarea id="novelSynopsis" class="form-textarea" style="height:120px;"></textarea>
            </div>
            
            <div class="form-row">
              <div class="form-col">
                <label for="novelPublisher" class="form-label">Publisher (if published):</label>
                <input type="text" id="novelPublisher" class="form-input">
              </div>
              
              <div class="form-col">
                <label for="novelPublicationDate" class="form-label">Publication Date:</label>
                <input type="date" id="novelPublicationDate" class="form-input">
              </div>
            </div>
            
            <div class="form-group">
              <label for="novelISBN" class="form-label">ISBN (if published):</label>
              <input type="text" id="novelISBN" class="form-input">
            </div>
            
            <div class="form-group">
              <label for="novelCopyright" class="form-label">Copyright Information:</label>
              <textarea id="novelCopyright" class="form-textarea" style="height:80px;"></textarea>
            </div>
            
            <div class="form-group">
              <label for="novelNotes" class="form-label">Additional Notes:</label>
              <textarea id="novelNotes" class="form-textarea"></textarea>
            </div>
            
            <div class="form-submit">
              <button type="submit" class="submit-btn">Save Novel</button>
            </div>
          </form>
        </div>
      </div>
      
      <!-- Timeline Container -->
      <div id="timelineContainer">
        <div class="starfield-overlay" id="timelineStars"></div>
        <div class="timeline-header">
          <h2>Timeline</h2>
          <div class="timeline-controls">
            <button id="timelineSettingsBtn">Settings</button>
            <button id="addTimelineEventBtn">Add Event</button>
            <select id="timelineViewMode">
              <option value="horizontal">Horizontal</option>
              <option value="vertical">Vertical</option>
            </select>
            <button id="closeTimelineBtn">Close</button>
          </div>
        </div>
        
        <!-- Timeline Display Area -->
        <div id="timelineDisplay">
          <!-- Horizontal Timeline (hidden by default) -->
          <div id="horizontalTimeline">
            <!-- Timeline axis -->
            <div class="horizontal-timeline-axis"></div>
            <!-- Timeline events will be added here dynamically -->
            <div id="timelineEventsContainer"></div>
          </div>
          
          <!-- Vertical Timeline (default) -->
          <div id="verticalTimeline">
            <!-- Timeline axis -->
            <div class="vertical-timeline-axis"></div>
            <!-- Timeline events will be added here dynamically -->
            <div id="verticalTimelineEventsContainer"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Image Insert Modal -->
  <div id="imageModal">
    <div class="modal-content">
      <h3 class="modal-title">Insert Image</h3>
      
      <div style="margin-bottom:20px;">
        <div class="tab-buttons">
          <button id="urlTabBtn">Image URL</button>
          <button id="uploadTabBtn">Upload Image</button>
        </div>
        
        <!-- URL Tab -->
        <div id="urlTab">
          <input id="imageUrl" type="text" placeholder="Enter image URL" class="input-field">
          <input id="imageAltUrl" type="text" placeholder="Alternative text (for accessibility)" class="input-field">
        </div>
        
        <!-- Upload Tab -->
        <div id="uploadTab">
          <input id="imageFile" type="file" accept="image/*" style="width:100%; margin-bottom:10px; color:var(--text);">
          <input id="imageAltUpload" type="text" placeholder="Alternative text (for accessibility)" class="input-field">
          <div id="imagePreview">
            <img id="previewImg">
          </div>
        </div>
      </div>
      
      <div class="modal-buttons">
        <button id="closeImageModalBtn" class="cancel-btn">Cancel</button>
        <button id="insertImageBtn" class="insert-btn">Insert Image</button>
      </div>
    </div>
  </div>
  
  <!-- Special Characters Modal -->
  <div id="specialCharModal">
    <div class="modal-content">
      <div class="special-char-container">
        <button id="emDashBtn" class="special-char-btn" title="Em Dash">—</button>
        <button id="enDashBtn" class="special-char-btn" title="En Dash">–</button>
        <button id="ellipsisBtn" class="special-char-btn" title="Ellipsis">…</button>
        <button id="bulletBtn" class="special-char-btn" title="Bullet">•</button>
        <button id="zwsBtn" class="special-char-btn" title="Zero-Width Space">ZWS</button>
        <button id="hyphenBtn" class="special-char-btn" title="Hyphen">‐</button>
        <button id="nbspBtn" class="special-char-btn" title="Non-Breaking Space">NBSP</button>
        <button id="sectionBtn" class="special-char-btn" title="Section">§</button>
        <button id="paragraphBtn" class="special-char-btn" title="Paragraph">¶</button>
        <button id="copyrightBtn" class="special-char-btn" title="Copyright">©</button>
        <button id="registeredBtn" class="special-char-btn" title="Registered Trademark">®</button>
        <button id="trademarkBtn" class="special-char-btn" title="Trademark">™</button>
        <button id="degreeBtn" class="special-char-btn" title="Degree">°</button>
        <button id="plusMinusBtn" class="special-char-btn" title="Plus-Minus">±</button>
        <button id="timesBtn" class="special-char-btn" title="Multiplication">×</button>
        <button id="divideBtn" class="special-char-btn" title="Division">÷</button>
        <button id="notEqualBtn" class="special-char-btn" title="Not Equal">≠</button>
        <button id="approxBtn" class="special-char-btn" title="Approximately">≈</button>
        <button id="lessThanEqualBtn" class="special-char-btn" title="Less Than or Equal">≤</button>
        <button id="greaterThanEqualBtn" class="special-char-btn" title="Greater Than or Equal">≥</button>
        <button id="centBtn" class="special-char-btn" title="Cent">¢</button>
        <button id="euroBtn" class="special-char-btn" title="Euro">€</button>
        <button id="poundBtn" class="special-char-btn" title="Pound">£</button>
        <button id="yenBtn" class="special-char-btn" title="Yen">¥</button>
        <button id="rupeeBtn" class="special-char-btn" title="Rupee">₹</button>
        <button id="rubleBtn" class="special-char-btn" title="Ruble">₽</button>
        <button id="aAcuteBtn" class="special-char-btn" title="A Acute">á</button>
        <button id="aGraveBtn" class="special-char-btn" title="A Grave">à</button>
        <button id="aCircumflexBtn" class="special-char-btn" title="A Circumflex">â</button>
        <button id="aUmlautBtn" class="special-char-btn" title="A Umlaut">ä</button>
        <button id="aTildeBtn" class="special-char-btn" title="A Tilde">ã</button>
        <button id="aRingBtn" class="special-char-btn" title="A Ring">å</button>
        <button id="cCedillaBtn" class="special-char-btn" title="C Cedilla">ç</button>
        <button id="eAcuteBtn" class="special-char-btn" title="E Acute">é</button>
        <button id="eGraveBtn" class="special-char-btn" title="E Grave">è</button>
        <button id="eCircumflexBtn" class="special-char-btn" title="E Circumflex">ê</button>
        <button id="eUmlautBtn" class="special-char-btn" title="E Umlaut">ë</button>
        <button id="iAcuteBtn" class="special-char-btn" title="I Acute">í</button>
        <button id="iGraveBtn" class="special-char-btn" title="I Grave">ì</button>
        <button id="iCircumflexBtn" class="special-char-btn" title="I Circumflex">î</button>
        <button id="iUmlautBtn" class="special-char-btn" title="I Umlaut">ï</button>
        <button id="nTildeBtn" class="special-char-btn" title="N Tilde">ñ</button>
        <button id="oAcuteBtn" class="special-char-btn" title="O Acute">ó</button>
        <button id="oGraveBtn" class="special-char-btn" title="O Grave">ò</button>
        <button id="oCircumflexBtn" class="special-char-btn" title="O Circumflex">ô</button>
        <button id="oUmlautBtn" class="special-char-btn" title="O Umlaut">ö</button>
        <button id="oTildeBtn" class="special-char-btn" title="O Tilde">õ</button>
        <button id="oSlashBtn" class="special-char-btn" title="O Slash">ø</button>
        <button id="uAcuteBtn" class="special-char-btn" title="U Acute">ú</button>
        <button id="uGraveBtn" class="special-char-btn" title="U Grave">ù</button>
        <button id="uCircumflexBtn" class="special-char-btn" title="U Circumflex">û</button>
        <button id="uUmlautBtn" class="special-char-btn" title="U Umlaut">ü</button>
        <button id="yUmlautBtn" class="special-char-btn" title="Y Umlaut">ÿ</button>
      </div>
      
      <div class="modal-buttons">
        <button id="closeSpecialCharModalBtn" class="cancel-btn">Close</button>
      </div>
    </div>
  </div>
  
  <!-- Text Color Modal -->
  <div id="textColorModal">
    <div class="color-modal-content">
      <h3 class="modal-title">Text Color</h3>
      
      <div style="margin-bottom:20px;">
        <input type="color" id="textColorModalPicker" class="color-picker">
        <button id="applyTextColorBtn" class="apply-color-btn">Apply Color</button>
        <button id="unsetTextColorBtn" class="unset-color-btn">Unset Color</button>
      </div>
      
      <div style="display:flex; justify-content:flex-end;">
        <button id="closeTextColorModalBtn" class="cancel-btn">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Background Color Modal -->
  <div id="bgColorModal">
    <div class="color-modal-content">
      <h3 class="modal-title">Background Color</h3>
      
      <div style="margin-bottom:20px;">
        <input type="color" id="bgColorModalPicker" class="color-picker">
        <button id="applyBgColorBtn" class="apply-color-btn">Apply Color</button>
        <button id="unsetBgColorBtn" class="unset-color-btn">Unset Color</button>
      </div>
      
      <div style="display:flex; justify-content:flex-end;">
        <button id="closeBgColorModalBtn" class="cancel-btn">Cancel</button>
      </div>
    </div>
  </div>
  
  <!-- Image Editing Toolbar -->
  <div id="imageEditingToolbar">
    <!-- Size controls -->
    <div class="image-toolbar-group">
      <label class="toolbar-label">Size:</label>
      <select id="imageSizeSelect">
        <option value="custom">Custom</option>
        <option value="large">Large</option>
        <option value="medium" selected>Medium</option>
        <option value="original">Original</option>
        <option value="small">Small</option>
      </select>
      <div id="customSizeControls">
        <input type="number" id="imageWidth" placeholder="W" class="size-input">
        <span class="size-separator">×</span>
        <input type="number" id="imageHeight" placeholder="H" class="size-input">
        <button id="applyCustomSizeBtn">Apply</button>
      </div>
    </div>
    
    <!-- Alignment controls -->
    <div class="image-toolbar-group">
      <label class="toolbar-label">Align:</label>
      <button id="imgAlignLeftBtn" class="image-align-btn" title="Align Left">⟵</button>
      <button id="imgAlignCenterBtn" class="image-align-btn" title="Align Center">↔</button>
      <button id="imgAlignRightBtn" class="image-align-btn" title="Align Right">⟶</button>
      <button id="imgFloatLeftBtn" class="image-align-btn" title="Float Left">◀ Text</button>
      <button id="imgFloatRightBtn" class="image-align-btn" title="Float Right">Text ▶</button>
      <button id="imgFloatNoneBtn" class="image-align-btn" title="No Float">⊘</button>
    </div>
    
    <!-- Border, padding, alt text -->
    <div class="image-toolbar-group">
      <label class="toolbar-label">Border:</label>
      <input type="color" id="imageBorderColor" value="#000000">
      <input type="number" id="imageBorderWidth" value="0" min="0" max="10">
      <button id="applyImageBorderBtn">Apply</button>
    </div>
    
    <div class="image-toolbar-group">
      <label class="toolbar-label">Padding:</label>
      <input type="number" id="imagePadding" value="0" min="0" max="50">
      <button id="applyImagePaddingBtn">Apply</button>
    </div>
    
    <div class="image-toolbar-group">
      <label class="toolbar-label">Alt Text:</label>
      <input type="text" id="imageAltText" placeholder="Alternative text">
      <button id="applyImageAltBtn">Apply</button>
    </div>
    
    <!-- Remove image button -->
    <div class="image-toolbar-footer">
      <button id="removeImageBtn">Remove Image</button>
      <button id="closeImageEditingToolbarBtn">Close</button>
    </div>
  </div>

  <!-- Character Image Preview Modal -->
  <div id="characterImagePreviewModal">
    <div class="preview-container">
      <button id="closeImagePreviewModalBtn" class="close-preview-btn">×</button>
      <img id="fullSizeCharacterImage">
    </div>
  </div>

  <!-- Lore Image Preview Modal -->
  <div id="loreImagePreviewModal">
    <div class="preview-container">
      <button id="closeLoreImagePreviewModalBtn" class="close-preview-btn">×</button>
      <img id="fullSizeLoreImage">
    </div>
  </div>
  
  <!-- Chapter Summary Modal -->
  <div id="summaryModal">
    <div class="summary-content">
      <h3 id="summaryModalTitle" class="modal-title">Chapter Summary</h3>
      
      <div style="margin-bottom:20px;">
        <textarea id="summaryTextarea" placeholder="Enter a summary for this chapter..."></textarea>
      </div>
      
      <div class="summary-buttons">
        <button id="generateSummaryBtn">Generate with AI</button>
        <div>
          <button id="closeSummaryModalBtn" class="cancel-btn" style="margin-right:10px;">Cancel</button>
          <button id="summarysave" class="insert-btn">Save</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Timer Modal -->
  <div id="timerModal">
    <div class="timer-content">
      <h3 class="modal-title">Set Writing Sprint Timer</h3>
      
      <div style="margin-bottom:20px;">
        <div class="timer-input">
          <input type="number" id="timerMinutes" min="1" max="120" value="15">
          <span class="timer-label">minutes</span>
        </div>
        
        <button id="startTimerBtn">Start Timer</button>
      </div>
      
      <div style="display:flex; justify-content:flex-end;">
        <button id="closeTimerModalBtn" class="cancel-btn">Cancel</button>
      </div>
    </div>
  </div>
  
  <!-- Timeline Event Modal -->
  <div id="timelineEventModal">
    <div class="timeline-event-content">
      <h3 id="timelineEventModalTitle" class="modal-title">Add Timeline Event</h3>
      
      <form id="timelineEventForm">
        <div class="form-group">
          <label for="eventTitle" class="form-label">Event Title:</label>
          <input type="text" id="eventTitle" class="form-input" required>
        </div>
        
        <div class="form-row">
          <div class="form-col">
            <label for="eventEra" class="form-label">Era:</label>
            <select id="eventEra" class="form-input">
              <option value="Current Era">Current Era</option>
              <!-- More eras will be added dynamically based on settings -->
            </select>
          </div>
          
          <div class="form-col">
            <label for="eventYear" class="form-label">Year:</label>
            <input type="number" id="eventYear" class="form-input" required>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-col">
            <label for="eventMonth" class="form-label">Month:</label>
            <select id="eventMonth" class="form-input">
              <option value="">-- No Month --</option>
              <!-- Months will be added dynamically based on settings -->
            </select>
          </div>
          
          <div class="form-col">
            <label for="eventDay" class="form-label">Day:</label>
            <input type="number" id="eventDay" min="1" max="31" class="form-input">
          </div>
        </div>
        
        <div class="form-group">
          <label for="eventDescription" class="form-label">Description:</label>
          <textarea id="eventDescription" class="form-textarea" style="height:120px;"></textarea>
        </div>
        
        <div class="form-group">
          <label for="eventColor" class="form-label">Color:</label>
          <input type="color" id="eventColor" value="#4285f4" class="form-input">
        </div>
        
        <div style="display:flex; justify-content:space-between; gap:10px;">
          <button type="button" id="deleteTimelineEventBtn" style="padding:8px 12px; background:var(--danger); color:white; border:none; border-radius:4px; display:none;">Delete Event</button>
          <div style="display:flex; gap:10px; margin-left:auto;">
            <button type="button" id="closeTimelineEventModalBtn" class="cancel-btn">Cancel</button>
            <button type="submit" class="insert-btn">Save Event</button>
          </div>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Timeline Settings Modal -->
  <div id="timelineSettingsModal">
    <div class="timeline-settings-content">
      <h3 class="modal-title">Timeline Settings</h3>
      
      <form id="timelineSettingsForm">
        <!-- Eras Section -->
        <div class="settings-section">
          <h4>Eras</h4>
          <div id="erasContainer">
            <!-- Eras will be added here dynamically -->
          </div>
          <button type="button" id="addEraBtn" style="padding:5px 10px; background:var(--secondary); color:white; border:none; border-radius:4px; margin-top:10px;">+ Add Era</button>
        </div>
        
        <!-- Months Section -->
        <div class="settings-section">
          <h4>Months</h4>
          <div style="margin-bottom:10px;">
            <label class="form-label">Number of Months:</label>
            <input type="number" id="numMonths" min="1" max="24" value="12">
          </div>
          <div id="monthsContainer">
            <!-- Month inputs will be added here dynamically -->
          </div>
        </div>
        
        <!-- Days Section -->
        <div class="settings-section">
          <h4>Days in Week</h4>
          <div style="margin-bottom:10px;">
            <label class="form-label">Number of Days in Week:</label>
            <input type="number" id="numDaysInWeek" min="1" max="10" value="7">
          </div>
          <div id="daysContainer">
            <!-- Day inputs will be added here dynamically -->
          </div>
        </div>
        
        <!-- Month Length Section -->
        <div class="settings-section">
          <h4>Days per Month</h4>
          <div id="monthLengthsContainer">
            <!-- Month length inputs will be added here dynamically -->
          </div>
        </div>
        
        <div style="display:flex; justify-content:flex-end; gap:10px;">
          <button type="button" id="closeTimelineSettingsBtn" class="cancel-btn">Cancel</button>
          <button type="submit" class="insert-btn">Save Settings</button>
        </div>
      </form>
    </div>
  </div>
  
  <input type="file" id="importFile" accept=".txt,text/plain">
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.0.4/docx.umd.min.js"></script>
<script>
function openWordExportDialog() {
  document.getElementById('wordExportDialog').style.display = '';
}
function closeWordExportDialog() {
  document.getElementById('wordExportDialog').style.display = 'none';
}


</script>
<script>
  // Create a starfield effect for galaxy theme
  function createStarfield(containerId, count) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    // Clear any existing stars
    container.innerHTML = '';
    
    for (let i = 0; i < count; i++) {
      const star = document.createElement('div');
      star.className = 'star ' + (Math.random() < 0.7 ? 'sm' : (Math.random() < 0.9 ? 'md' : 'lg'));
      
      // Position randomly within container
      star.style.left = Math.random() * 100 + '%';
      star.style.top = Math.random() * 100 + '%';
      
      // Add random delay to animation
      star.style.animationDelay = Math.random() * 4 + 's';
      star.style.animationDuration = (2 + Math.random() * 4) + 's';
      
      container.appendChild(star);
    }
  }
  
  // Listen for theme changes and create galaxy effect when galaxy theme is selected


  // Add galaxy initialization to the existing script
function galaxyStars () {      
      // Create starfield in each container
      createStarfield('sidebarStars', 100);
      createStarfield('novelListStars', 150);
      createStarfield('editorStars', 200);
      createStarfield('charEditorStars', 150);
      createStarfield('loreEditorStars', 150);
      createStarfield('novelEditorStars', 150);
      createStarfield('timelineStars', 200);
    };
  window.addEventListener('load', function() {
  setTimeout(function() {
if (themeSelect.value == 'galaxy') {
  document.body.setAttribute('data-theme', 'galaxy');
  galaxyStars();
} else {
  document.body.setAttribute('data-theme', '');
}
  }, 500);
});

themeSelect.addEventListener('change', function() {
  const elements = document.querySelectorAll('.star');
  if (themeSelect.value == 'galaxy') {
    galaxyStars();
    document.body.setAttribute('data-theme', 'galaxy');
  elements.forEach(element => {
    element.style.display = 'block'; 
    })} else {
      document.body.setAttribute('data-theme', '');
      elements.forEach(element => {
    element.style.display = 'none';
    });
    }
});
  if (themeSelect.value == 'galaxy') {
    document.body.setAttribute('data-theme', 'galaxy');
    galaxyStars();
} else {
    document.body.setAttribute('data-theme', '');
}
</script>
<script>
  // Model: Store novels data
  let novels = [];
  let currentNovelIndex = -1;
  let currentCharacterIndex = -1;
  let currentLoreIndex = -1;
  let characterImagesData = []; // Store multiple character images
  let loreImagesData = []; // Store multiple lore images
  let currentImageIndex = -1; // Track which image is being edited/uploaded
  let novelCoverData = null; // Store the novel cover image data
  // Current chapter being summarized
  let summaryChapterIndex = -1;

  // Track currently selected image
  let selectedImage = null;
  
  // Track chapter list collapsed state
  let chaptersCollapsed = false;
  // Track character list collapsed state
  let charactersCollapsed = false;
  // Track lore list collapsed state
  let loreCollapsed = false;
  
  // Track if there's an ongoing save operation
  let saveTimeout = null;
  
  // Track drag and drop operations
  let draggedItem = null;
  
  // Timer variables
  let timerInterval = null;
  let timerEndTime = null;

  // Timeline variables
  let timelineCollapsed = false;
  let currentTimelineEventIndex = -1;
  let timelineSettings = {
    eras: [{ name: 'Current Era', abbreviation: 'CE' }],
    months: [
      'January', 'February', 'March', 'April', 'May', 'June',
      'July', 'August', 'September', 'October', 'November', 'December'
    ],
    daysInWeek: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'],
    daysPerMonth: [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31],
    viewMode: 'horizontal'
  };

  // IndexedDB Configuration
  const DB_NAME = 'novelAppDB';
  const DB_VERSION = 1;
  let db = null;

  // Initialize IndexedDB
  function initDB() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open(DB_NAME, DB_VERSION);
      
      request.onerror = (event) => {
        console.error("Error opening database:", event.target.error);
        reject(event.target.error);
      };
      
      request.onupgradeneeded = (event) => {
        const db = event.target.result;
        
        // Create object stores if they don't exist
        if (!db.objectStoreNames.contains('novels')) {
          db.createObjectStore('novels');
        }
        
        if (!db.objectStoreNames.contains('settings')) {
          db.createObjectStore('settings');
        }
      };
      
      request.onsuccess = (event) => {
        db = event.target.result;
        resolve(db);
      };
    });
  }

  // Save data to IndexedDB
  async function saveToIndexedDB(storeName, key, data) {
    if (!db) await initDB();
    
    return new Promise((resolve, reject) => {
      const transaction = db.transaction([storeName], "readwrite");
      const store = transaction.objectStore(storeName);
      const request = store.put(data, key);
      
      request.onsuccess = () => resolve();
      request.onerror = () => reject(request.error);
    });
  }

  // Get data from IndexedDB
  async function getFromIndexedDB(storeName, key) {
    if (!db) await initDB();
    
    return new Promise((resolve, reject) => {
      const transaction = db.transaction(storeName, 'readonly');
      const store = transaction.objectStore(storeName);
      const request = store.get(key);
      
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
  }

  // Check if a key exists in IndexedDB
  async function keyExistsInIndexedDB(storeName, key) {
    if (!db) await initDB();
    
    return new Promise((resolve, reject) => {
      const transaction = db.transaction(storeName, 'readonly');
      const store = transaction.objectStore(storeName);
      const request = store.count(key);
      
      request.onsuccess = () => resolve(request.result > 0);
      request.onerror = () => reject(request.error);
    });
  }

  // Get all entries from a store in IndexedDB
  async function getAllFromIndexedDB(storeName) {
    if (!db) await initDB();
    
    return new Promise((resolve, reject) => {
      const transaction = db.transaction(storeName, 'readonly');
      const store = transaction.objectStore(storeName);
      const request = store.getAll();
      
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
  }

  // Get all keys from a store in IndexedDB
  async function getAllKeysFromIndexedDB(storeName) {
    if (!db) await initDB();
    
    return new Promise((resolve, reject) => {
      const transaction = db.transaction(storeName, 'readonly');
      const store = transaction.objectStore(storeName);
      const request = store.getAllKeys();
      
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
  }

  // Delete data from IndexedDB
  async function deleteFromIndexedDB(storeName, key) {
    if (!db) await initDB();
    
    return new Promise((resolve, reject) => {
      const transaction = db.transaction(storeName, 'readwrite');
      const store = transaction.objectStore(storeName);
      const request = store.delete(key);
      
      request.onsuccess = () => resolve();
      request.onerror = () => reject(request.error);
    });
  }

  // Initialize the app
  async function init() {
    // Initialize IndexedDB
    await initDB();
    
    // Check if there are saved novels
    const novelsExist = await keyExistsInIndexedDB('novels', 'novelsData');
    if (novelsExist) {
      await loadNovels();
    } else {
      // Add first novel with first chapter
      addNovel();
    }
    
    // Add word count functionality
    editor.addEventListener('input', function() {
      updateWordCount();
      autoSaveEdit();
    });
    editor.setAttribute('placeholder', 'Start writing your chapter here...');
    
    // Update UI for mobile
    updateMobileUI();
    
    // Add keyboard shortcut listeners for common formatting operations
    document.addEventListener('keydown', handleKeyboardShortcuts);
    
    // Add image file change listener
    imageFile.addEventListener('change', previewImage);
    
    // Add image selection event listener
    editor.addEventListener('click', handleEditorClick);
    
    // Listen for custom size option changes
    imageSizeSelect.addEventListener('change', function() {
      if (this.value === 'custom') {
        customSizeControls.style.display = 'inline-flex';
      } else {
        customSizeControls.style.display = 'none';
      }
    });
    
    // Handle clicks outside the editor to deselect images
    document.addEventListener('click', function(e) {
      if (!editor.contains(e.target) && e.target !== imageEditingToolbar && !imageEditingToolbar.contains(e.target)) {
        deselectAllImages();
        closeImageEditingToolbar();
      }
    });
    
    // Add smart quotes functionality to the editor
    setupSmartQuotes(editor);
    
    // Add smart quotes for pasted content
    setupSmartQuotesPaste(editor);
    
    // Add auto-replace functionality for ellipsis and em dash
    setupAutoReplace(editor);
    
    // Initialize character images container
    refreshImagesContainer();
    
    // Initialize lore images container
    refreshLoreImagesContainer();
    
    // Set up category-specific fields toggle for lore entries
    loreCategory.addEventListener('change', function() {
      toggleLoreCategoryFields();
      if (this.value === 'Custom') {
        customCategoryContainer.style.display = 'block';
      } else {
        customCategoryContainer.style.display = 'none';
      }
    });
    
    // Show novel list by default when loading the page
    showNovelList();
    
    // Setup import file listener
    importFile.addEventListener('change', handleImportFile);
    
    // Initialize theme
    await initTheme();
    
    // Add Tab key handler to editor
    editor.addEventListener('keydown', function(e) {
      if (e.key === 'Tab') {
        e.preventDefault(); // Prevent default tab behavior (focus change)
        
        // Insert a tab character at the current cursor position
        document.execCommand('insertText', false, '\t');
      }
    });
    
    // Set up event listeners
    setupEventListeners();
  }
  
  // Set up all event listeners
  function setupEventListeners() {
    // Menu and sidebar controls
    document.getElementById('menuBtn').addEventListener('click', toggleMenu);
    document.getElementById('showNovelListBtn').addEventListener('click', showNovelList);
    document.getElementById('toggleChapters').addEventListener('click', toggleChapterList);
    document.getElementById('addChapterBtn').addEventListener('click', addChapter);
    document.getElementById('toggleCharacters').addEventListener('click', toggleCharacterList);
    document.getElementById('addCharacterBtn').addEventListener('click', addCharacter);
    document.getElementById('toggleLore').addEventListener('click', toggleLoreList);
    document.getElementById('addLoreBtn').addEventListener('click', addLore);
    document.getElementById('timelinebtn').addEventListener('click', openTimeline);
    document.getElementById('addNovelBtn').addEventListener('click', addNovel);
    document.getElementById('toggleSidebarBtn').addEventListener('click', toggleSidebar);
    
    // Character editor
    document.getElementById('closeCharacterBtn').addEventListener('click', closeCharacterEditor);
    document.getElementById('addCharacterImageBtn').addEventListener('click', addCharacterImage);
    document.getElementById('charImageInput').addEventListener('change', function() { 
      previewCharacterImage(this);
    });
    document.getElementById('characterForm').addEventListener('submit', function(event) {
      saveCharacter(event);
    });
    
    // Lore editor
    document.getElementById('closeLoreBtn').addEventListener('click', closeLoreEditor);
    document.getElementById('addLoreImageBtn').addEventListener('click', addLoreImage);
    document.getElementById('loreImageInput').addEventListener('change', function() {
      previewLoreImage(this);
    });
    document.getElementById('loreForm').addEventListener('submit', function(event) {
      saveLore(event);
    });
    
    // Novel editor
    document.getElementById('closeNovelEditorBtn').addEventListener('click', closeNovelEditor);
    document.getElementById('novelCoverPreviewContainer').addEventListener('click', function() {
      document.getElementById('novelCoverInput').click();
    });
    document.getElementById('novelCoverInput').addEventListener('change', function() {
      previewNovelCover(this);
    });
    document.getElementById('uploadCoverBtn').addEventListener('click', function() {
      document.getElementById('novelCoverInput').click();
    });
    document.getElementById('removeCoverBtn').addEventListener('click', removeNovelCover);
    document.getElementById('novelForm').addEventListener('submit', function(event) {
      saveNovelDetails(event);
    });
    
    // Format toolbar
    document.getElementById('formatSelect').addEventListener('change', function() {
      formatText('formatBlock', this.value);
    });
    document.getElementById('fontSelect').addEventListener('change', function() {
      formatText('fontName', this.value);
    });
    document.getElementById('sizeSelect').addEventListener('change', function() {
      formatText('fontSize', this.value);
    });
    document.getElementById('boldFormatBtn').addEventListener('click', function() {
      formatText('bold');
    });
    document.getElementById('italicFormatBtn').addEventListener('click', function() {
      formatText('italic');
    });
    document.getElementById('underlineFormatBtn').addEventListener('click', function() {
      formatText('underline');
    });
    document.getElementById('strikeFormatBtn').addEventListener('click', function() {
      formatText('strikeThrough');
    });
    document.getElementById('superscriptFormatBtn').addEventListener('click', function() {
      formatText('superscript');
    });
    document.getElementById('subscriptFormatBtn').addEventListener('click', function() {
      formatText('subscript');
    });
    
    // Colors
    document.getElementById('textColorBtn').addEventListener('click', showTextColorModal);
    document.getElementById('bgColorBtn').addEventListener('click', showBgColorModal);
    
    // Alignment
    document.getElementById('alignLeftBtn').addEventListener('click', function() {
      formatText('justifyLeft');
    });
    document.getElementById('alignCenterBtn').addEventListener('click', function() {
      formatText('justifyCenter');
    });
    document.getElementById('alignRightBtn').addEventListener('click', function() {
      formatText('justifyRight');
    });
    document.getElementById('alignJustifyBtn').addEventListener('click', function() {
      formatText('justifyFull');
    });
    
    // Lists
    document.getElementById('bulletListBtn').addEventListener('click', function() {
      formatText('insertUnorderedList');
    });
    document.getElementById('numberedListBtn').addEventListener('click', function() {
      formatText('insertOrderedList');
    });
    document.getElementById('indentBtn').addEventListener('click', function() {
      formatText('indent');
    });
    document.getElementById('outdentBtn').addEventListener('click', function() {
      formatText('outdent');
    });
    
    // Insert elements
    document.getElementById('insertLinkBtn').addEventListener('click', insertLink);
    document.getElementById('insertImageBtn').addEventListener('click', insertImage);
    document.getElementById('insertTableBtn').addEventListener('click', insertTable);
    document.getElementById('insertHrBtn').addEventListener('click', insertHorizontalRule);
    document.getElementById('specialCharBtn').addEventListener('click', showSpecialCharacters);
    
    // Utilities
    document.getElementById('undoBtn').addEventListener('click', function() {
      formatText('undo');
    });
    document.getElementById('redoBtn').addEventListener('click', function() {
      formatText('redo');
    });
    document.getElementById('clearFormatBtn').addEventListener('click', function() {
      formatText('removeFormat');
    });
    document.getElementById('smartQuotesBtn').addEventListener('click', convertAllQuotesToSmartQuotes);
    
    // AI and timer
    document.getElementById('AIgen').addEventListener('click', function() {
      useAI(true);
    });
    document.getElementById('timerBtn').addEventListener('click', openTimerModal);
    document.getElementById('cancelTimerBtn').addEventListener('click', cancelTimer);
    
    // Export
    document.getElementById('toggleExportBtn').addEventListener('click', toggleExportMenu);
    document.getElementById('exportWordBtn').addEventListener('click', exportAsWord);
    document.getElementById('exportPdfBtn').addEventListener('click', exportAsPdf);
    document.getElementById('exportTxtBtn').addEventListener('click', exportAsTxt);
    
    // Theme
    document.getElementById('themeSelect').addEventListener('change', function() {
      setTheme(this.value);
    });
    
    // Backup/Import
    document.getElementById('backupbtn').addEventListener('click', exportAllData);
    document.getElementById('importbtn').addEventListener('click', importData);
    
    // Image modal
    document.getElementById('urlTabBtn').addEventListener('click', function() {
      switchImageTab('url');
    });
    document.getElementById('uploadTabBtn').addEventListener('click', function() {
      switchImageTab('upload');
    });
    document.getElementById('closeImageModalBtn').addEventListener('click', closeImageModal);
    document.getElementById('insertImageBtn').addEventListener('click', confirmInsertImage);
    
    // Special characters modal
    document.getElementById('closeSpecialCharModalBtn').addEventListener('click', closeSpecialCharModal);
    // Add event listeners for all special character buttons
    document.querySelectorAll('.special-char-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        insertSpecialChar(this.textContent);
      });
    });
    
    // Text color modal
    document.getElementById('applyTextColorBtn').addEventListener('click', function() {
      applyTextColor(textColorModalPicker.value);
    });
    document.getElementById('unsetTextColorBtn').addEventListener('click', unsetTextColor);
    document.getElementById('closeTextColorModalBtn').addEventListener('click', closeTextColorModal);
    
    // Background color modal
    document.getElementById('applyBgColorBtn').addEventListener('click', function() {
      applyBgColor(bgColorModalPicker.value);
    });
    document.getElementById('unsetBgColorBtn').addEventListener('click', unsetBgColor);
    document.getElementById('closeBgColorModalBtn').addEventListener('click', closeBgColorModal);
    
    // Image editing toolbar
    document.getElementById('applyCustomSizeBtn').addEventListener('click', applyCustomSize);
    document.getElementById('imgAlignLeftBtn').addEventListener('click', function() {
      applyImageEdit('align', 'left');
    });
    document.getElementById('imgAlignCenterBtn').addEventListener('click', function() {
      applyImageEdit('align', 'center');
    });
    document.getElementById('imgAlignRightBtn').addEventListener('click', function() {
      applyImageEdit('align', 'right');
    });
    document.getElementById('imgFloatLeftBtn').addEventListener('click', function() {
      applyImageEdit('float', 'left');
    });
    document.getElementById('imgFloatRightBtn').addEventListener('click', function() {
      applyImageEdit('float', 'right');
    });
    document.getElementById('imgFloatNoneBtn').addEventListener('click', function() {
      applyImageEdit('float', 'none');
    });
    document.getElementById('applyImageBorderBtn').addEventListener('click', function() {
      applyImageEdit('border');
    });
    document.getElementById('applyImagePaddingBtn').addEventListener('click', function() {
      applyImageEdit('padding');
    });
    document.getElementById('applyImageAltBtn').addEventListener('click', function() {
      applyImageEdit('alt');
    });
    document.getElementById('removeImageBtn').addEventListener('click', function() {
      applyImageEdit('remove');
    });
    document.getElementById('closeImageEditingToolbarBtn').addEventListener('click', closeImageEditingToolbar);
    
    // Image preview modals
    document.getElementById('closeImagePreviewModalBtn').addEventListener('click', closeImagePreviewModal);
    document.getElementById('closeLoreImagePreviewModalBtn').addEventListener('click', closeLoreImagePreviewModal);
    
    // Summary modal
    document.getElementById('closeSummaryModalBtn').addEventListener('click', closeSummaryModal);
    document.getElementById('generateSummaryBtn').addEventListener('click', function() {
      generateChapterSummary(true);
    });
    document.getElementById('summarysave').addEventListener('click', saveChapterSummary);
    
    // Timer modal
    document.getElementById('startTimerBtn').addEventListener('click', startTimer);
    document.getElementById('closeTimerModalBtn').addEventListener('click', closeTimerModal);
    
    // Timeline
    document.getElementById('closeTimelineBtn').addEventListener('click', closeTimeline);
    document.getElementById('addTimelineEventBtn').addEventListener('click', addTimelineEvent);
    document.getElementById('timelineViewMode').addEventListener('change', function() {
      switchTimelineView(this.value);
    });
    document.getElementById('timelineSettingsBtn').addEventListener('click', openTimelineSettings);
    document.getElementById('closeTimelineEventModalBtn').addEventListener('click', closeTimelineEventModal);
    document.getElementById('timelineEventForm').addEventListener('submit', function(event) {
      saveTimelineEvent(event);
    });
    document.getElementById('addEraBtn').addEventListener('click', addEra);
    document.getElementById('numMonths').addEventListener('change', updateMonthsInputs);
    document.getElementById('numDaysInWeek').addEventListener('change', updateDaysInputs);
    document.getElementById('closeTimelineSettingsBtn').addEventListener('click', closeTimelineSettings);
    document.getElementById('timelineSettingsForm').addEventListener('submit', function(event) {
      saveTimelineSettings(event);
    });
    
    // Delete timeline event button
    document.getElementById('deleteTimelineEventBtn').addEventListener('click', deleteTimelineEvent);
  }
  
  // Theme functionality
  async function setTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    await saveToIndexedDB('settings', 'theme', theme);
    
    // Update the select dropdown
    if (themeSelect) {
      themeSelect.value = theme;
      menuDropdown.style.display = 'none';
    }
  }
  
  async function initTheme() {
    const savedTheme = await getFromIndexedDB('settings', 'theme') || 'light';
    setTheme(savedTheme);
  }
  
  // Toggle sidebar visibility
  function toggleSidebar() {
    if (sidebar.style.display === 'none') {
      sidebar.style.display = 'block';
    } else {
      sidebar.style.display = 'none';
    }
  }
  
  // Auto save when editing content
  function autoSaveEdit() {
    if (saveTimeout) {
      clearTimeout(saveTimeout);
    }
    
    saveTimeout = setTimeout(function() {
      saveCurrentChapter();
      saveToIndexedDB('novels', 'novelsData', novels);
    }, 1000); // Save after 1 second of inactivity
  }
  
  // Toggle the chapter list collapse/expand
  function toggleChapterList() {
    chaptersCollapsed = !chaptersCollapsed;
    
    if (chaptersCollapsed) {
      chapterListContainer.style.display = 'none';
      toggleChapters.textContent = '▶';
    } else {
      chapterListContainer.style.display = 'block';
      toggleChapters.textContent = '▼';
    }
  }
  
  // Toggle the character list collapse/expand
  function toggleCharacterList() {
    charactersCollapsed = !charactersCollapsed;
    
    if (charactersCollapsed) {
      characterListContainer.style.display = 'none';
      toggleCharacters.textContent = '▶';
    } else {
      characterListContainer.style.display = 'block';
      toggleCharacters.textContent = '▼';
    }
  }
  
  // Toggle the lore list collapse/expand
  function toggleLoreList() {
    loreCollapsed = !loreCollapsed;
    
    if (loreCollapsed) {
      loreListContainer.style.display = 'none';
      toggleLore.textContent = '▶';
    } else {
      loreListContainer.style.display = 'block';
      toggleLore.textContent = '▼';
    }
  }
  
  // Convert all straight quotes in the editor to smart quotes
  function convertAllQuotesToSmartQuotes() {
    // Save current selection
    const selection = window.getSelection();
    const savedRanges = [];
    for (let i = 0; i < selection.rangeCount; i++) {
      savedRanges.push(selection.getRangeAt(i).cloneRange());
    }
    
    // Get all text nodes in the editor
    const textNodes = [];
    const walker = document.createTreeWalker(editor, NodeFilter.SHOW_TEXT);
    let node;
    while (node = walker.nextNode()) {
      textNodes.push(node);
    }
    
    // Process each text node
    textNodes.forEach(node => {
      node.textContent = convertToSmartQuotes(node.textContent);
    });
    
    // Restore selection
    selection.removeAllRanges();
    savedRanges.forEach(range => selection.addRange(range));
    
    // Save changes
    autoSaveEdit();
  }
  
  // Function to handle smart quotes conversion when pasting
  function setupSmartQuotesPaste(editorEl) {
    editorEl.addEventListener('paste', function(e) {
      // Get plain text from clipboard
      let clipboardData = e.clipboardData || window.clipboardData;
      let pastedText = clipboardData.getData('text/plain');
      
      // Process the text to convert quotes
      let processedText = convertToSmartQuotes(pastedText);
      
      // If the text changed, use our processed version
      if (pastedText !== processedText) {
        e.preventDefault();
        document.execCommand('insertText', false, processedText);
      }
      // Otherwise, let the default paste behavior happen
    });
  }
  
  // Function to convert regular quotes to smart quotes in text
  function convertToSmartQuotes(text) {
    let result = '';
    
    for (let i = 0; i < text.length; i++) {
      const char = text[i];
      
      if (char === '"' || char === "'") {
        // Get the text before this quote
        const textBefore = text.substring(0, i);
        
        // Get the last character of the text before this quote
        const lastChar = textBefore.slice(-1);
        
        // Determine if opening or closing quote
        // Use opening quote at start of text, after spaces, or after typical opening punctuation
        const isOpeningQuote = !lastChar || /[\s\(\[\{\-]/.test(lastChar);
        
        // Choose appropriate quote character
        let smartQuote;
        if (char === '"') {
          smartQuote = isOpeningQuote ? '\u201C' : '\u201D'; // Open or close double quote
        } else {
          smartQuote = isOpeningQuote ? '\u2018' : '\u2019'; // Open or close single quote
        }
        
        result += smartQuote;
      } else {
        result += char;
      }
    }
    
    return result;
  }
  
  // Function to handle auto-replacement of ... with ellipsis and -- with em dash
  function setupAutoReplace(editorEl) {
    editorEl.addEventListener('input', function(e) {
      // Only proceed if this was text input
      if (e.inputType === 'insertText') {
        const selection = window.getSelection();
        if (!selection.rangeCount) return;
        
        const range = selection.getRangeAt(0);
        const node = range.startContainer;
        
        // Only works directly in text nodes
        if (node.nodeType === Node.TEXT_NODE) {
          const text = node.textContent;
          const pos = range.startOffset;
          
          // Check for ellipsis pattern (...)
          if (e.data === '.' && pos >= 3 && text.substring(pos - 3, pos) === '...') {
            // Replace the three dots with an ellipsis character
            const before = text.substring(0, pos - 3);
            const after = text.substring(pos);
            node.textContent = before + '…' + after;
            
            // Move the cursor to after the ellipsis
            range.setStart(node, pos - 2);  // -3 for ... +1 for …
            range.collapse(true);
            selection.removeAllRanges();
            selection.addRange(range);
          }
          
          // Check for em dash pattern (--)
          else if (e.data === '-' && pos >= 2 && text.substring(pos - 2, pos) === '--') {
            // Replace the two hyphens with an em dash character
            const before = text.substring(0, pos - 2);
            const after = text.substring(pos);
            node.textContent = before + '—' + after;
            
            // Move the cursor to after the em dash
            range.setStart(node, pos - 1);  // -2 for -- +1 for —
            range.collapse(true);
            selection.removeAllRanges();
            selection.addRange(range);
          }
        }
      }
    });
  }
  
  // Function to handle smart quotes conversion
  function setupSmartQuotes(editorEl) {
    editorEl.addEventListener('keydown', function(e) {
      if (e.key === '"' || e.key === "'") {
        e.preventDefault();
        
        // Get the surrounding text to determine context
        const selection = window.getSelection();
        const range = selection.getRangeAt(0);
        
        // Get text before cursor
        let textBefore = '';
        if (range.startContainer.nodeType === Node.TEXT_NODE) {
          textBefore = range.startContainer.textContent.substring(0, range.startOffset);
        }
        
        // Determine if opening or closing quote
        // Use opening quote at start of text, after spaces, or after typical opening punctuation
        const lastChar = textBefore.slice(-1);
        const isOpeningQuote = !lastChar || /[\s\(\[\{\-]/.test(lastChar);
        
        // Choose appropriate quote character
        let smartQuote;
        if (e.key === '"') {
          smartQuote = isOpeningQuote ? '\u201C' : '\u201D'; // Open or close double quote
        } else {
          smartQuote = isOpeningQuote ? '\u2018' : '\u2019'; // Open or close single quote
        }
        
        // Insert the smart quote
        document.execCommand('insertText', false, smartQuote);
      }
    });
  }
  
  // Handle clicks within the editor
  function handleEditorClick(e) {
    // Check if an image was clicked
    if (e.target.tagName === 'IMG') {
      e.preventDefault();
      selectImage(e.target);
    } else {
      // If clicked elsewhere in the editor, deselect any selected image
      deselectAllImages();
      closeImageEditingToolbar();
    }
  }
  
  // Select an image and show the editing toolbar
  function selectImage(img) {
    // Deselect any previously selected image
    deselectAllImages();
    
    // Mark the image as selected
    selectedImage = img;
    img.classList.add('selected');
    
    // Position and show the image editing toolbar
    positionImageToolbar(img);
    
    // Populate the toolbar with the image's current properties
    populateImageToolbar(img);
  }
  
  // Deselect all images
  function deselectAllImages() {
    const images = editor.querySelectorAll('img.selected');
    images.forEach(img => img.classList.remove('selected'));
    selectedImage = null;
  }
  
  // Position the image editing toolbar near the selected image
  function positionImageToolbar(img) {
    const imgRect = img.getBoundingClientRect();
    const editorRect = editor.getBoundingClientRect();
    
    // Position the toolbar above the image
    imageEditingToolbar.style.left = (imgRect.left + window.scrollX) + 'px';
    imageEditingToolbar.style.top = (imgRect.top + window.scrollY - imageEditingToolbar.offsetHeight - 10) + 'px';
    
    // Check if toolbar would be outside the viewport or editor
    if (imgRect.top - imageEditingToolbar.offsetHeight < editorRect.top) {
      // Position below the image instead
      imageEditingToolbar.style.top = (imgRect.bottom + window.scrollY + 10) + 'px';
    }
    
    imageEditingToolbar.style.display = 'block';
  }
  
  // Populate the toolbar with the image's current properties
  function populateImageToolbar(img) {
    // Determine current size category
    let sizeValue = 'medium'; // Default
    if (img.width <= 200) sizeValue = 'small';
    else if (img.width >= 500) sizeValue = 'large';
    else if (img.style.width.includes('%') || img.hasAttribute('width')) sizeValue = 'custom';
    
    imageSizeSelect.value = sizeValue;
    
    // Set custom size inputs if available
    if (img.width && img.height) {
      imageWidth.value = img.width;
      imageHeight.value = img.height;
    }
    
    // Show/hide custom size controls
    customSizeControls.style.display = sizeValue === 'custom' ? 'inline-flex' : 'none';
    
    // Set border properties
    if (img.style.borderColor) {
      imageBorderColor.value = rgbToHex(img.style.borderColor);
    } else {
      imageBorderColor.value = '#000000';
    }
    
    imageBorderWidth.value = parseInt(img.style.borderWidth) || 0;
    
    // Set padding
    imagePadding.value = parseInt(img.style.padding) || 0;
    
    // Set alt text
    imageAltText.value = img.alt || '';
  }
  
  // Helper function to convert RGB to HEX
  function rgbToHex(rgb) {
    // Check if it's already a hex value
    if (rgb.startsWith('#')) return rgb;
    
    // Extract RGB values
    const match = rgb.match(/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*[\d.]+)?\)$/);
    if (!match) return '#000000';
    
    function toHex(n) {
      const hex = Number(n).toString(16);
      return hex.length === 1 ? '0' + hex : hex;
    }
    
    return '#' + toHex(match[1]) + toHex(match[2]) + toHex(match[3]);
  }
  
  // Apply the image edit based on the user's selection
  function applyImageEdit(property, value) {
    if (!selectedImage) return;
    
    switch (property) {
      case 'size':
        // Apply predefined sizes
        if (value === 'small') {
          selectedImage.style.width = '200px';
          selectedImage.removeAttribute('width');
          selectedImage.removeAttribute('height');
        } else if (value === 'medium') {
          selectedImage.style.width = '350px';
          selectedImage.removeAttribute('width');
          selectedImage.removeAttribute('height');
        } else if (value === 'large') {
          selectedImage.style.width = '500px';
          selectedImage.removeAttribute('width');
          selectedImage.removeAttribute('height');
        } else if (value === 'original') {
          selectedImage.style.width = '';
          selectedImage.removeAttribute('width');
          selectedImage.removeAttribute('height');
        }
        break;
        
      case 'align':
        // Clear existing alignment and float
        selectedImage.style.float = '';
        // Apply text alignment
        selectedImage.style.display = 'block';
        if (value === 'left') {
          selectedImage.style.marginLeft = '0';
          selectedImage.style.marginRight = 'auto';
        } else if (value === 'center') {
          selectedImage.style.marginLeft = 'auto';
          selectedImage.style.marginRight = 'auto';
        } else if (value === 'right') {
          selectedImage.style.marginLeft = 'auto';
          selectedImage.style.marginRight = '0';
        }
        break;
        
      case 'float':
        // Clear alignment margins
        selectedImage.style.marginLeft = '';
        selectedImage.style.marginRight = '';
        selectedImage.style.display = '';
        
        // Apply float
        selectedImage.style.float = value;
        if (value !== 'none') {
          selectedImage.style.margin = '0 ' + (value === 'left' ? '15px 15px 0' : '0 15px 15px');
        } else {
          selectedImage.style.float = '';
          selectedImage.style.margin = '';
        }
        break;
        
      case 'border':
        const width = imageBorderWidth.value + 'px';
        const color = imageBorderColor.value;
        if (parseInt(imageBorderWidth.value) > 0) {
          selectedImage.style.border = width + ' solid ' + color;
        } else {
          selectedImage.style.border = 'none';
        }
        break;
        
      case 'padding':
        selectedImage.style.padding = imagePadding.value + 'px';
        break;
        
      case 'alt':
        selectedImage.alt = imageAltText.value;
        break;
        
      case 'remove':
        if (confirm('Are you sure you want to remove this image?')) {
          selectedImage.parentNode.removeChild(selectedImage);
          closeImageEditingToolbar();
        }
        break;
    }
    
    // Save changes to localStorage
    autoSaveEdit();
  }
  
  // Apply custom size
  function applyCustomSize() {
    if (!selectedImage) return;
    
    const width = imageWidth.value;
    const height = imageHeight.value;
    
    if (width) {
      selectedImage.width = width;
      selectedImage.style.width = width + 'px';
    }
    
    if (height) {
      selectedImage.height = height;
      selectedImage.style.height = height + 'px';
    }
    
    // Save changes to localStorage
    autoSaveEdit();
  }
  
  // Close the image editing toolbar
  function closeImageEditingToolbar() {
    imageEditingToolbar.style.display = 'none';
  }
  
  // Handle keyboard shortcuts for formatting
  function handleKeyboardShortcuts(e) {
    if (e.ctrlKey || e.metaKey) {
      switch(e.key.toLowerCase()) {
        case 'b':
          e.preventDefault();
          formatText('bold');
          break;
        case 'i':
          e.preventDefault();
          formatText('italic');
          break;
        case 'u':
          e.preventDefault();
          formatText('underline');
          break;
        case 'z':
          e.preventDefault();
          formatText('undo');
          break;
        case 'y':
          e.preventDefault();
          formatText('redo');
          break;
      }
    }
  }
  
  // Update mobile UI based on screen size
  function updateMobileUI() {
    if (window.innerWidth <= 768) {
      // Switch to mobile layout (hide sidebar)
      sidebar.style.display = 'none';
      mainContent.style.paddingBottom = '50px';
      
      // In mobile view, hide sidebar if editorContainer is not visible
      if (editorContainer.style.display !== 'flex') {
        sidebar.style.display = 'none';
      }
    } else {
      // Switch to desktop layout (show sidebar)
      sidebar.style.display = 'block';
      mainContent.style.paddingBottom = '0';
    }
  }
  
  // Show the novel list instead of the editor
  function showNovelList() {
    if (currentNovelIndex !== -1) {
      saveCurrentChapter(); // Save current chapter before switching
      saveToIndexedDB('novels', 'novelsData', novels); // Save to IndexedDB
    }
    
    editorContainer.style.display = 'none';
    characterEditorContainer.style.display = 'none';
    novelEditorContainer.style.display = 'none';
    loreEditorContainer.style.display = 'none';
    timelineContainer.style.display = 'none';
    novelListContainer.style.display = 'flex';
    
    // Hide sidebar in mobile view when not in editor
    if (window.innerWidth <= 768) {
      sidebar.style.display = 'none';
    }
    
    updateNovelList();
  }
  
  // Show the editor instead of the novel list
  function showEditor() {
    novelListContainer.style.display = 'none';
    characterEditorContainer.style.display = 'none';
    novelEditorContainer.style.display = 'none';
    loreEditorContainer.style.display = 'none';
    timelineContainer.style.display = 'none';
    editorContainer.style.display = 'flex';
  }
  
  // Add a new novel
  function addNovel() {
    // Save current work if there is any
    if (currentNovelIndex !== -1) {
      saveCurrentChapter();
    }
    
    let newNovel = {
      title: `Untitled Novel ${novels.length + 1}`,
      author: "",
      genre: "",
      status: "Planning",
      targetAudience: "",
      wordCountGoal: 50000,
      series: "",
      seriesNumber: "",
      language: "English",
      tags: "",
      synopsis: "",
      publisher: "",
      publicationDate: "",
      isbn: "",
      copyright: "",
      notes: "",
      coverImage: null,
      chapters: [],
      characters: [],
      lore: [], // New property for lore entries
      timeline: [], // New property for timeline events
      timelineSettings: JSON.parse(JSON.stringify(timelineSettings)), // Copy default timeline settings
      currentChapterIndex: -1
    };
    
    novels.push(newNovel);
    currentNovelIndex = novels.length - 1;
    
    // Add first chapter to the new novel
    addChapter();
    
    updateNovelList();
    saveToIndexedDB('novels', 'novelsData', novels); // Save to IndexedDB
  }
  
  // Update the novel list in the UI as book displays
  function updateNovelList() {
    novelList.innerHTML = '';
    
    novels.forEach((novel, index) => {
      // Create a book element
      let bookElement = document.createElement('div');
      bookElement.className = 'book';
      
      // Create default colors based on the novel index
      const colors = [
        '#3f51b5', '#2196f3', '#009688', '#4caf50', '#ff9800', 
        '#795548', '#9c27b0', '#e91e63', '#f44336', '#673ab7'
      ];
      const color = colors[index % colors.length];
      
      // Get author display text
      const authorText = novel.author ? novel.author : "Unknown Author";
      
      // Get lore count with fallback for backward compatibility
      const loreCount = novel.lore ? novel.lore.length : 0;
      
      // Create the book HTML
      bookElement.innerHTML = `
        <div class="book-page"></div>
        <div class="book-spine"></div>
        <div class="book-cover">
          <div class="book-cover-img" style="${novel.coverImage ? `background-image:url('${novel.coverImage}');` : ''}"></div>
          <div class="book-info">
            <div>
              <span class="book-title">${novel.title}</span>
              <p class="book-author">${authorText}</p>
            </div>
            <div class="book-stats">
              ${novel.chapters.length} chapter${novel.chapters.length !== 1 ? 's' : ''} • 
              ${novel.characters ? novel.characters.length : 0} character${!novel.characters || novel.characters.length !== 1 ? 's' : ''} <br>
              ${loreCount} lore item${loreCount !== 1 ? 's' : ''}
            </div>
          </div>
          <div class="book-buttons">
            <button class="book-button edit-button" id="editNovelBtn-${index}">Edit</button>
            <button class="book-button open-button" id="openNovelBtn-${index}">Open</button>
            <button class="book-button delete-button" id="deleteNovelBtn-${index}" ${novels.length === 1 ? 'disabled title="Cannot delete the only novel"' : ''} style="${novels.length === 1 ? 'background:var(--text-light); cursor:not-allowed;' : ''}">Delete</button>
          </div>
        </div>
      `;
      
      novelList.appendChild(bookElement);
      
      // Add event listeners for the buttons
      document.getElementById(`editNovelBtn-${index}`).addEventListener('click', function() {
        editNovelDetails(index);
      });
      
      document.getElementById(`openNovelBtn-${index}`).addEventListener('click', function() {
        editNovel(index);
      });
      
      document.getElementById(`deleteNovelBtn-${index}`).addEventListener('click', function() {
        removeNovel(index);
      });
    });
  }
  
  // Preview Novel Cover
  function previewNovelCover(input) {
    const file = input.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        novelCoverData = e.target.result;
        novelCoverPreview.src = novelCoverData;
        novelCoverPreview.style.display = 'block';
        coverUploadPrompt.style.display = 'none';
        removeCoverBtn.style.display = 'block';
      };
      reader.readAsDataURL(file);
    }
  }
  
  // Remove Novel Cover
  function removeNovelCover() {
    novelCoverData = null;
    novelCoverPreview.src = '';
    novelCoverPreview.style.display = 'none';
    coverUploadPrompt.style.display = 'block';
    removeCoverBtn.style.display = 'none';
    novelCoverInput.value = '';
  }
  
  // Edit Novel Details
  function editNovelDetails(index) {
    if (currentNovelIndex !== -1) {
      saveCurrentChapter(); // Save any changes to current chapter
      saveToIndexedDB('novels', 'novelsData', novels); // Save to IndexedDB
    }
    
    currentNovelIndex = index;
    const novel = novels[currentNovelIndex];
    
    // Populate form with novel data
    novelTitle.value = novel.title || '';
    novelAuthor.value = novel.author || '';
    novelGenre.value = novel.genre || '';
    novelStatus.value = novel.status || 'Planning';
    novelTargetAudience.value = novel.targetAudience || '';
    novelWordCountGoal.value = novel.wordCountGoal || '';
    novelSeries.value = novel.series || '';
    novelSeriesNumber.value = novel.seriesNumber || '';
    novelLanguage.value = novel.language || 'English';
    novelTags.value = novel.tags || '';
    novelSynopsis.value = novel.synopsis || '';
    novelPublisher.value = novel.publisher || '';
    novelPublicationDate.value = novel.publicationDate || '';
    novelISBN.value = novel.isbn || '';
    novelCopyright.value = novel.copyright || '';
    novelNotes.value = novel.notes || '';
    
    // Set cover image if available
    novelCoverData = novel.coverImage;
    if (novelCoverData) {
      novelCoverPreview.src = novelCoverData;
      novelCoverPreview.style.display = 'block';
      coverUploadPrompt.style.display = 'none';
      removeCoverBtn.style.display = 'block';
    } else {
      novelCoverPreview.style.display = 'none';
      coverUploadPrompt.style.display = 'block';
      removeCoverBtn.style.display = 'none';
    }
    
    // Show novel editor
    novelListContainer.style.display = 'none';
    editorContainer.style.display = 'none';
    characterEditorContainer.style.display = 'none';
    loreEditorContainer.style.display = 'none';
    timelineContainer.style.display = 'none';
    novelEditorContainer.style.display = 'flex';
    
    // Hide sidebar in mobile view when not in editor
    if (window.innerWidth <= 768) {
      sidebar.style.display = 'none';
    }
    
    novelEditTitle.textContent = `Edit Novel: ${novel.title}`;

  }
  
  // Close Novel Editor
  function closeNovelEditor() {
    novelEditorContainer.style.display = 'none';
    showNovelList();
  }
  
  // Save Novel Details
  function saveNovelDetails(event) {
    event.preventDefault();
    
    if (currentNovelIndex < 0) return;
    
    // Get novel data from form
    const novel = novels[currentNovelIndex];
    
    novel.title = novelTitle.value;
    novel.author = novelAuthor.value;
    novel.genre = novelGenre.value;
    novel.status = novelStatus.value;
    novel.targetAudience = novelTargetAudience.value;
    novel.wordCountGoal = novelWordCountGoal.value;
    novel.series = novelSeries.value;
    novel.seriesNumber = novelSeriesNumber.value;
    novel.language = novelLanguage.value;
    novel.tags = novelTags.value;
    novel.synopsis = novelSynopsis.value;
    novel.publisher = novelPublisher.value;
    novel.publicationDate = novelPublicationDate.value;
    novel.isbn = novelISBN.value;
    novel.copyright = novelCopyright.value;
    novel.notes = novelNotes.value;
    novel.coverImage = novelCoverData;
    
    // Update UI
    updateNovelList();
    
    // Save to IndexedDB
    saveToIndexedDB('novels', 'novelsData', novels);
    
    // Close editor and show novel list
    closeNovelEditor();
    
    // Show confirmation
    alert('Novel details saved successfully!');
  }
  
  // Rename a novel
  function renameNovel(index, newTitle) {
    if (index >= 0 && index < novels.length) {
      novels[index].title = newTitle;
      updateNovelList();
      saveToIndexedDB('novels', 'novelsData', novels); // Save to IndexedDB
    }
  }
  
  // Edit a novel
  function editNovel(index) {
    if (currentNovelIndex !== -1) {
      saveCurrentChapter(); // Save any changes to current chapter
      saveToIndexedDB('novels', 'novelsData', novels); // Save to IndexedDB
    }
    
    currentNovelIndex = index;
    updateChapterList();
    updateCharacterList();
    updateLoreList();
    
    // Load the first chapter or create one if none exists
    if (novels[currentNovelIndex].chapters.length > 0) {
      loadChapter(novels[currentNovelIndex].currentChapterIndex >= 0 ? 
                 novels[currentNovelIndex].currentChapterIndex : 0);
    } else {
      addChapter();
    }
    
    showEditor();
  }
  
  // Remove a novel
  async function removeNovel(index) {
    // Prevent deletion if there's only one novel
    if (novels.length === 1) {
      return;
    }
    
    if (confirm('Are you sure you want to delete this novel? This action cannot be undone.')) {
      novels.splice(index, 1);
      
      if (novels.length === 0) {
        // Add a new novel if all were deleted
        addNovel();
      } else if (currentNovelIndex === index) {
        // If the current novel was deleted, select another one
        currentNovelIndex = Math.min(index, novels.length - 1);
        updateChapterList();
        updateCharacterList();
        updateLoreList();
        loadChapter(novels[currentNovelIndex].currentChapterIndex >= 0 ? 
                   novels[currentNovelIndex].currentChapterIndex : 0);
      } else if (currentNovelIndex > index) {
        // Adjust current novel index if a novel before it was deleted
        currentNovelIndex--;
      }
      
      updateNovelList();
      await saveToIndexedDB('novels', 'novelsData', novels); // Save to IndexedDB
    }
  }
  
  // Add a new chapter to the current novel
  function addChapter() {
    if (currentNovelIndex < 0) return;
    
    let novel = novels[currentNovelIndex];
    let newChapter = {
      title: `Chapter ${novel.chapters.length + 1}`,
      content: "",
      summary: "" // Initialize with empty summary
    };
    
    novel.chapters.push(newChapter);
    novel.currentChapterIndex = novel.chapters.length - 1;
    updateChapterList();
    loadChapter(novel.currentChapterIndex);
    
    saveToIndexedDB('novels', 'novelsData', novels); // Save to IndexedDB
  }
  
  // Function to handle edit button click
  function editChapterTitle(event, index) {
    event.stopPropagation(); // Prevent chapter selection
    const titleElement = event.target.parentElement.querySelector('.chapter-title');
    makeChapterTitleEditable(titleElement, index);
  }
  
  // Open the summary modal for a specific chapter
  function openSummaryModal(chapterIndex) {
    event.stopPropagation(); // Prevent chapter selection
    summaryChapterIndex = chapterIndex;
    const chapter = novels[currentNovelIndex].chapters[chapterIndex];
    
    // Set the modal title
    summaryModalTitle.textContent = `Summary: ${chapter.title}`;
    
    // Set the current summary if it exists
    summaryTextarea.value = chapter.summary || '';
    
    // Show the modal
    summaryModal.style.display = 'flex';
  }
  
  // Close the summary modal
  function closeSummaryModal() {
    summaryModal.style.display = 'none';
    summaryChapterIndex = -1;
  }
  
  // Save the chapter summary
  async function saveChapterSummary() {
    if (summaryChapterIndex < 0 || currentNovelIndex < 0) return;
    
    // Get the summary text
    const summaryText = summaryTextarea.value;
    
    // Save to the chapter
    novels[currentNovelIndex].chapters[summaryChapterIndex].summary = summaryText;
    
    // Save to IndexedDB
    await saveToIndexedDB('novels', 'novelsData', novels);
    
    // Close the modal
    closeSummaryModal();
    
    // Update chapter list to show summary indicator if needed
    updateChapterList();
  }
  
  // Generate a summary using AI
  async function generateChapterSummary() {
    if (summaryChapterIndex < 0 || currentNovelIndex < 0) return;
    
    // Get the chapter content
    const chapter = novels[currentNovelIndex].chapters[summaryChapterIndex];
    
    // Disable button and show loading state
    generateSummaryBtn.disabled = true;
    generateSummaryBtn.textContent = "⏳ Generating...";
    
    try {
      // Extract text content from HTML to avoid all the HTML tags in the prompt
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = chapter.content;
      const textContent = tempDiv.textContent || tempDiv.innerText;
      
      // Call the AI to generate a summary
      const summary = await useAI(false, { 
        mode: 'summary',
        chapterContent: textContent,
      });
      
      // Set the generated summary in the textarea
      summaryTextarea.value = summary;
    } catch (error) {
      console.error('Error generating summary:', error);
      alert('An error occurred while generating the summary. Please try again.');
    } finally {
      // Re-enable the button
      generateSummaryBtn.disabled = false;
      generateSummaryBtn.textContent = "Generate with AI";
    }
  }
  
  // Drag and drop handlers for reordering
  function handleDragStart(e) {
    draggedItem = this;
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', this.dataset.index);
    this.classList.add('dragging');
  }
  
  function handleDragOver(e) {
    if (!draggedItem) return;
    
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    
    // Check if we're dragging over an item of the same type
    if (draggedItem.dataset.type === this.dataset.type) {
      const rect = this.getBoundingClientRect();
      const midY = rect.top + rect.height / 2;
      
      // Add visual indicator for drop position
      if (e.clientY < midY) {
        this.classList.add('drop-above');
        this.classList.remove('drop-below');
      } else {
        this.classList.add('drop-below');
        this.classList.remove('drop-above');
      }
    }
  }
  
  function handleDragLeave() {
    this.classList.remove('drop-above', 'drop-below');
  }
  
  function handleDrop(e) {
    e.preventDefault();
    e.stopPropagation();
    
    // Remove drop indicators
    this.classList.remove('drop-above', 'drop-below');
    
    // Only handle drops if items are of the same type
    if (!draggedItem || draggedItem.dataset.type !== this.dataset.type) return;
    
    const fromIndex = parseInt(draggedItem.dataset.index);
    const toIndex = parseInt(this.dataset.index);
    
    // Don't do anything if dropping onto itself
    if (fromIndex === toIndex) return;
    
    const rect = this.getBoundingClientRect();
    const midY = rect.top + rect.height / 2;
    const insertAfter = e.clientY > midY;
    
    // Calculate where to insert the item
    let insertIndex = toIndex;
    if (insertAfter) {
        insertIndex++;
    }
    // Adjust for the item removal if necessary
    if (fromIndex < insertIndex) {
        insertIndex--;
    }
    
    // Perform the reordering based on the item type
    if (draggedItem.dataset.type === 'chapter') {
        reorderChapters(fromIndex, insertIndex);
    } else if (draggedItem.dataset.type === 'character') {
        reorderCharacters(fromIndex, insertIndex);
    } else if (draggedItem.dataset.type === 'lore') {
        reorderLoreEntries(fromIndex, insertIndex);
    }
  }
  
  function handleDragEnd() {
    this.classList.remove('dragging');
    document.querySelectorAll('.drop-above, .drop-below').forEach(el => {
      el.classList.remove('drop-above', 'drop-below');
    });
    draggedItem = null;
  }
  
  // Reorder chapters
  async function reorderChapters(fromIndex, toIndex) {
    if (currentNovelIndex < 0 || !novels[currentNovelIndex].chapters) return;
    
    const chapters = novels[currentNovelIndex].chapters;
    
    // Make sure indices are valid
    if (fromIndex < 0 || fromIndex >= chapters.length || toIndex < 0 || toIndex > chapters.length) return;
    
    // Get the chapter to move
    const chapter = chapters[fromIndex];
    
    // Remove the chapter from its original position
    chapters.splice(fromIndex, 1);
    
    // Insert it at the new position
    chapters.splice(toIndex, 0, chapter);
    
    // If the current chapter was moved, update the current index
    if (novels[currentNovelIndex].currentChapterIndex === fromIndex) {
        novels[currentNovelIndex].currentChapterIndex = toIndex;
    } else if (novels[currentNovelIndex].currentChapterIndex > fromIndex && 
              novels[currentNovelIndex].currentChapterIndex <= toIndex) {
        novels[currentNovelIndex].currentChapterIndex--;
    } else if (novels[currentNovelIndex].currentChapterIndex < fromIndex && 
              novels[currentNovelIndex].currentChapterIndex >= toIndex) {
        novels[currentNovelIndex].currentChapterIndex++;
    }
    
    // Update UI and save
    updateChapterList();
    await saveToIndexedDB('novels', 'novelsData', novels);
  }
  
  // Reorder characters
  async function reorderCharacters(fromIndex, toIndex) {
    if (currentNovelIndex < 0 || !novels[currentNovelIndex].characters) return;
    
    const characters = novels[currentNovelIndex].characters;
    
    // Make sure indices are valid
    if (fromIndex < 0 || fromIndex >= characters.length || toIndex < 0 || toIndex > characters.length) return;
    
    // Get the character to move
    const character = characters[fromIndex];
    
    // Remove the character from its original position
    characters.splice(fromIndex, 1);
    
    // Insert it at the new position
    characters.splice(toIndex, 0, character);
    
    // Update UI and save
    updateCharacterList();
    await saveToIndexedDB('novels', 'novelsData', novels);
  }
  
  // Reorder lore entries
  async function reorderLoreEntries(fromIndex, toIndex) {
    if (currentNovelIndex < 0 || !novels[currentNovelIndex].lore) return;
    
    const lore = novels[currentNovelIndex].lore;
    
    // Make sure indices are valid
    if (fromIndex < 0 || fromIndex >= lore.length || toIndex < 0 || toIndex > lore.length) return;
    
    // Get the lore entry to move
    const loreEntry = lore[fromIndex];
    
    // Remove the lore entry from its original position
    lore.splice(fromIndex, 1);
    
    // Insert it at the new position
    lore.splice(toIndex, 0, loreEntry);
    
    // Update UI and save
    updateLoreList();
    await saveToIndexedDB('novels', 'novelsData', novels);
  }
  
  // Update the chapter list in the sidebar with editable titles
  function updateChapterList() {
    chapterList.innerHTML = '';
    
    if (currentNovelIndex < 0 || currentNovelIndex >= novels.length) return;
    
    let novel = novels[currentNovelIndex];
    
    novel.chapters.forEach((chapter, index) => {
      let li = document.createElement('li');
      li.className = 'chapter-item' + (index === novel.currentChapterIndex ? ' active' : '');
      li.draggable = true;
      li.dataset.index = index;
      li.dataset.type = 'chapter';
      
      li.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div style="display:flex; align-items:center; flex:1;">
            <span class="drag-handle">☰</span>
            <span class="chapter-title" data-index="${index}" style="cursor:text; max-width: 125px; text-overflow: ellipsis;">${chapter.title}</span>
          </div>
          <div>
            <button class="chapter-summary-btn" data-index="${index}" style="background:none; border:none; color:var(--secondary); cursor:pointer; font-size:12px; margin-right:5px;">📝</button>
            <button class="chapter-delete-btn" data-index="${index}" style="background:none; border:none; color:var(--danger); cursor:pointer; font-size:12px;">×</button>
          </div>
        </div>
      `;
      
      // Add event listeners for drag and drop
      li.addEventListener('dragstart', handleDragStart);
      li.addEventListener('dragover', handleDragOver);
      li.addEventListener('dragleave', handleDragLeave);
      li.addEventListener('drop', handleDrop);
      li.addEventListener('dragend', handleDragEnd);
      
      // Add click handler for the list item
      li.onclick = (e) => {
        // Don't trigger for buttons or when editing title or during drag
        if (e.target.tagName !== 'BUTTON' && !e.target.isContentEditable && !draggedItem) {
          saveCurrentChapter();
          saveToIndexedDB('novels', 'novelsData', novels); // Save to IndexedDB
          loadChapter(index);
          showEditor();
        }
      };
      
      chapterList.appendChild(li);
      
      // Add double-click handler for the chapter title to make it editable
      let titleSpan = li.querySelector('.chapter-title');
      titleSpan.addEventListener('dblclick', (e) => {
        e.stopPropagation();
        makeChapterTitleEditable(titleSpan, index);
      });
      
      // Add click handler for direct editing of chapter title
      titleSpan.addEventListener('click', (e) => {
        e.stopPropagation();
        makeChapterTitleEditable(titleSpan, index);
      });
      
      // Add click handlers for summary and delete buttons
      li.querySelector('.chapter-summary-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        openSummaryModal(parseInt(e.target.dataset.index));
      });
      
      li.querySelector('.chapter-delete-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        removeChapter(parseInt(e.target.dataset.index));
      });
    });
  }
  
  // Make a chapter title editable
  function makeChapterTitleEditable(titleElement, chapterIndex) {
    // Set the element to be editable
    titleElement.contentEditable = true;
    titleElement.focus();
    
    // Add visual styling to indicate it's editable
    titleElement.style.backgroundColor = "var(--input-bg)";
    titleElement.style.padding = "2px 5px";
    titleElement.style.border = "1px solid var(--input-border)";
    titleElement.style.borderRadius = "3px";
    
    // Select all text
    document.execCommand('selectAll', false, null);
    
    // Add event listeners to save when done editing
    titleElement.onblur = () => {
      saveChapterTitle(titleElement, chapterIndex);
    };
    
    titleElement.onkeydown = (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        titleElement.blur();
      } else if (e.key === 'Escape') {
        titleElement.textContent = novels[currentNovelIndex].chapters[chapterIndex].title;
        titleElement.contentEditable = false;
        resetTitleElementStyle(titleElement);
      }
    };
  }
  
  // Reset title element style after editing
  function resetTitleElementStyle(titleElement) {
    titleElement.style.backgroundColor = "";
    titleElement.style.padding = "";
    titleElement.style.border = "";
    titleElement.style.borderRadius = "";
  }
  
  // Save a chapter title after editing
  async function saveChapterTitle(titleElement, chapterIndex) {
    titleElement.contentEditable = false;
    resetTitleElementStyle(titleElement);
    
    if (titleElement.textContent.trim() === '') {
      titleElement.textContent = novels[currentNovelIndex].chapters[chapterIndex].title;
    } else {
      novels[currentNovelIndex].chapters[chapterIndex].title = titleElement.textContent;
      await saveToIndexedDB('novels', 'novelsData', novels); // Save to IndexedDB
    }
  }
  
  // Load chapter content into editor
  function loadChapter(index) {
    if (currentNovelIndex < 0) return;
    let novel = novels[currentNovelIndex];
    
    if (index < 0 || index >= novel.chapters.length) return;
    
    novel.currentChapterIndex = index;
    let chapter = novel.chapters[index];
    
    editor.innerHTML = chapter.content;
    
    updateChapterList();
    updateWordCount();
  }
  
  // Save current chapter content
  function saveCurrentChapter() {
    if (currentNovelIndex < 0) return;
    let novel = novels[currentNovelIndex];
    
    if (novel.currentChapterIndex < 0) return;
    
    novel.chapters[novel.currentChapterIndex].content = editor.innerHTML;
  }
  
  // Remove a chapter from the current novel
  async function removeChapter(index) {
    if (currentNovelIndex < 0) return;
    let novel = novels[currentNovelIndex];
    
    if (confirm('Are you sure you want to delete this chapter?')) {
      novel.chapters.splice(index, 1);
      
      if (novel.currentChapterIndex === index) {
        novel.currentChapterIndex = Math.min(index, novel.chapters.length - 1);
      } else if (novel.currentChapterIndex > index) {
        novel.currentChapterIndex--;
      }
      
      updateChapterList();
      
      if (novel.chapters.length === 0) {
        addChapter();
      } else {
        loadChapter(novel.currentChapterIndex);
      }
      
      await saveToIndexedDB('novels', 'novelsData', novels); // Save to IndexedDB
    }
  }

  // Add a new character image
  function addCharacterImage() {
    // Create a new empty image slot
    const imageIndex = characterImagesData.length;
    characterImagesData.push(null); // Add empty placeholder in array
    
    // Add empty image to UI
    addImageToUI(imageIndex, null);
    
    // Set as current and open file dialog
    currentImageIndex = imageIndex;
    document.getElementById('charImageInput').click();
  }

  // Add image to the UI
  function addImageToUI(index, imageData) {
    const imageContainer = document.createElement('div');
    imageContainer.className = 'character-image-item';
    imageContainer.dataset.index = index;
    
    if (imageData) {
      // If there's image data, show the image
      const img = document.createElement('img');
      img.src = imageData;
      img.style.cssText = 'max-width:100%; max-height:100%; object-fit:cover;';
      img.onclick = (e) => openImagePreview(e, imageData);
      imageContainer.appendChild(img);
      
      // Add remove button
      const removeBtn = document.createElement('button');
      removeBtn.textContent = '×';
      removeBtn.style.cssText = 'position:absolute; top:0; right:0; background:rgba(244,67,54,0.8); color:white; border:none; width:24px; height:24px; border-radius:50%; cursor:pointer;';
      removeBtn.onclick = (e) => {
        e.stopPropagation();
        removeCharacterImage(index);
      };
      imageContainer.appendChild(removeBtn);
    } else {
      // Empty slot
      const placeholderText = document.createElement('span');
      placeholderText.textContent = 'Click to add';
      placeholderText.style.color = 'var(--text-light)';
      imageContainer.appendChild(placeholderText);
      
      // Make the container clickable to add an image
      imageContainer.style.cursor = 'pointer';
      imageContainer.onclick = () => {
        currentImageIndex = index;
        document.getElementById('charImageInput').click();
      };
    }
    
    charImagesContainer.appendChild(imageContainer);
  }

  // Preview the character image when selected
  function previewCharacterImage(input) {
    const file = input.files[0];
    if (file && currentImageIndex >= 0) {
      const reader = new FileReader();
      reader.onload = function(e) {
        // Save the image data at the current index
        characterImagesData[currentImageIndex] = e.target.result;
        
        // Update UI - refresh the images container
        refreshImagesContainer();
      };
      reader.readAsDataURL(file);
    }
  }

  // Remove a character image
  function removeCharacterImage(index) {
    if (index === undefined) {
      // If no index provided, remove all images
      characterImagesData = [];
    } else {
      // Remove specific image
      characterImagesData.splice(index, 1);
    }
    
    // Refresh the images container
    refreshImagesContainer();
  }

  // Refresh the images container to reflect the current state
  function refreshImagesContainer() {
    // Clear the container
    charImagesContainer.innerHTML = '';
    
    // Add existing images
    characterImagesData.forEach((imageData, index) => {
      if (imageData) {
        addImageToUI(index, imageData);
      }
    });
    
    // Add an empty slot if there are no images or all slots have images
    if (characterImagesData.length === 0 || !characterImagesData.includes(null)) {
      addImageToUI(characterImagesData.length, null);
    }
  }

  // Open full-size image preview when clicking on the thumbnail
  function openImagePreview(event, imageData) {
    event.stopPropagation(); // Prevent triggering the container click
    
    if (!imageData) return;
    
    fullSizeCharacterImage.src = imageData;
    characterImagePreviewModal.style.display = 'flex';
  }

  // Close the image preview modal
  function closeImagePreviewModal() {
    characterImagePreviewModal.style.display = 'none';
  }
  
  // Character management functions
  // Add a new character to the current novel
  function addCharacter() {
    if (currentNovelIndex < 0) return;
    
    // Initialize characters array if it doesn't exist
    if (!novels[currentNovelIndex].characters) {
      novels[currentNovelIndex].characters = [];
    }
    
    // Clear the character form for a new character
    clearCharacterForm();
    
    // Set the current character index to -1 to indicate a new character
    currentCharacterIndex = -1;
    characterImagesData = []; // Initialize with empty array
    
    // Initialize the images container
    refreshImagesContainer();
    
    // Hide the novel list and editor containers when showing character editor
    novelListContainer.style.display = 'none';
    editorContainer.style.display = 'none';
    loreEditorContainer.style.display = 'none';
    timelineContainer.style.display = 'none';
    
    // Show the character editor
    novelEditorContainer.style.display = 'none';
    characterEditorContainer.style.display = 'flex';
    
    // Hide sidebar in mobile view when not in editor
    if (window.innerWidth <= 768) {
      sidebar.style.display = 'none';
    }
    
    characterEditTitle.textContent = 'New Character';

  }
  
  // Save the character from the form
  async function saveCharacter(event) {
    event.preventDefault();
    
    if (currentNovelIndex < 0) return;
    
    // Get the character data from the form
    const character = {
      name: charName.value,
      role: charRole.value,
      age: charAge.value,
      gender: charGender.value,
      occupation: charOccupation.value,
      images: characterImagesData.filter(img => img !== null), // Save array of image data, filtering out null values
      appearance: {
        height: charHeight.value,
        build: charBuild.value,
        hair: charHair.value,
        eyes: charEyes.value,
        skin: charSkin.value,
        clothing: charFeatures.value
      },
      personality: charPersonality.value,
      backstory: charBackstory.value,
      motivation: charMotivation.value,
      flaws: charFlaws.value,
      strengths: charStrengths.value,
      relationships: charRelationships.value,
      notes: charNotes.value
    };
    
    // Initialize characters array if it doesn't exist
    if (!novels[currentNovelIndex].characters) {
      novels[currentNovelIndex].characters = [];
    }
    
    if (currentCharacterIndex === -1) {
      // Add new character
      novels[currentNovelIndex].characters.push(character);
    } else {
      // Update existing character
      novels[currentNovelIndex].characters[currentCharacterIndex] = character;
    }
    
    // Update the character list
    updateCharacterList();
    
    // Save to IndexedDB
    await saveToIndexedDB('novels', 'novelsData', novels);
    
    // Close the character editor
    closeCharacterEditor();
    
    // Show a confirmation
    alert(`Character "${character.name}" has been saved!`);
  }
  
  // Edit a character
  function editCharacter(index) {
    if (currentNovelIndex < 0 || !novels[currentNovelIndex].characters) return;
    
    currentCharacterIndex = index;
    const character = novels[currentNovelIndex].characters[index];
    
    // Populate the form with character data
    charName.value = character.name || '';
    charRole.value = character.role || 'Support Character';
    charAge.value = character.age || '';
    charGender.value = character.gender || '';
    charOccupation.value = character.occupation || '';
    
    // Handle character images - check for both legacy single image and new array of images
    if (character.images) {
      // New format - array of images
      characterImagesData = [...character.images];
    } else if (character.image) {
      // Legacy format - single image
      characterImagesData = character.image ? [character.image] : [];
    } else {
      characterImagesData = [];
    }
    
    // Refresh the images container
    refreshImagesContainer();
    
    // Appearance
    if (character.appearance) {
      charHeight.value = character.appearance.height || '';
      charBuild.value = character.appearance.build || '';
      charHair.value = character.appearance.hair || '';
      charEyes.value = character.appearance.eyes || '';
      charSkin.value = character.appearance.skin || '';
      charFeatures.value = character.appearance.clothing || '';
    } else {
      charHeight.value = '';
      charBuild.value = '';
      charHair.value = '';
      charEyes.value = '';
      charSkin.value = '';
      charFeatures.value = '';
    }
    
    charPersonality.value = character.personality || '';
    charBackstory.value = character.backstory || '';
    charMotivation.value = character.motivation || '';
    charFlaws.value = character.flaws || '';
    charStrengths.value = character.strengths || '';
    charRelationships.value = character.relationships || '';
    charNotes.value = character.notes || '';
    
    // Hide the novel list and editor containers when showing character editor
    novelListContainer.style.display = 'none';
    editorContainer.style.display = 'none';
    loreEditorContainer.style.display = 'none';
    timelineContainer.style.display = 'none';
    
    // Show the character editor
    novelEditorContainer.style.display = 'none';
    characterEditorContainer.style.display = 'flex';
    
    // Hide sidebar in mobile view when not in editor
    if (window.innerWidth <= 768) {
      sidebar.style.display = 'none';
    }
    
    characterEditTitle.textContent = `Edit Character: ${character.name}`;

  }
  
  // Clear the character form
  function clearCharacterForm() {
    characterForm.reset();
    charName.value = '';
    charRole.value = 'Support Character';
    charAge.value = '';
    charGender.value = '';
    charOccupation.value = '';
    charHeight.value = '';
    charBuild.value = '';
    charHair.value = '';
    charEyes.value = '';
    charSkin.value = '';
    charFeatures.value = '';
    charPersonality.value = '';
    charBackstory.value = '';
    charMotivation.value = '';
    charFlaws.value = '';
    charStrengths.value = '';
    charRelationships.value = '';
    charNotes.value = '';
    
    // Clear images
    characterImagesData = [];
    refreshImagesContainer();
  }
  
  // Close the character editor
  function closeCharacterEditor() {
    characterEditorContainer.style.display = 'none';
    editorContainer.style.display = 'flex';
  }
  
  // Update the character list in the sidebar
  function updateCharacterList() {
    characterList.innerHTML = '';
    
    if (currentNovelIndex < 0 || currentNovelIndex >= novels.length) return;
    
    // Initialize characters array if it doesn't exist
    if (!novels[currentNovelIndex].characters) {
      novels[currentNovelIndex].characters = [];
    }
    
    let novel = novels[currentNovelIndex];
    
    novel.characters.forEach((character, index) => {
      let li = document.createElement('li');
      li.className = 'character-item';
      li.draggable = true;
      li.dataset.index = index;
      li.dataset.type = 'character';
      
      // Check for both new (images array) and legacy (single image) formats
      const hasImages = character.images && character.images.length > 0;
      const hasLegacyImage = character.image ? true : false;
      const primaryImage = hasImages ? character.images[0] : (hasLegacyImage ? character.image : null);
      const totalImages = hasImages ? character.images.length : (hasLegacyImage ? 1 : 0);
      
      li.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
          <div style="display:flex; align-items:flex-start; flex:1;">
            <span class="drag-handle">☰</span>
            <div style="display:flex; flex-direction:column;">
              <span class="character-title" style="width: 125px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${character.name}</span>
              <span style="font-size:0.8em; color:var(--text-light);">${character.role || 'Character'}</span>
            </div>
          </div>
          <div>
            <button class="character-edit-btn" data-index="${index}" style="background:none; border:none; cursor:pointer; color:var(--secondary); font-size:12px; margin-right:5px;">✏️</button>
            <button class="character-delete-btn" data-index="${index}" style="background:none; border:none; color:var(--danger); cursor:pointer; font-size:12px;">×</button>
          </div>
        </div>
      `;
      
      // Add event listeners for drag and drop
      li.addEventListener('dragstart', handleDragStart);
      li.addEventListener('dragover', handleDragOver);
      li.addEventListener('dragleave', handleDragLeave);
      li.addEventListener('drop', handleDrop);
      li.addEventListener('dragend', handleDragEnd);
      
      characterList.appendChild(li);
      
      // Add click handler to edit when clicking on character name
      li.querySelector('.character-title').addEventListener('click', function(e) {
        e.stopPropagation();
        editCharacter(index);
      });
      
      // Add click handlers for edit and delete buttons
      li.querySelector('.character-edit-btn').addEventListener('click', function(e) {
        e.stopPropagation();
        editCharacter(parseInt(e.target.dataset.index));
      });
      
      li.querySelector('.character-delete-btn').addEventListener('click', function(e) {
        e.stopPropagation();
        removeCharacter(parseInt(e.target.dataset.index));
      });
    });
  }
  
  // Remove a character
  async function removeCharacter(index) {
    if (currentNovelIndex < 0 || !novels[currentNovelIndex].characters) return;
    
    const character = novels[currentNovelIndex].characters[index];
    
    if (confirm(`Are you sure you want to delete the character "${character.name}"?`)) {
      novels[currentNovelIndex].characters.splice(index, 1);
      updateCharacterList();
      await saveToIndexedDB('novels', 'novelsData', novels); // Save to IndexedDB
    }
  }
  
  // Lore management functions
  // Add a new lore entry to the current novel
  function addLore() {
    if (currentNovelIndex < 0) return;
    
    // Initialize lore array if it doesn't exist
    if (!novels[currentNovelIndex].lore) {
      novels[currentNovelIndex].lore = [];
    }
    
    // Clear the lore form for a new entry
    clearLoreForm();
    
    // Set the current lore index to -1 to indicate a new entry
    currentLoreIndex = -1;
    loreImagesData = []; // Initialize with empty array
    
    // Initialize the images container
    refreshLoreImagesContainer();
    
    // Hide category-specific fields initially
    hideAllCategoryFields();
    
    // Hide the novel list and editor containers when showing lore editor
    novelListContainer.style.display = 'none';
    editorContainer.style.display = 'none';
    characterEditorContainer.style.display = 'none';
    timelineContainer.style.display = 'none';
    
    // Show the lore editor
    novelEditorContainer.style.display = 'none';
    loreEditorContainer.style.display = 'flex';
    
    // Hide sidebar in mobile view when not in editor
    if (window.innerWidth <= 768) {
      sidebar.style.display = 'none';
    }
    
    loreEditTitle.textContent = 'New Lore Entry';

  }
  
  // Toggle category-specific fields based on selection
  function toggleLoreCategoryFields() {
    // Hide all category-specific fields first
    hideAllCategoryFields();
    
    // Show fields specific to the selected category
    const category = loreCategory.value;
    
    if (category === 'Location') {
      document.getElementById('locationFields').style.display = 'block';
    } else if (category === 'Item') {
      document.getElementById('itemFields').style.display = 'block';
    } else if (category === 'Creature') {
      document.getElementById('creatureFields').style.display = 'block';
    } else if (category === 'Organization') {
      document.getElementById('organizationFields').style.display = 'block';
    } else if (category === 'Event') {
      document.getElementById('eventFields').style.display = 'block';
    }
  }
  
  // Hide all category-specific fields
  function hideAllCategoryFields() {
    document.querySelectorAll('.category-fields').forEach(field => {
      field.style.display = 'none';
    });
  }
  
  // Clear the lore form
  function clearLoreForm() {
    loreForm.reset();
    loreName.value = '';
    loreCategory.value = '';
    loreCustomCategory.value = '';
    loreDescription.value = '';
    loreNotes.value = '';
    
    // Clear category-specific fields
    // Location
    locationType.value = 'City';
    locationClimate.value = '';
    locationPopulation.value = '';
    locationGovernment.value = '';
    locationHistory.value = '';
    locationCulture.value = '';
    locationEconomy.value = '';
    locationNotableFeatures.value = '';
    
    // Item
    itemType.value = 'Weapon';
    itemCreator.value = '';
    itemAge.value = '';
    itemAppearance.value = '';
    itemMaterials.value = '';
    itemPowers.value = '';
    itemHistory.value = '';
    itemOwnership.value = '';
    itemValue.value = '';
    
    // Creature
    creatureType.value = '';
    creatureHabitat.value = '';
    creatureAppearance.value = '';
    creatureAbilities.value = '';
    creatureBehavior.value = '';
    creatureDiet.value = '';
    creatureLifecycle.value = '';
    creatureSociety.value = '';
    creatureHistory.value = '';
    creatureWeaknesses.value = '';
    
    // Organization
    orgType.value = 'Government';
    orgLeadership.value = '';
    orgHeadquarters.value = '';
    orgStructure.value = '';
    orgGoals.value = '';
    orgMethods.value = '';
    orgResources.value = '';
    orgHistory.value = '';
    orgAllies.value = '';
    orgEnemies.value = '';
    
    // Event
    eventType.value = 'Battle';
    eventDate.value = '';
    eventLocation.value = '';
    eventParticipants.value = '';
    eventCauses.value = '';
    eventOutcome.value = '';
    eventConsequences.value = '';
    eventCulturalImpact.value = '';
    eventCommemoration.value = '';
    
    // Custom category
    customCategoryContainer.style.display = 'none';
    
    // Show appropriate category fields
    toggleLoreCategoryFields();
    
    // Clear images
    loreImagesData = [];
    refreshLoreImagesContainer();
  }
  
  // Add a new lore image
  function addLoreImage() {
    // Create a new empty image slot
    const imageIndex = loreImagesData.length;
    loreImagesData.push(null); // Add empty placeholder in array
    
    // Add empty image to UI
    addLoreImageToUI(imageIndex, null);
    
    // Set as current and open file dialog
    currentImageIndex = imageIndex;
    document.getElementById('loreImageInput').click();
  }
  
  // Add lore image to the UI
  function addLoreImageToUI(index, imageData) {
    const imageContainer = document.createElement('div');
    imageContainer.className = 'lore-image-item';
    imageContainer.dataset.index = index;
    
    if (imageData) {
      // If there's image data, show the image
      const img = document.createElement('img');
      img.src = imageData;
      img.style.cssText = 'max-width:100%; max-height:100%; object-fit:cover;';
      img.onclick = (e) => openLoreImagePreview(e, imageData);
      imageContainer.appendChild(img);
      
      // Add remove button
      const removeBtn = document.createElement('button');
      removeBtn.textContent = '×';
      removeBtn.style.cssText = 'position:absolute; top:0; right:0; background:rgba(244,67,54,0.8); color:white; border:none; width:24px; height:24px; border-radius:50%; cursor:pointer;';
      removeBtn.onclick = (e) => {
        e.stopPropagation();
        removeLoreImage(index);
      };
      imageContainer.appendChild(removeBtn);
    } else {
      // Empty slot
      const placeholderText = document.createElement('span');
      placeholderText.textContent = 'Click to add';
      placeholderText.style.color = 'var(--text-light)';
      imageContainer.appendChild(placeholderText);
      
      // Make the container clickable to add an image
      imageContainer.style.cursor = 'pointer';
      imageContainer.onclick = () => {
        currentImageIndex = index;
        document.getElementById('loreImageInput').click();
      };
    }
    
    loreImagesContainer.appendChild(imageContainer);
  }
  
  // Preview the lore image when selected
  function previewLoreImage(input) {
    const file = input.files[0];
    if (file && currentImageIndex >= 0) {
      const reader = new FileReader();
      reader.onload = function(e) {
        // Save the image data at the current index
        loreImagesData[currentImageIndex] = e.target.result;
        
        // Update UI - refresh the images container
        refreshLoreImagesContainer();
      };
      reader.readAsDataURL(file);
    }
  }
  
  // Remove a lore image
  function removeLoreImage(index) {
    if (index === undefined) {
      // If no index provided, remove all images
      loreImagesData = [];
    } else {
      // Remove specific image
      loreImagesData.splice(index, 1);
    }
    
    // Refresh the images container
    refreshLoreImagesContainer();
  }
  
  // Refresh the lore images container to reflect the current state
  function refreshLoreImagesContainer() {
    // Clear the container
    loreImagesContainer.innerHTML = '';
    
    // Add existing images
    loreImagesData.forEach((imageData, index) => {
      if (imageData) {
        addLoreImageToUI(index, imageData);
      }
    });
    
    // Add an empty slot if there are no images or all slots have images
    if (loreImagesData.length === 0 || !loreImagesData.includes(null)) {
      addLoreImageToUI(loreImagesData.length, null);
    }
  }
  
  // Open full-size lore image preview when clicking on the thumbnail
  function openLoreImagePreview(event, imageData) {
    event.stopPropagation(); // Prevent triggering the container click
    
    if (!imageData) return;
    
    fullSizeLoreImage.src = imageData;
    loreImagePreviewModal.style.display = 'flex';
  }
  
  // Close the lore image preview modal
  function closeLoreImagePreviewModal() {
    loreImagePreviewModal.style.display = 'none';
  }
  
  // Save the lore entry from the form
  async function saveLore(event) {
    event.preventDefault();
    
    if (currentNovelIndex < 0) return;
    
    // Initialize lore array if it doesn't exist
    if (!novels[currentNovelIndex].lore) {
      novels[currentNovelIndex].lore = [];
    }
    
    // Get general lore data
    const loreData = {
      name: loreName.value,
      category: loreCategory.value,
      customCategory: loreCategory.value === 'Custom' ? loreCustomCategory.value : '',
      description: loreDescription.value,
      notes: loreNotes.value,
      images: loreImagesData.filter(img => img !== null) // Save array of image data, filtering out null values
    };
    
    // Add category-specific data
    if (loreCategory.value === 'Location') {
      loreData.locationDetails = {
        type: locationType.value,
        climate: locationClimate.value,
        population: locationPopulation.value,
        government: locationGovernment.value,
        history: locationHistory.value,
        culture: locationCulture.value,
        economy: locationEconomy.value,
        notableFeatures: locationNotableFeatures.value
      };
    } else if (loreCategory.value === 'Item') {
      loreData.itemDetails = {
        type: itemType.value,
        creator: itemCreator.value,
        age: itemAge.value,
        appearance: itemAppearance.value,
        materials: itemMaterials.value,
        powers: itemPowers.value,
        history: itemHistory.value,
        ownership: itemOwnership.value,
        value: itemValue.value
      };
    } else if (loreCategory.value === 'Creature') {
      loreData.creatureDetails = {
        type: creatureType.value,
        habitat: creatureHabitat.value,
        appearance: creatureAppearance.value,
        abilities: creatureAbilities.value,
        behavior: creatureBehavior.value,
        diet: creatureDiet.value,
        lifecycle: creatureLifecycle.value,
        society: creatureSociety.value,
        history: creatureHistory.value,
        weaknesses: creatureWeaknesses.value
      };
    } else if (loreCategory.value === 'Organization') {
      loreData.organizationDetails = {
        type: orgType.value,
        leadership: orgLeadership.value,
        headquarters: orgHeadquarters.value,
        structure: orgStructure.value,
        goals: orgGoals.value,
        methods: orgMethods.value,
        resources: orgResources.value,
        history: orgHistory.value,
        allies: orgAllies.value,
        enemies: orgEnemies.value
      };
    } else if (loreCategory.value === 'Event') {
      loreData.eventDetails = {
        type: eventType.value,
        date: eventDate.value,
        location: eventLocation.value,
        participants: eventParticipants.value,
        causes: eventCauses.value,
        outcome: eventOutcome.value,
        consequences: eventConsequences.value,
        culturalImpact: eventCulturalImpact.value,
        commemoration: eventCommemoration.value
      };
    }
    
    if (currentLoreIndex === -1) {
      // Add new lore entry
      novels[currentNovelIndex].lore.push(loreData);
    } else {
      // Update existing lore entry
      novels[currentNovelIndex].lore[currentLoreIndex] = loreData;
    }
    
    // Update the lore list
    updateLoreList();
    
    // Save to IndexedDB
    await saveToIndexedDB('novels', 'novelsData', novels);
    
    // Close the lore editor
    closeLoreEditor();
    
    // Show a confirmation
    alert(`Lore entry "${loreData.name}" has been saved!`);
  }
  
  // Close the lore editor
  function closeLoreEditor() {
    loreEditorContainer.style.display = 'none';
    editorContainer.style.display = 'flex';
  }
  
  // Edit a lore entry
  function editLore(index) {
    if (currentNovelIndex < 0 || !novels[currentNovelIndex].lore) return;
    
    currentLoreIndex = index;
    const loreEntry = novels[currentNovelIndex].lore[index];
    
    // Populate the form with lore data
    loreName.value = loreEntry.name || '';
    loreCategory.value = loreEntry.category || 'Location';
    loreDescription.value = loreEntry.description || '';
    loreNotes.value = loreEntry.notes || '';
    
    // Handle custom category
    if (loreEntry.category === 'Custom') {
      customCategoryContainer.style.display = 'block';
      loreCustomCategory.value = loreEntry.customCategory || '';
    } else {
      customCategoryContainer.style.display = 'none';
    }
    
    // Toggle category fields
    toggleLoreCategoryFields();
    
    // Handle lore images
    loreImagesData = loreEntry.images ? [...loreEntry.images] : [];
    
    // Refresh the images container
    refreshLoreImagesContainer();
    
    // Fill category-specific fields
    if (loreEntry.category === 'Location' && loreEntry.locationDetails) {
      locationType.value = loreEntry.locationDetails.type || 'City';
      locationClimate.value = loreEntry.locationDetails.climate || '';
      locationPopulation.value = loreEntry.locationDetails.population || '';
      locationGovernment.value = loreEntry.locationDetails.government || '';
      locationHistory.value = loreEntry.locationDetails.history || '';
      locationCulture.value = loreEntry.locationDetails.culture || '';
      locationEconomy.value = loreEntry.locationDetails.economy || '';
      locationNotableFeatures.value = loreEntry.locationDetails.notableFeatures || '';
    } else if (loreEntry.category === 'Item' && loreEntry.itemDetails) {
      itemType.value = loreEntry.itemDetails.type || 'Weapon';
      itemCreator.value = loreEntry.itemDetails.creator || '';
      itemAge.value = loreEntry.itemDetails.age || '';
      itemAppearance.value = loreEntry.itemDetails.appearance || '';
      itemMaterials.value = loreEntry.itemDetails.materials || '';
      itemPowers.value = loreEntry.itemDetails.powers || '';
      itemHistory.value = loreEntry.itemDetails.history || '';
      itemOwnership.value = loreEntry.itemDetails.ownership || '';
      itemValue.value = loreEntry.itemDetails.value || '';
    } else if (loreEntry.category === 'Creature' && loreEntry.creatureDetails) {
      creatureType.value = loreEntry.creatureDetails.type || '';
      creatureHabitat.value = loreEntry.creatureDetails.habitat || '';
      creatureAppearance.value = loreEntry.creatureDetails.appearance || '';
      creatureAbilities.value = loreEntry.creatureDetails.abilities || '';
      creatureBehavior.value = loreEntry.creatureDetails.behavior || '';
      creatureDiet.value = loreEntry.creatureDetails.diet || '';
      creatureLifecycle.value = loreEntry.creatureDetails.lifecycle || '';
      creatureSociety.value = loreEntry.creatureDetails.society || '';
      creatureHistory.value = loreEntry.creatureDetails.history || '';
      creatureWeaknesses.value = loreEntry.creatureDetails.weaknesses || '';
    } else if (loreEntry.category === 'Organization' && loreEntry.organizationDetails) {
      orgType.value = loreEntry.organizationDetails.type || 'Government';
      orgLeadership.value = loreEntry.organizationDetails.leadership || '';
      orgHeadquarters.value = loreEntry.organizationDetails.headquarters || '';
      orgStructure.value = loreEntry.organizationDetails.structure || '';
      orgGoals.value = loreEntry.organizationDetails.goals || '';
      orgMethods.value = loreEntry.organizationDetails.methods || '';
      orgResources.value = loreEntry.organizationDetails.resources || '';
      orgHistory.value = loreEntry.organizationDetails.history || '';
      orgAllies.value = loreEntry.organizationDetails.allies || '';
      orgEnemies.value = loreEntry.organizationDetails.enemies || '';
    } else if (loreEntry.category === 'Event' && loreEntry.eventDetails) {
      eventType.value = loreEntry.eventDetails.type || 'Battle';
      eventDate.value = loreEntry.eventDetails.date || '';
      eventLocation.value = loreEntry.eventDetails.location || '';
      eventParticipants.value = loreEntry.eventDetails.participants || '';
      eventCauses.value = loreEntry.eventDetails.causes || '';
      eventOutcome.value = loreEntry.eventDetails.outcome || '';
      eventConsequences.value = loreEntry.eventDetails.consequences || '';
      eventCulturalImpact.value = loreEntry.eventDetails.culturalImpact || '';
      eventCommemoration.value = loreEntry.eventDetails.commemoration || '';
    }
    
    // Hide the novel list and editor containers when showing lore editor
    novelListContainer.style.display = 'none';
    editorContainer.style.display = 'none';
    characterEditorContainer.style.display = 'none';
    timelineContainer.style.display = 'none';
    
    // Show the lore editor
    novelEditorContainer.style.display = 'none';
    loreEditorContainer.style.display = 'flex';
    
    // Hide sidebar in mobile view when not in editor
    if (window.innerWidth <= 768) {
      sidebar.style.display = 'none';
    }
    
    loreEditTitle.textContent = `Edit Lore: ${loreEntry.name}`;
    
  }
  
  // Update the lore list in the sidebar
  function updateLoreList() {
    loreList.innerHTML = '';
    
    if (currentNovelIndex < 0 || currentNovelIndex >= novels.length) return;
    
    // Initialize lore array if it doesn't exist
    if (!novels[currentNovelIndex].lore) {
      novels[currentNovelIndex].lore = [];
    }
    
    let novel = novels[currentNovelIndex];
    
    novel.lore.forEach((loreEntry, index) => {
      let li = document.createElement('li');
      li.className = 'lore-item';
      li.draggable = true;
      li.dataset.index = index;
      li.dataset.type = 'lore';
      
      // Determine the category to display
      let categoryDisplay = loreEntry.category;
      if (loreEntry.category === 'Custom' && loreEntry.customCategory) {
        categoryDisplay = loreEntry.customCategory;
      }
      
      // Check for images
      const hasImages = loreEntry.images && loreEntry.images.length > 0;
      const primaryImage = hasImages ? loreEntry.images[0] : null;
      const totalImages = hasImages ? loreEntry.images.length : 0;
      
      li.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
          <div style="display:flex; align-items:flex-start; flex:1;">
            <span class="drag-handle">☰</span>
            <div style="display:flex; flex-direction:column;">
            <span class="lore-title" style="width: 125px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${loreEntry.name}</span>
            <span style="font-size:0.8em; color:var(--text-light);">${categoryDisplay}</span>
            ${totalImages > 1 ? `<span style="margin-left:5px; font-size:0.8em; color:var(--secondary);">[${totalImages} images]</span>` : ''}
          </div>
          </div>
          <div>
            <button class="lore-edit-btn" data-index="${index}" style="background:none; border:none; cursor:pointer; color:var(--secondary); font-size:12px; margin-right:5px;">✏️</button>
            <button class="lore-delete-btn" data-index="${index}" style="background:none; border:none; color:var(--danger); cursor:pointer; font-size:12px;">×</button>
          </div>
        </div>
`;
      
      // Add event listeners for drag and drop
      li.addEventListener('dragstart', handleDragStart);
      li.addEventListener('dragover', handleDragOver);
      li.addEventListener('dragleave', handleDragLeave);
      li.addEventListener('drop', handleDrop);
      li.addEventListener('dragend', handleDragEnd);
      
      loreList.appendChild(li);
      
      // Add click handler to edit when clicking on lore name
      li.querySelector('.lore-title').addEventListener('click', function(e) {
        e.stopPropagation();
        editLore(index);
      });
      
      // Add click handlers for edit and delete buttons
      li.querySelector('.lore-edit-btn').addEventListener('click', function(e) {
        e.stopPropagation();
        editLore(parseInt(e.target.dataset.index));
      });
      
      li.querySelector('.lore-delete-btn').addEventListener('click', function(e) {
        e.stopPropagation();
        removeLore(parseInt(e.target.dataset.index));
      });
    });
  }
  
  // Remove a lore entry
  async function removeLore(index) {
    if (currentNovelIndex < 0 || !novels[currentNovelIndex].lore) return;
    
    const loreEntry = novels[currentNovelIndex].lore[index];
    
    if (confirm(`Are you sure you want to delete the lore entry "${loreEntry.name}"?`)) {
      novels[currentNovelIndex].lore.splice(index, 1);
      updateLoreList();
      await saveToIndexedDB('novels', 'novelsData', novels); // Save to IndexedDB
    }
  }
  
  // Format text in the editor
  function formatText(command, value = null) {
    // Special handling for indent and outdent commands
    if (command === 'indent') {
      indentFirstLineOnly();
    } else if (command === 'outdent') {
      outdentFirstLineOnly();
    } else {
      // Default behavior for other commands
      document.execCommand(command, false, value);
    }
    
    editor.focus();
    
    // Save to IndexedDB after formatting
    autoSaveEdit();
  }

  // Indent only the first line of selected paragraphs
  function indentFirstLineOnly() {
    // Get selected paragraphs
    const paragraphs = getSelectedParagraphs();
    
    // Apply first line indentation
    paragraphs.forEach(p => {
      const currentIndent = parseInt(window.getComputedStyle(p).textIndent) || 0;
      p.style.textIndent = (currentIndent + 40) + 'px';
    });
  }

  // Outdent only the first line of selected paragraphs
  function outdentFirstLineOnly() {
    // Get selected paragraphs
    const paragraphs = getSelectedParagraphs();
    
    // Reduce first line indentation
    paragraphs.forEach(p => {
      const currentIndent = parseInt(window.getComputedStyle(p).textIndent) || 0;
      if (currentIndent > 0) {
        p.style.textIndent = Math.max(currentIndent - 40, 0) + 'px';
      }
    });
  }

  // Helper function to get paragraphs in selection
  function getSelectedParagraphs() {
    const selection = window.getSelection();
    if (!selection.rangeCount) return [];
    
    const range = selection.getRangeAt(0);
    const paragraphs = [];
    
    // If selection is collapsed (cursor)
    if (range.collapsed) {
      let node = range.startContainer;
      if (node.nodeType === Node.TEXT_NODE) {
        node = node.parentNode;
      }
      
      while (node && node !== editor) {
        if (isParagraphElement(node)) {
          paragraphs.push(node);
          break;
        }
        node = node.parentNode;
      }
    } 
    // If selection spans multiple nodes
    else {
      const allParagraphs = editor.querySelectorAll('p, div, h1, h2, h3, h4, h5, h6, li, blockquote, pre');
      
      allParagraphs.forEach(p => {
        if (nodeIntersectsRange(p, range)) {
          paragraphs.push(p);
        }
      });
    }
    
    return paragraphs;
  }

  // Check if element is paragraph-like
  function isParagraphElement(node) {
    if (!node || node.nodeType !== Node.ELEMENT_NODE) return false;
    const name = node.nodeName.toLowerCase();
    return ['p', 'div', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'li', 'blockquote', 'pre'].includes(name);
  }

  // Check if node intersects with range
  function nodeIntersectsRange(node, range) {
    // Simple check if node contains either the start or end of the range
    return node.contains(range.startContainer) || node.contains(range.endContainer);
  }
  
  // Insert link
  function insertLink() {
    let url = prompt('Enter the URL:', 'http://');
    if (url) {
      let text = document.getSelection().toString();
      if (!text) {
        text = url;
      }
      formatText('insertHTML', `<a href="${url}" target="_blank">${text}</a>`);
    }
  }
  
  // Image Modal Functions
  function insertImage() {
    // Reset the form
    imageUrl.value = '';
    imageAltUrl.value = '';
    imageFile.value = '';
    imageAltUpload.value = '';
    imagePreview.style.display = 'none';
    
    // Show URL tab by default
    switchImageTab('url');
    
    // Show the modal
    imageModal.style.display = 'flex';
  }
  
  function switchImageTab(tab) {
    if (tab === 'url') {
      urlTab.style.display = 'block';
      uploadTab.style.display = 'none';
      urlTabBtn.style.background = 'var(--primary)';
      urlTabBtn.style.color = 'white';
      uploadTabBtn.style.background = 'var(--toolbar-bg)';
      uploadTabBtn.style.color = 'var(--text)';
    } else {
      urlTab.style.display = 'none';
      uploadTab.style.display = 'block';
      urlTabBtn.style.background = 'var(--toolbar-bg)';
      urlTabBtn.style.color = 'var(--text)';
      uploadTabBtn.style.background = 'var(--primary)';
      uploadTabBtn.style.color = 'white';
    }
  }
  
  function previewImage() {
    const file = imageFile.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        previewImg.src = e.target.result;
        imagePreview.style.display = 'block';
      };
      reader.readAsDataURL(file);
    } else {
      imagePreview.style.display = 'none';
    }
  }
  
  function confirmInsertImage() {
    let imageHtml = '';
    let altText = '';
    
    // Check which tab is active
    if (urlTab.style.display !== 'none') {
      // URL tab is active
      if (!imageUrl.value) {
        alert('Please enter an image URL.');
        return;
      }
      altText = imageAltUrl.value;
      imageHtml = `<img src="${imageUrl.value}" alt="${altText}" style="max-width:100%;">`;
    } else {
      // Upload tab is active
      if (!imageFile.files[0]) {
        alert('Please select an image to upload.');
        return;
      }
      altText = imageAltUpload.value;
      imageHtml = `<img src="${previewImg.src}" alt="${altText}" style="max-width:100%;">`;
    }
    
    formatText('insertHTML', imageHtml);
    closeImageModal();
    
    // Save to IndexedDB after inserting image
    autoSaveEdit();
  }
  
  function closeImageModal() {
    imageModal.style.display = 'none';
    editor.focus();
  }
  
  // Color modals and functions
  function showTextColorModal() {
    textColorModalPicker.value = "#000000"; // Default black
    textColorModal.style.display = 'flex';
  }

  function closeTextColorModal() {
    textColorModal.style.display = 'none';
    editor.focus();
  }

  function applyTextColor(color) {
    formatText('foreColor', color);
    closeTextColorModal();
  }

  function unsetTextColor() {
    formatText('removeFormat');
    closeTextColorModal();
  }

  function showBgColorModal() {
    bgColorModalPicker.value = "#ffffff"; // Default white
    bgColorModal.style.display = 'flex';
  }

  function closeBgColorModal() {
    bgColorModal.style.display = 'none';
    editor.focus();
  }

  function applyBgColor(color) {
    formatText('hiliteColor', color);
    closeBgColorModal();
  }

  function unsetBgColor() {
    formatText('hiliteColor', 'transparent');
    closeBgColorModal();
  }
  
  // Special Characters Modal Functions
  function showSpecialCharacters() {
    specialCharModal.style.display = 'flex';
  }
  
  function insertSpecialChar(char) {
    formatText('insertText', char);
    closeSpecialCharModal();
  }
  
  function closeSpecialCharModal() {
    specialCharModal.style.display = 'none';
    editor.focus();
  }
  
  // Insert table
  function insertTable() {
    let rows = prompt('Enter number of rows:', '3');
    let cols = prompt('Enter number of columns:', '3');
    
    if (rows && cols) {
      rows = parseInt(rows);
      cols = parseInt(cols);
      
      if (isNaN(rows) || isNaN(cols) || rows < 1 || cols < 1) {
        alert('Please enter valid numbers for rows and columns.');
        return;
      }
      
      let table = '<table border="1" style="width:100%;"><tbody>';
      
      // Create header row
      table += '<tr>';
      for (let j = 0; j < cols; j++) {
        table += '<th>Header ' + (j+1) + '</th>';
      }
      table += '</tr>';
      
      // Create data rows
      for (let i = 0; i < rows; i++) {
        table += '<tr>';
        for (let j = 0; j < cols; j++) {
          table += '<td>Cell ' + (i+1) + ',' + (j+1) + '</td>';
        }
        table += '</tr>';
      }
      
      table += '</tbody></table>';
      formatText('insertHTML', table);
      
      // Save to IndexedDB after inserting table
      autoSaveEdit();
    }
  }
  
  // Insert horizontal rule
  function insertHorizontalRule() {
    formatText('insertHorizontalRule');
    
    // Save to IndexedDB after inserting horizontal rule
    autoSaveEdit();
  }
  
  // Update word count
  function updateWordCount() {
    const text = editor.innerText || '';
    const words = text.trim().split(/\s+/).filter(word => word.length > 0);
    wordCount.textContent = words.length;
  }
  
  // Save all novels to IndexedDB
  async function saveNovels() {
    saveCurrentChapter();
    await saveToIndexedDB('novels', 'novelsData', novels);
    alert('All novels saved successfully!');
  }
  
  // Load novels from IndexedDB
  async function loadNovels() {
    try {
      const data = await getFromIndexedDB('novels', 'novelsData');
      if (!data) {
        // No data found, create a new novel
        novels = [];
        addNovel();
        return;
      }
      
      novels = data;
      
      // Ensure all novels have a characters array
      for (let novel of novels) {
        if (!novel.characters) {
          novel.characters = [];
        }
        
        // Add a lore array if it doesn't exist (for backwards compatibility)
        if (!novel.lore) {
          novel.lore = [];
        }
        
        // Ensure all chapters have a summary property (for backwards compatibility)
        if (novel.chapters) {
          for (let chapter of novel.chapters) {
            if (!chapter.hasOwnProperty('summary')) {
              chapter.summary = '';
            }
          }
        }
        
        // Add a timeline array if it doesn't exist (for backwards compatibility)
        if (!novel.timeline) {
          novel.timeline = [];
        }
        
        // Add timeline settings if they don't exist
        if (!novel.timelineSettings) {
          novel.timelineSettings = JSON.parse(JSON.stringify(timelineSettings));
        }
      }
      
      if (novels.length > 0) {
        currentNovelIndex = 0; // Default to first novel
        updateChapterList();
        updateCharacterList();
        updateLoreList();
        updateNovelList();
        
        // Load the first chapter of the current novel
        let novel = novels[currentNovelIndex];
        if (novel.chapters.length > 0) {
          loadChapter(novel.currentChapterIndex >= 0 ? novel.currentChapterIndex : 0);
        } else {
          addChapter();
        }
      } else {
        addNovel();
      }
    } catch (e) {
      console.error('Error loading novels:', e);
      alert('Error loading novels: ' + e.message);
      novels = [];
      addNovel();
    }
  }
  
  // Toggle menu dropdown
  function toggleMenu() {
    const menuDropdown = document.getElementById('menuDropdown');
    if (menuDropdown.style.display === "none" || menuDropdown.style.display === "") {
      menuDropdown.style.display = "block";
      setTimeout(() => document.addEventListener('click', closeMenuOutside), 0);
    } else {
      menuDropdown.style.display = "none";
      document.removeEventListener('click', closeMenuOutside);
    }
  }

  // Close menu when clicking outside
  function closeMenuOutside(event) {
    const menuContainer = document.getElementById("menuContainer");
    if (!menuContainer.contains(event.target)) {
      document.getElementById("menuDropdown").style.display = "none";
      document.removeEventListener('click', closeMenuOutside);
    }
  }
  
  // Export all data as a text file
  async function exportAllData() {
    // Save any current changes first
    saveCurrentChapter();
    
    // Get settings data from IndexedDB
    const settingsData = {};
    try {
      const keys = await getAllKeysFromIndexedDB('settings');
      for (const key of keys) {
        settingsData[key] = await getFromIndexedDB('settings', key);
      }
    } catch (error) {
      console.error('Error getting settings data:', error);
    }
    
    // Create a complete data object that includes everything
    let fullDataExport = {
      novels: novels,
      currentNovelIndex: currentNovelIndex,
      // Include additional data from IndexedDB
      additionalData: settingsData
    };
    
    // Convert to JSON string
    let jsonStr = JSON.stringify(fullDataExport, null, 2);
    
    // Create a blob and download
    const blob = new Blob([jsonStr], { type: 'text/plain' });
    const filename = 'promised-pen-backup.txt';
    downloadFile(blob, filename);
  }
  
  // Import data from a text file
  function importData() {
    // Trigger the file input
    importFile.click();
  }
  
  // Handle the import file selection
  async function handleImportFile(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = async function(e) {
      try {
        const importedData = JSON.parse(e.target.result);
        
        // Validate the imported data has the expected structure
        if (!importedData.novels || !Array.isArray(importedData.novels)) {
          throw new Error('Invalid data format: missing novels array');
        }
        
        // Prompt user to confirm import as it will replace all current data
        if (confirm('This will replace all your current novels and data. Continue?')) {
          // Import the data
          novels = importedData.novels;
          currentNovelIndex = importedData.currentNovelIndex || 0;
          
          // Import any additional IndexedDB data
          if (importedData.additionalData) {
            for (const key in importedData.additionalData) {
              await saveToIndexedDB('settings', key, importedData.additionalData[key]);
            }
          }
          
          // Update the UI
          updateNovelList();
          updateChapterList();
          updateCharacterList();
          updateLoreList();
          
          // Load the current chapter
          if (currentNovelIndex >= 0 && novels[currentNovelIndex].chapters.length > 0) {
            loadChapter(novels[currentNovelIndex].currentChapterIndex >= 0 ? 
                      novels[currentNovelIndex].currentChapterIndex : 0);
          }
          
          // Save to IndexedDB
          await saveToIndexedDB('novels', 'novelsData', novels);
          
          alert('Data imported successfully!');
        }
        
      } catch (error) {
        alert('Error importing data: ' + error.message);
      }
      // Reset the file input for next use
      importFile.value = '';
    };
    reader.readAsText(file);
  }

  // Helper function to download a file
  function downloadFile(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // Function to use AI for text generation/improvement
  async function useAI(directEditor = true, options = {}) {
    // If in summary mode, we handle it differently
    if (options.mode === 'summary') {
      // Create a prompt specifically for summarizing a chapter
      const chapterContent = options.chapterContent || '';
      const prompt = [{ role: 'assistant', content: `Please summarize the following chapter in a concise way, highlighting the key events, character developments, and important plot points. Keep the summary to 3-5 paragraphs. Only return the summary text without any explanations or comments. \n\nChapter content:\n${chapterContent}` }];
      
      try {
        const url = 'https://text.pollinations.ai/openai';
        const seedVar = Math.floor(Math.random() * 1000000);
        const payload = {
          model: 'openai-large',
          messages: prompt,
          seed: seedVar,
          private: true,
          max_output_tokens: 4096,
        };
        
        // Call the Pollinations API
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(payload),
        });
        
        if (!response.ok) {
          throw new Error(`API error: ${response.status}`);
        }
        
        // Parse the response
        const result = await response.json();
        
        // Extract the generated text
        let generatedText = '';
        
        if (result.choices && result.choices.length > 0) {
          if (result.choices[0].text) {
            generatedText = result.choices[0].text;
          } else if (result.choices[0].message && result.choices[0].message.content) {
            generatedText = result.choices[0].message.content;
          }
        } else if (result.content) {
          generatedText = result.content;
        } else if (typeof result === 'string') {
          generatedText = result;
        } else {
          console.log('Unable to extract text from response:', result);
          throw new Error('Unable to parse AI response');
        }
        
        return generatedText;
      } catch (error) {
        console.error('Error generating summary:', error);
        throw error;
      }
    }
    
    // Original useAI function for the editor
    if (directEditor) {
      // Check if text is selected
      let selection = window.getSelection();
      if (!selection.rangeCount) {
        alert("Please make a selection or place your cursor in the editor.");
        return;
      }
      
      let range = selection.getRangeAt(0);
      let selectedText = selection.toString();
      let isInEditor = editor.contains(range.commonAncestorContainer);
      
      if (!isInEditor) {
        alert("Please make a selection or place your cursor in the editor.");
        return;
      }
      
      // Disable the button and show loading state
      AIgen.disabled = true;
      AIgen.textContent = "⏳";
      
      try {
        // Get previous chapters and content before the selection
        let previousChapters = getPreviousChapters();
        let contentBeforeSelection = getContentBeforeCursor(range);
        
        // Get character and lore information
        let characterInfo = getCharacterInfo();
        let loreInfo = getLoreInfo();
        
        // Prepare the prompt based on whether text is selected or not
        let prompt = "";
        seedVar = Math.floor(Math.random() * 1000000);
        if (selectedText) {
          prompt = [{ role: `system`, content: `You are a writing assistant helping to improve a novel. Based on the story context, character information, and world lore provided, rewrite the selected text to improve it while maintaining the original style, tone and narrative flow.\n\n${characterInfo}\n${loreInfo}\n\nContext from previous chapters:\n${previousChapters}\n\nContent before the selection:\n${contentBeforeSelection}\n\nRewrite the selected text with better prose, more vivid descriptions, and better character consistency. Only return the improved text without any explanations or comments based on the following text:\n"${selectedText}"`, }];
        } else {
          prompt = [{ role: `system`, content: `You are a novel writing assistant. Creatively write 2-5 complete paragraphs that continue the novel in a way that's consistent with the established style, tone, and narrative using the context provided. Use proper sentence structure with clear subjects and verbs. Write complete sentences and form cohesive paragraphs. The paragraphs must focus on a single idea or moment. The paragraphs must be between three and six sentences. Ensure that the text allows for mature content, vulgar and profane language, and graphic violence if the context allows for it. Character information: ${characterInfo}. World Lore: ${loreInfo}. Context from previous chapters: ${previousChapters}. Content so far: ${contentBeforeSelection}.`, }];
        }
        const url = 'https://text.pollinations.ai/openai';
        const payload = {
            model: 'openai-large',
            messages: prompt,
            seed: seedVar, // Random seed
            private: true,
            max_output_tokens: 4096, // Adjust as needed
          };
        // Call the Pollinations API
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(payload),
        });
        console.log("Sending POST request to:", url, payload);
        if (!response.ok) {
          throw new Error(`API error: ${response.status}`);
        }
        
        // Parse the response
        const result = await response.json();
        
        // Extract the generated text
        let generatedText = '';
        
        if (result.choices && result.choices.length > 0) {
          if (result.choices[0].text) {
            generatedText = result.choices[0].text;
          } else if (result.choices[0].message && result.choices[0].message.content) {
            generatedText = result.choices[0].message.content;
          }
        } else if (result.content) {
          generatedText = result.content;
        } else if (typeof result === 'string') {
          generatedText = result;
        } else {
          console.log('Unable to extract text from response:', result);
          throw new Error('Unable to parse AI response');
        }
        
        // Replace selected text or insert at cursor
        if (selectedText) {
          document.execCommand('insertText', false, generatedText);
        } else {
          document.execCommand('insertText', false, generatedText);
        }
        
        // Save the current chapter
        autoSaveEdit();
      } catch (error) {
        console.error('Error generating text:', error);
        alert('An error occurred while generating text. Please try again.');
      } finally {
        // Re-enable the button
        AIgen.disabled = false;
        AIgen.textContent = "AI";
      }
    }
  }
  
  // Get content from previous chapters
  function getPreviousChapters() {
    if (currentNovelIndex < 0) return "";
    
    let novel = novels[currentNovelIndex];
    let currentChapterIndex = novel.currentChapterIndex;
    let previousChaptersContent = [];
    
    // Get content from up to 3 previous chapters to avoid too large prompts
    for (let i = Math.max(0, currentChapterIndex - 3); i < currentChapterIndex; i++) {
      if (novel.chapters[i]) {
        let textContent = novel.chapters[i].content.replace(/<[^>]*>/g, ' ');
        previousChaptersContent.push(`Chapter ${i+1}: ${textContent}`);
      }
    }
    
    return previousChaptersContent.join("\n\n");
  }
  
  // Get content before the cursor in the current chapter
  function getContentBeforeCursor(range) {
    // Clone the range
    let beforeRange = range.cloneRange();
    beforeRange.setStart(editor, 0);
    beforeRange.setEnd(range.startContainer, range.startOffset);
    
    // Get the text content of the range
    let beforeContent = beforeRange.toString();
    
    return beforeContent;
  }
  
  // Get character information formatted for the prompt
  function getCharacterInfo() {
    if (currentNovelIndex < 0 || !novels[currentNovelIndex].characters) return "";
    
    let characterInfoText = "## Character Information:\n\n";
    let novel = novels[currentNovelIndex];
    
    novel.characters.forEach(character => {
      characterInfoText += `### ${character.name} (${character.role}):\n`;
      
      if (character.appearance) {
        characterInfoText += `Appearance: ${character.appearance.height || ''} ${character.appearance.build || ''}, `;
        characterInfoText += `hair: ${character.appearance.hair || ''}, eyes: ${character.appearance.eyes || ''}, `;
        characterInfoText += `skin: ${character.appearance.skin || ''}\n`;
      }
      
      if (character.personality) {
        characterInfoText += `Personality: ${character.personality}\n`;
      }
      
      if (character.backstory) {
        characterInfoText += `Backstory: ${character.backstory}\n`;
      }
      
      if (character.motivation) {
        characterInfoText += `Motivation: ${character.motivation}\n`;
      }
      
      characterInfoText += "\n";
    });
    
    return characterInfoText;
  }
  
  // Get lore information formatted for the prompt
  function getLoreInfo() {
    if (currentNovelIndex < 0 || !novels[currentNovelIndex].lore) return "";
    
    let loreInfoText = "## World and Lore Information:\n\n";
    let novel = novels[currentNovelIndex];
    
    novel.lore.forEach(loreEntry => {
      let categoryDisplay = loreEntry.category;
      if (loreEntry.category === 'Custom' && loreEntry.customCategory) {
        categoryDisplay = loreEntry.customCategory;
      }
      
      loreInfoText += `### ${loreEntry.name} (${categoryDisplay}):\n`;
      loreInfoText += `${loreEntry.description}\n\n`;
    });
    
    return loreInfoText;
  }
  
  // Timer functions
  async function openTimerModal() {
    // Load saved timer minutes value from IndexedDB if it exists
    const savedMinutes = await getFromIndexedDB('settings', 'timerMinutes');
    if (savedMinutes) {
      timerMinutes.value = savedMinutes;
    }
    timerModal.style.display = 'flex';
  }

  function closeTimerModal() {
    timerModal.style.display = 'none';
  }

  async function startTimer() {
    // Get the minutes from the input
    let minutes = parseInt(timerMinutes.value);
    
    // Validate input
    if (isNaN(minutes) || minutes < 1) {
      alert('Please enter a valid number of minutes (minimum 1).');
      return;
    }
    
    // Save the minutes value to IndexedDB
    await saveToIndexedDB('settings', 'timerMinutes', minutes);
    
    // Calculate end time
    let now = new Date();
    timerEndTime = new Date(now.getTime() + minutes * 60000);
    
    // Update display
    updateTimerDisplay();
    
    // Set interval to update the display
    timerInterval = setInterval(updateTimerDisplay, 1000);
    
    // Show timer display
    timerDisplay.style.display = 'block';
    
    // Close the modal
    closeTimerModal();
  }

  function updateTimerDisplay() {
    if (!timerEndTime) return;
    
    // Calculate remaining time
    let now = new Date();
    let diff = timerEndTime - now;
    
    if (diff <= 0) {
      // Timer is done
      clearInterval(timerInterval);
      timerInterval = null;
      timerEndTime = null;
      timerDisplay.style.display = 'none';
      
      // Show alert
      alert('Writing sprint timer complete!');
      return;
    }
    
    // Calculate minutes and seconds
    let minutes = Math.floor(diff / 60000);
    let seconds = Math.floor((diff % 60000) / 1000);
    
    // Display time in MM:SS format
    timerRemainingDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  }

  function cancelTimer() {
    if (confirm('Are you sure you want to cancel the timer?')) {
      clearInterval(timerInterval);
      timerInterval = null;
      timerEndTime = null;
      timerDisplay.style.display = 'none';
    }
  }

  // Timeline functions
  // Open the timeline view
  async function openTimeline() {
    if (currentNovelIndex < 0) return;
    
    // Save current work if needed
    saveCurrentChapter();
    
    // Hide other containers
    novelListContainer.style.display = 'none';
    editorContainer.style.display = 'none';
    characterEditorContainer.style.display = 'none';
    loreEditorContainer.style.display = 'none';
    novelEditorContainer.style.display = 'none';
    
    // Initialize timeline if it's the first time
    initializeTimeline();
    
    // Show the timeline container
    timelineContainer.style.display = 'flex';
    
    // Default to the last saved view mode
    switchTimelineView(timelineSettings.viewMode || 'vertical');
    
    // Load timeline events from the current novel
    loadTimelineEvents();
  }

  // Close the timeline view
  function closeTimeline() {
    timelineContainer.style.display = 'none';
    editorContainer.style.display = 'flex';
  }

  // Initialize timeline for first use
  function initializeTimeline() {
    // Ensure the current novel has a timeline array
    if (!novels[currentNovelIndex].timeline) {
      novels[currentNovelIndex].timeline = [];
    }
    
    // Load saved timeline settings if they exist
    if (novels[currentNovelIndex].timelineSettings) {
      timelineSettings = novels[currentNovelIndex].timelineSettings;
    } else {
      // Save default settings
      novels[currentNovelIndex].timelineSettings = timelineSettings;
    }
  }

  // Switch between horizontal and vertical timeline views
  function switchTimelineView(mode) {
    timelineSettings.viewMode = mode;
    timelineViewMode.value = mode;
    
    if (mode === 'horizontal') {
      horizontalTimeline.style.display = 'block';
      verticalTimeline.style.display = 'none';
    } else {
      horizontalTimeline.style.display = 'none';
      verticalTimeline.style.display = 'block';
    }
    
    // Reload the events in the selected view
    loadTimelineEvents();
    
    // Save the setting
    novels[currentNovelIndex].timelineSettings = timelineSettings;
    saveToIndexedDB('novels', 'novelsData', novels);
  }

  // Load timeline events from the current novel
  function loadTimelineEvents() {
    // Clear existing events
    timelineEventsContainer.innerHTML = '';
    verticalTimelineEventsContainer.innerHTML = '';
    
    if (!novels[currentNovelIndex].timeline || novels[currentNovelIndex].timeline.length === 0) {
      // No events yet, show a placeholder
      timelineEventsContainer.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-light);">No events yet. Click "Add Event" to create your first timeline event.</div>';
      verticalTimelineEventsContainer.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-light);">No events yet. Click "Add Event" to create your first timeline event.</div>';
      return;
    }
    
    // Create a copy of events with original indices
    let events = novels[currentNovelIndex].timeline.map((event, index) => ({
      ...event,
      originalIndex: index
    }));
    
    // Sort events by date
    events.sort((a, b) => {
      // First by era priority
      const eraA = timelineSettings.eras.findIndex(era => era.name === a.era);
      const eraB = timelineSettings.eras.findIndex(era => era.name === b.era);
      if (eraA !== eraB) return eraA - eraB;
      
      // Then by year
      if (a.year !== b.year) return a.year - b.year;
      
      // Then by month
      if (a.month !== b.month) return a.month - b.month;
      
      // Then by day
      return a.day - b.day;
    });
    
    // Create a date-line with evenly spaced markers
    if (timelineSettings.viewMode === 'horizontal') {
      renderHorizontalTimeline(events);
    } else {
      renderVerticalTimeline(events);
    }
  }

  // Render horizontal timeline
  function renderHorizontalTimeline(events) {
    // Create markers for significant dates
    let timelineWidth = Math.max(events.length * 200, 1000) + 'px';
    horizontalTimeline.style.width = timelineWidth;
    
    // Clear previous events
    timelineEventsContainer.innerHTML = '';
    
    // Calculate positions for events
    const totalWidth = parseInt(timelineWidth);
    const startPadding = 50;
    const endPadding = 50;
    const usableWidth = totalWidth - startPadding - endPadding;
    const eventSpacing = usableWidth / (events.length > 1 ? events.length - 1 : 1);
    
    // Create events
    events.forEach((event, index) => {
      const position = events.length > 1 ? startPadding + (index * eventSpacing) : totalWidth / 2;
      
      // Create event marker
      const eventMarker = document.createElement('div');
      eventMarker.className = 'timeline-event';
      eventMarker.style.cssText = `
        position:absolute;
        left:${position}px;
        top:0;
        transform:translateX(-50%);
        display:flex;
        flex-direction:column;
        align-items:center;
      `;
      
      // Marker dot
      const dot = document.createElement('div');
      dot.style.cssText = `
        width:12px;
        height:12px;
        border-radius:50%;
        background-color:${event.color || 'var(--primary)'};
        margin-bottom:5px;
        transform:translateY(15px);
        cursor:pointer;
        border:2px solid var(--background);
      `;
      dot.onclick = () => editTimelineEvent(event.originalIndex); // Use original index
      eventMarker.appendChild(dot);
      
      // Date label
      const dateLabel = document.createElement('div');
      dateLabel.style.cssText = `
        font-size:12px;
        color:var(--text-light);
        white-space:nowrap;
        transform:translateY(-20px);
      `;
      let dateText = `${event.year} ${timelineSettings.eras.find(era => era.name === event.era)?.abbreviation || event.era}`;
      if (event.month) {
        dateText = `${timelineSettings.months[event.month - 1]} ${event.day || ''}, ${dateText}`;
      }
      dateLabel.textContent = dateText;
      eventMarker.appendChild(dateLabel);
      
      // Event title (below the line)
      const titleElement = document.createElement('div');
      titleElement.style.cssText = `
        font-size:14px;
        font-weight:bold;
        margin-top:15px;
        margin-bottom:5px;
        color:var(--text);
        cursor:pointer;
        max-width:150px;
        text-align:center;
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;
      `;
      titleElement.title = event.title;
      titleElement.textContent = event.title;
      titleElement.onclick = () => editTimelineEvent(event.originalIndex); // Use original index
      eventMarker.appendChild(titleElement);
      
      timelineEventsContainer.appendChild(eventMarker);
    });
  }

  // Render vertical timeline
  function renderVerticalTimeline(events) {
    // Create markers for significant dates
    let timelineHeight = Math.max(events.length * 150, 500) + 'px';
    verticalTimeline.style.height = timelineHeight;
    
    // Clear previous events
    verticalTimelineEventsContainer.innerHTML = '';
    
    // Calculate positions for events
    const totalHeight = parseInt(timelineHeight);
    const startPadding = 50;
    const endPadding = 50;
    const usableHeight = totalHeight - startPadding - endPadding;
    const eventSpacing = usableHeight / (events.length > 1 ? events.length - 1 : 1);
    
    // Create events
    events.forEach((event, index) => {
      const position = events.length > 1 ? startPadding + (index * eventSpacing) : totalHeight / 2;
      const isEven = index % 2 === 0;
      
      // Create event marker
      const eventMarker = document.createElement('div');
      eventMarker.className = 'timeline-event';
      eventMarker.style.cssText = `
        position:absolute;
        top:${position}px;
        ${isEven ? 'left:calc(50% + 20px)' : 'right:calc(50% + 20px)'};
        transform:translateY(-50%);
        display:flex;
        ${isEven ? 'flex-direction:row' : 'flex-direction:row-reverse'};
        align-items:center;
        max-width:40%;
      `;
      
      // Connector line
      const connector = document.createElement('div');
      connector.style.cssText = `
        height:2px;
        width:20px;
        background-color:${event.color || 'var(--primary)'};
        ${isEven ? 'margin-right:10px' : 'margin-left:10px'};
      `;
      eventMarker.appendChild(connector);
      
      // Marker dot (at the center axis)
      const dot = document.createElement('div');
      dot.style.cssText = `
        position:absolute;
        ${isEven ? 'left:-26px' : 'right:-26px'};
        top:50%;
        transform:translateY(-50%);
        width:12px;
        height:12px;
        border-radius:50%;
        background-color:${event.color || 'var(--primary)'};
        cursor:pointer;
        border:2px solid var(--background);
      `;
      dot.onclick = () => editTimelineEvent(event.originalIndex); // Use original index
      eventMarker.appendChild(dot);
      
      // Content container
      const content = document.createElement('div');
      content.style.cssText = `
        background:var(--background);
        border:1px solid var(--border);
        border-radius:4px;
        padding:10px;
        box-shadow:0 2px 5px var(--shadow);
        cursor:pointer;
      `;
      content.onclick = () => editTimelineEvent(event.originalIndex); // Use original index
      eventMarker.appendChild(content);
      
      // Date label
      const dateLabel = document.createElement('div');
      dateLabel.style.cssText = `
        font-size:12px;
        color:var(--text-light);
        margin-bottom:5px;
      `;
      let dateText = `${event.year} ${timelineSettings.eras.find(era => era.name === event.era)?.abbreviation || event.era}`;
      if (event.month) {
        dateText = `${timelineSettings.months[event.month - 1]} ${event.day || ''}, ${dateText}`;
      }
      dateLabel.textContent = dateText;
      content.appendChild(dateLabel);
      
      // Event title
      const titleElement = document.createElement('div');
      titleElement.style.cssText = `
        font-size:14px;
        font-weight:bold;
        margin-bottom:5px;
        color:var(--text);
      `;
      titleElement.textContent = event.title;
      content.appendChild(titleElement);
      
      // Event description (if not too long)
      if (event.description) {
        const descElement = document.createElement('div');
        descElement.style.cssText = `
          font-size:12px;
          color:var(--text);
          display:-webkit-box;
          -webkit-line-clamp:3;
          -webkit-box-orient:vertical;
          overflow:hidden;
          text-overflow:ellipsis;
        `;
        descElement.textContent = event.description;
        content.appendChild(descElement);
      }
      
      verticalTimelineEventsContainer.appendChild(eventMarker);
    });
  }

  // Add a new timeline event
  function addTimelineEvent() {
    // Reset the form
    timelineEventForm.reset();
    eventColor.value = '#4285f4';
    currentTimelineEventIndex = -1;
    
    // Hide delete button for new events
    deleteTimelineEventBtn.style.display = 'none';
    
    // Populate era dropdown
    populateEraDropdown();
    
    // Populate month dropdown
    populateMonthDropdown();
    
    // Update modal title
    timelineEventModalTitle.textContent = 'Add Timeline Event';
    
    // Show the modal
    timelineEventModal.style.display = 'flex';
  }

  // Edit an existing timeline event
  function editTimelineEvent(index) {
    if (currentNovelIndex < 0 || !novels[currentNovelIndex].timeline) return;
    
    currentTimelineEventIndex = index;
    const event = novels[currentNovelIndex].timeline[index];
    
    // Populate the form with event data
    eventTitle.value = event.title || '';
    
    // Populate era dropdown and select the right option
    populateEraDropdown();
    eventEra.value = event.era || 'Current Era';
    
    // Populate month dropdown and select the right option
    populateMonthDropdown();
    eventMonth.value = event.month || '';
    
    eventYear.value = event.year || '';
    eventDay.value = event.day || '';
    eventDescription.value = event.description || '';
    eventColor.value = event.color || '#4285f4';
    
    // Show delete button for existing events
    deleteTimelineEventBtn.style.display = 'block';
    
    // Update modal title
    timelineEventModalTitle.textContent = 'Edit Timeline Event';
    
    // Show the modal
    timelineEventModal.style.display = 'flex';
  }

  // Save a timeline event
  async function saveTimelineEvent(event) {
    event.preventDefault();
    
    if (currentNovelIndex < 0) return;
    
    // Ensure timeline array exists
    if (!novels[currentNovelIndex].timeline) {
      novels[currentNovelIndex].timeline = [];
    }
    
    // Get event data from form
    const timelineEvent = {
      title: eventTitle.value,
      era: eventEra.value,
      year: parseInt(eventYear.value),
      month: eventMonth.value ? parseInt(eventMonth.value) : null,
      day: eventDay.value ? parseInt(eventDay.value) : null,
      description: eventDescription.value,
      color: eventColor.value
    };
    
    if (currentTimelineEventIndex === -1) {
      // Add new event
      novels[currentNovelIndex].timeline.push(timelineEvent);
    } else {
      // Update existing event
      novels[currentNovelIndex].timeline[currentTimelineEventIndex] = timelineEvent;
    }
    
    // Save to IndexedDB
    await saveToIndexedDB('novels', 'novelsData', novels);
    
    // Reload timeline events
    loadTimelineEvents();
    
    // Close the modal
    closeTimelineEventModal();
  }

  // Delete a timeline event
  async function deleteTimelineEvent() {
    if (currentNovelIndex < 0 || currentTimelineEventIndex < 0) return;
    
    if (confirm('Are you sure you want to delete this timeline event?')) {
      // Remove the event
      novels[currentNovelIndex].timeline.splice(currentTimelineEventIndex, 1);
      
      // Save to IndexedDB
      await saveToIndexedDB('novels', 'novelsData', novels);
      
      // Reload timeline events
      loadTimelineEvents();
      
      // Close the modal
      closeTimelineEventModal();
    }
  }

  // Close the timeline event modal
  function closeTimelineEventModal() {
    timelineEventModal.style.display = 'none';
  }

  // Open timeline settings modal
  function openTimelineSettings() {
    // Load current settings
    populateTimelineSettingsForm();
    
    // Show the modal
    timelineSettingsModal.style.display = 'flex';
  }

  // Populate the timeline settings form with current settings
  function populateTimelineSettingsForm() {
    // Populate eras section
    populateErasSection();
    
    // Set number of months
    numMonths.value = timelineSettings.months.length;
    
    // Populate months inputs
    updateMonthsInputs();
    
    // Set number of days in week
    numDaysInWeek.value = timelineSettings.daysInWeek.length;
    
    // Populate days inputs
    updateDaysInputs();
    
    // Populate month lengths
    updateMonthLengthsInputs();
  }

  // Populate the eras section
  function populateErasSection() {
    erasContainer.innerHTML = '';
    
    timelineSettings.eras.forEach((era, index) => {
      const eraRow = document.createElement('div');
      eraRow.style.cssText = 'display:flex; gap:10px; margin-bottom:10px; align-items:center;';
      
      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.value = era.name;
      nameInput.placeholder = 'Era Name';
      nameInput.required = true;
      nameInput.style.cssText = 'flex:2; padding:8px; background:var(--input-bg); color:var(--text); border:1px solid var(--input-border); border-radius:4px;';
      nameInput.dataset.index = index;
      nameInput.dataset.field = 'name';
      nameInput.onchange = updateEraField;
      eraRow.appendChild(nameInput);
      
      const abbrInput = document.createElement('input');
      abbrInput.type = 'text';
      abbrInput.value = era.abbreviation;
      abbrInput.placeholder = 'Abbr.';
      abbrInput.required = true;
      abbrInput.style.cssText = 'flex:1; padding:8px; background:var(--input-bg); color:var(--text); border:1px solid var(--input-border); border-radius:4px;';
      abbrInput.dataset.index = index;
      abbrInput.dataset.field = 'abbreviation';
      abbrInput.onchange = updateEraField;
      eraRow.appendChild(abbrInput);
      
      if (index > 0) {
        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.innerHTML = '&times;';
        deleteBtn.style.cssText = 'padding:8px 12px; background:var(--danger); color:white; border:none; border-radius:4px;';
        deleteBtn.onclick = () => removeEra(index);
        eraRow.appendChild(deleteBtn);
      }
      
      erasContainer.appendChild(eraRow);
    });
  }

  // Add a new era
  function addEra() {
    timelineSettings.eras.push({ name: 'New Era', abbreviation: 'NE' });
    populateErasSection();
  }

  // Remove an era
  function removeEra(index) {
    if (confirm('Are you sure you want to remove this era? This may affect existing timeline events.')) {
      timelineSettings.eras.splice(index, 1);
      populateErasSection();
    }
  }

  // Update era field value
  function updateEraField() {
    const index = parseInt(this.dataset.index);
    const field = this.dataset.field;
    timelineSettings.eras[index][field] = this.value;
  }

  // Update months inputs based on the number of months
  function updateMonthsInputs() {
    const count = parseInt(numMonths.value) || 12;
    
    // Ensure we have the right number of month names
    while (timelineSettings.months.length > count) {
      timelineSettings.months.pop();
    }
    
    while (timelineSettings.months.length < count) {
      timelineSettings.months.push(`Month ${timelineSettings.months.length + 1}`);
    }
    
    // Ensure we have the right number of days per month
    while (timelineSettings.daysPerMonth.length > count) {
      timelineSettings.daysPerMonth.pop();
    }
    
    while (timelineSettings.daysPerMonth.length < count) {
      timelineSettings.daysPerMonth.push(30);
    }
    
    // Create input fields for each month
    monthsContainer.innerHTML = '';
    
    timelineSettings.months.forEach((month, index) => {
      const monthRow = document.createElement('div');
      monthRow.style.cssText = 'display:flex; gap:10px; margin-bottom:5px; align-items:center;';
      
      const monthLabel = document.createElement('div');
      monthLabel.textContent = `Month ${index + 1}:`;
      monthLabel.style.cssText = 'width:80px; color:var(--text);';
      monthRow.appendChild(monthLabel);
      
      const monthInput = document.createElement('input');
      monthInput.type = 'text';
      monthInput.value = month;
      monthInput.style.cssText = 'flex:1; padding:8px; background:var(--input-bg); color:var(--text); border:1px solid var(--input-border); border-radius:4px;';
      monthInput.dataset.index = index;
      monthInput.onchange = function() {
        timelineSettings.months[parseInt(this.dataset.index)] = this.value;
      };
      monthRow.appendChild(monthInput);
      
      monthsContainer.appendChild(monthRow);
    });
    
    // Also update month lengths
    updateMonthLengthsInputs();
  }

  // Update days inputs based on the number of days in a week
  function updateDaysInputs() {
    const count = parseInt(numDaysInWeek.value) || 7;
    
    // Ensure we have the right number of day names
    while (timelineSettings.daysInWeek.length > count) {
      timelineSettings.daysInWeek.pop();
    }
    
    while (timelineSettings.daysInWeek.length < count) {
      timelineSettings.daysInWeek.push(`Day ${timelineSettings.daysInWeek.length + 1}`);
    }
    
    // Create input fields for each day
    daysContainer.innerHTML = '';
    
    timelineSettings.daysInWeek.forEach((day, index) => {
      const dayRow = document.createElement('div');
      dayRow.style.cssText = 'display:flex; gap:10px; margin-bottom:5px; align-items:center;';
      
      const dayLabel = document.createElement('div');
      dayLabel.textContent = `Day ${index + 1}:`;
      dayLabel.style.cssText = 'width:80px; color:var(--text);';
      dayRow.appendChild(dayLabel);
      
      const dayInput = document.createElement('input');
      dayInput.type = 'text';
      dayInput.value = day;
      dayInput.style.cssText = 'flex:1; padding:8px; background:var(--input-bg); color:var(--text); border:1px solid var(--input-border); border-radius:4px;';
      dayInput.dataset.index = index;
      dayInput.onchange = function() {
        timelineSettings.daysInWeek[parseInt(this.dataset.index)] = this.value;
      };
      dayRow.appendChild(dayInput);
      
      daysContainer.appendChild(dayRow);
    });
  }

  // Update month lengths inputs
  function updateMonthLengthsInputs() {
    monthLengthsContainer.innerHTML = '';
    
    timelineSettings.months.forEach((month, index) => {
      const lengthRow = document.createElement('div');
      lengthRow.style.cssText = 'display:flex; gap:10px; margin-bottom:5px; align-items:center;';
      
      const monthName = document.createElement('div');
      monthName.textContent = month + ':';
      monthName.style.cssText = 'flex:1; color:var(--text);';
      lengthRow.appendChild(monthName);
      
      const lengthInput = document.createElement('input');
      lengthInput.type = 'number';
      lengthInput.min = '1';
      lengthInput.max = '100';
      lengthInput.value = timelineSettings.daysPerMonth[index];
      lengthInput.style.cssText = 'width:80px; padding:8px; background:var(--input-bg); color:var(--text); border:1px solid var(--input-border); border-radius:4px;';
      lengthInput.dataset.index = index;
      lengthInput.onchange = function() {
        timelineSettings.daysPerMonth[parseInt(this.dataset.index)] = parseInt(this.value);
      };
      lengthRow.appendChild(lengthInput);
      
      lengthRow.appendChild(document.createTextNode(' days'));
      
      monthLengthsContainer.appendChild(lengthRow);
    });
  }

  // Save timeline settings
  async function saveTimelineSettings(event) {
    event.preventDefault();
    
    if (currentNovelIndex < 0) return;
    
    // Save settings to the current novel
    novels[currentNovelIndex].timelineSettings = timelineSettings;
    
    // Save to IndexedDB
    await saveToIndexedDB('novels', 'novelsData', novels);
    
    // Update any dropdowns that depend on these settings
    populateEraDropdown();
    populateMonthDropdown();
    
    // Reload timeline events to reflect new settings
    loadTimelineEvents();
    
    // Close the modal
    closeTimelineSettings();
  }

  // Close the timeline settings modal
  function closeTimelineSettings() {
    timelineSettingsModal.style.display = 'none';
  }

  // Populate the era dropdown in the event form
  function populateEraDropdown() {
    eventEra.innerHTML = '';
    
    timelineSettings.eras.forEach(era => {
      const option = document.createElement('option');
      option.value = era.name;
      option.textContent = `${era.name} (${era.abbreviation})`;
      eventEra.appendChild(option);
    });
  }

  // Populate the month dropdown in the event form
  function populateMonthDropdown() {
    eventMonth.innerHTML = '';
    
    // Add empty option
    const emptyOption = document.createElement('option');
    emptyOption.value = '';
    emptyOption.textContent = '-- No Month --';
    eventMonth.appendChild(emptyOption);
    
    timelineSettings.months.forEach((month, index) => {
      const option = document.createElement('option');
      option.value = index + 1;
      option.textContent = month;
      eventMonth.appendChild(option);
    });
    
    // Update days limits based on selected month
    eventMonth.onchange = updateDaysLimit;
  }

  // Update the maximum allowed days based on selected month
  function updateDaysLimit() {
    const monthIndex = parseInt(eventMonth.value) - 1;
    
    if (monthIndex >= 0 && monthIndex < timelineSettings.daysPerMonth.length) {
      eventDay.max = timelineSettings.daysPerMonth[monthIndex];
    } else {
      eventDay.max = 31; // Default
    }
    
    // Ensure the current value doesn't exceed the max
    if (parseInt(eventDay.value) > parseInt(eventDay.max)) {
      eventDay.value = eventDay.max;
    }
  }
  
  // Function to export current chapter as a Word document
  function exportAsWord() {
    // First check if there's a current chapter to export
    if (currentNovelIndex < 0 || novels[currentNovelIndex].currentChapterIndex < 0) {
      alert('Please select a chapter to export.');
      return;
    }
    
    // Save the current chapter before exporting
    saveCurrentChapter();
    
    // Get the chapter data
    const novel = novels[currentNovelIndex];
    const chapter = novel.chapters[novel.currentChapterIndex];
    
    // Get the export button for updating its state
    const exportBtn = document.querySelector('#toggleExportBtn');
    const originalText = exportBtn.textContent;
    exportBtn.disabled = true;
    exportBtn.textContent = "Preparing...";
    
    try {
      // Use a simple approach - converting HTML to a file that Word can open
      // This is a bit of a hack, but works on modern Word/Office versions
      
      // Basic stylesheet for the Word document
      const style = `
        <style>
          body { font-family: Calibri, Arial, sans-serif; margin: 2cm; }
          h1 { font-size: 24pt; color: #333; }
          p { font-size: 11pt; line-height: 1.5; }
        </style>
      `;
      
      // Create the HTML content
      const htmlContent = `
        <html xmlns:o="urn:schemas-microsoft-com:office:office" 
              xmlns:w="urn:schemas-microsoft-com:office:word" 
              xmlns="http://www.w3.org/TR/REC-html40">
        <head>
          <meta charset="utf-8">
          <title>${chapter.title}</title>
          ${style}
        </head>
        <body>
          <h1>${chapter.title}</h1>
          ${chapter.content}
        </body>
        </html>
      `;
      
      // Convert the HTML content to a Blob
      const blob = new Blob(['\ufeff', htmlContent], {
        type: 'application/msword'
      });
      
      // Create a URL for the Blob
      const url = URL.createObjectURL(blob);
      
      // Create a link element to download the file
      const link = document.createElement('a');
      link.href = url;
      link.download = `${chapter.title.replace(/[/\\?%*:|"<>]/g, '-')}.doc`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      // Clean up
      URL.revokeObjectURL(url);
      
      // Close the export menu
      document.getElementById('exportMenuItems').style.display = 'none';
      
    } catch (error) {
      console.error('Error exporting to Word:', error);
      alert('There was an error exporting to Word. Please try again later.');
    } finally {
      // Restore button state
      exportBtn.disabled = false;
      exportBtn.textContent = originalText;
    }
  }
  
  // Function to export current chapter as a PDF
  function exportAsPdf() {
    // First check if there's a current chapter to export
    if (currentNovelIndex < 0 || novels[currentNovelIndex].currentChapterIndex < 0) {
      alert('Please select a chapter to export.');
      return;
    }
    
    // Save the current chapter before exporting
    saveCurrentChapter();
    
    // Get the chapter data
    const novel = novels[currentNovelIndex];
    const chapter = novel.chapters[novel.currentChapterIndex];
    
    // Get the export button for updating its state
    const exportBtn = document.querySelector('#toggleExportBtn');
    const originalText = exportBtn.textContent;
    exportBtn.disabled = true;
    exportBtn.textContent = "Preparing...";
    
    try {
      // Basic stylesheet for the PDF document
      const style = `
        <style>
          body { font-family: 'Times New Roman', Times, serif; margin: 3cm; line-height: 1.5; }
          h1 { font-size: 24pt; color: #333; text-align: center; margin-bottom: 2cm; }
          p { font-size: 12pt; margin-bottom: 0.5cm; text-align: justify; }
        </style>
      `;
      
      // Create the HTML content
      const htmlContent = `
        <html>
        <head>
          <meta charset="utf-8">
          <title>${chapter.title}</title>
          ${style}
        </head>
        <body>
          <h1>${chapter.title}</h1>
          ${chapter.content}
        </body>
        </html>
      `;
      
      // Open a new window to print to PDF
      const printWindow = window.open('', '_blank');
      printWindow.document.write(htmlContent);
      printWindow.document.close();
      
      // Add a short delay to ensure content is loaded before printing
      setTimeout(() => {
        printWindow.print();
        // Close the window after print dialog is closed (this may not work in all browsers)
        printWindow.onafterprint = function() {
          printWindow.close();
        };
      }, 500);
      
      // Close the export menu
      document.getElementById('exportMenuItems').style.display = 'none';
      
    } catch (error) {
      console.error('Error exporting to PDF:', error);
      alert('There was an error exporting to PDF. Please try again later.');
    } finally {
      // Restore button state
      exportBtn.disabled = false;
      exportBtn.textContent = originalText;
    }
  }

  // Function to export current chapter as a text file
  function exportAsTxt() {
    // First check if there's a current chapter to export
    if (currentNovelIndex < 0 || novels[currentNovelIndex].currentChapterIndex < 0) {
      alert('Please select a chapter to export.');
      return;
    }
    
    // Save the current chapter before exporting
    saveCurrentChapter();
    
    // Get the chapter data
    const novel = novels[currentNovelIndex];
    const chapter = novel.chapters[novel.currentChapterIndex];
    
    // Get the export button for updating its state
    const exportBtn = document.querySelector('#toggleExportBtn');
    const originalText = exportBtn.textContent;
    exportBtn.disabled = true;
    exportBtn.textContent = "Preparing...";
    
    try {
      // Extract text content from HTML
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = chapter.content;
      const textContent = tempDiv.textContent || tempDiv.innerText;
      
      // Create the text content
      const txt = `${chapter.title}\n\n${textContent}`;
      
      // Convert the text content to a Blob
      const blob = new Blob([txt], { type: 'text/plain' });
      
      // Create a URL for the Blob
      const url = URL.createObjectURL(blob);
      
      // Create a link element to download the file
      const link = document.createElement('a');
      link.href = url;
      link.download = `${chapter.title.replace(/[/\\?%*:|"<>]/g, '-')}.txt`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      // Clean up
      URL.revokeObjectURL(url);
      
      // Close the export menu
      document.getElementById('exportMenuItems').style.display = 'none';
      
    } catch (error) {
      console.error('Error exporting to text:', error);
      alert('There was an error exporting to text. Please try again later.');
    } finally {
      // Restore button state
      exportBtn.disabled = false;
      exportBtn.textContent = originalText;
    }
  }

  // Toggle the export menu
  function toggleExportMenu() {
    const menuItems = document.getElementById('exportMenuItems');
    menuItems.style.display = menuItems.style.display === 'none' ? 'block' : 'none';
    
    // Add a click event listener to close the menu when clicking outside
    if (menuItems.style.display === 'block') {
      setTimeout(() => {
        document.addEventListener('click', closeExportMenuOutside);
      }, 0);
    } else {
      document.removeEventListener('click', closeExportMenuOutside);
    }
  }

  // Close the export menu when clicking outside
  function closeExportMenuOutside(event) {
    const menuItems = document.getElementById('exportMenuItems');
    const exportBtn = event.target.closest('#toggleExportBtn');
    
    if (!exportBtn && !menuItems.contains(event.target)) {
      menuItems.style.display = 'none';
      document.removeEventListener('click', closeExportMenuOutside);
    }
  }
  
  // Handle window resize
  window.addEventListener('resize', updateMobileUI);
  
  // Close modals when clicking outside
  window.addEventListener('click', function(e) {
    if (e.target === imageModal) {
      closeImageModal();
    }
    if (e.target === specialCharModal) {
      closeSpecialCharModal();
    }
    if (e.target === characterImagePreviewModal) {
      closeImagePreviewModal();
    }
    if (e.target === loreImagePreviewModal) {
      closeLoreImagePreviewModal();
    }
    if (e.target === summaryModal) {
      closeSummaryModal();
    }
    if (e.target === textColorModal) {
      closeTextColorModal();
    }
    if (e.target === bgColorModal) {
      closeBgColorModal();
    }
    if (e.target === timerModal) {
      closeTimerModal();
    }
    if (e.target === timelineEventModal) {
      closeTimelineEventModal();
    }
    if (e.target === timelineSettingsModal) {
      closeTimelineSettings();
    }
  });
  
  // Initialize on load
  window.onload = init;
</script>
